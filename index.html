<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>CAYNANA â€“ Almadan Ã–nce Sor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Plus Jakarta Sans"', 'sans-serif'],
          },
          colors: {
            brand: {
              50: '#ecfdf5',
              100: '#d1fae5',
              500: '#10b981',
              600: '#059669',
              700: '#047857',
              900: '#064e3b',
            }
          },
          animation: {
            'blob': 'blob 7s infinite',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'wiggle': 'wiggle 1s ease-in-out infinite',
          },
          keyframes: {
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
              '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            wiggle: {
              '0%, 100%': { transform: 'translateX(0)' },
              '50%': { transform: 'translateX(10px)' }
            }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }

    /* Ã–zel Scrollbar Gizleme */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Glassmorphism Efekti */
    .glass {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Nefes Alan AI Efekti */
    .ai-core {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #34d399, #059669);
      box-shadow: 0 0 30px rgba(16, 185, 129, 0.4);
      position: relative;
    }
    .ai-core::after {
      content: '';
      position: absolute;
      top: -10px; left: -10px; right: -10px; bottom: -10px;
      border-radius: 50%;
      border: 2px solid rgba(16, 185, 129, 0.2);
      animation: pulse 2s infinite;
    }

    /* Tailwind'de olmayan animation-delay sÄ±nÄ±flarÄ± */
    .animation-delay-2000 { animation-delay: 2s; }
    .animation-delay-4000 { animation-delay: 4s; }
  </style>
</head>

<body class="text-slate-800 antialiased min-h-screen flex flex-col relative overflow-hidden">

<div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
  <div class="absolute top-0 left-1/4 w-72 h-72 bg-emerald-100 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob"></div>
  <div class="absolute top-0 right-1/4 w-72 h-72 bg-blue-50 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000"></div>
  <div class="absolute -bottom-32 left-1/3 w-72 h-72 bg-pink-50 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-4000"></div>
</div>

<header class="fixed top-0 w-full z-50 glass border-b border-slate-100/50">
  <div class="max-w-lg mx-auto px-5 h-16 flex items-center justify-between">
    <a href="#" onclick="showScene('scene-home')" class="flex items-center gap-2 group">
      <div class="w-8 h-8 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-emerald-500/20 transition-transform group-hover:scale-105">
        <i class="fa-solid fa-bolt text-sm"></i>
      </div>
      <span class="text-xl font-extrabold tracking-tight text-slate-900">CAYNANA</span>
    </a>

    <button onclick="toggleMenu()" class="w-10 h-10 flex items-center justify-center text-slate-600 hover:text-emerald-600 transition" aria-label="MenÃ¼">
      <i class="fa-solid fa-bars text-xl"></i>
    </button>
  </div>
</header>

<div id="menuOverlay" class="fixed inset-0 z-[60] bg-white/95 backdrop-blur-xl transform translate-x-full transition-transform duration-300 flex flex-col">
  <div class="flex justify-end p-5">
    <button onclick="toggleMenu()" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center" aria-label="MenÃ¼yÃ¼ kapat">
      <i class="fa-solid fa-xmark text-xl"></i>
    </button>
  </div>
  <nav class="flex-1 flex flex-col items-center justify-center gap-6 text-xl font-bold text-slate-800">
    <a href="#" onclick="menuNav('scene-home')" class="hover:text-emerald-600 transition">Ana Sayfa</a>
    <a href="#" onclick="menuNav('scene-about')" class="hover:text-emerald-600 transition">Biz Kimiz?</a>
    <a href="#" onclick="menuNav('scene-how')" class="hover:text-emerald-600 transition">NasÄ±l Ã‡alÄ±ÅŸÄ±r?</a>
    <a href="#" onclick="menuNav('scene-faq')" class="hover:text-emerald-600 transition">S.S.S.</a>
    <a href="#" onclick="menuNav('scene-contact')" class="hover:text-emerald-600 transition">Ä°letiÅŸim</a>
  </nav>
  <div class="p-8 text-center text-xs text-slate-400 border-t border-slate-100">
    <a href="#" onclick="menuNav('scene-privacy')" class="underline mr-4">Gizlilik PolitikasÄ±</a>
    <span>&copy; 2026 Ä°talky Teknoloji A.Å.</span>
  </div>
</div>

<main class="flex-1 w-full max-w-lg mx-auto pt-24 pb-12 px-5 flex flex-col relative z-10">

  <section id="scene-home" class="flex flex-col items-center justify-center min-h-[60vh] fade-in">
    <div class="mb-8 relative">
      <div class="ai-core flex items-center justify-center text-white text-3xl">
        <i class="fa-solid fa-eye"></i>
      </div>
      <div class="absolute -right-4 -top-2 bg-white px-2 py-1 rounded-full shadow-sm border border-slate-100">
        <span class="text-[10px] font-bold text-emerald-600 uppercase tracking-wider">Beta</span>
      </div>
    </div>

    <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-900 text-center leading-tight mb-3">
      KararsÄ±z kalma,<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 to-teal-500">Caynana'ya danÄ±ÅŸ.</span>
    </h1>

    <p class="text-slate-500 text-center mb-8 max-w-xs leading-relaxed">
      Sadece fiyatÄ± deÄŸil, performansÄ±, kronik sorunlarÄ± ve gerÃ§ek kullanÄ±cÄ± deneyimini analiz ederim.
    </p>

    <div class="w-full relative group">
      <div class="absolute -inset-0.5 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl blur opacity-30 group-focus-within:opacity-100 transition duration-500"></div>
      <div class="relative bg-white rounded-2xl flex items-center p-2 shadow-sm">
        <div class="pl-3 text-slate-400">
          <i class="fa-solid fa-magnifying-glass"></i>
        </div>
        <input
          id="q"
          type="text"
          placeholder="ÃœrÃ¼n adÄ± veya link yapÄ±ÅŸtÄ±r..."
          class="flex-1 bg-transparent border-none focus:ring-0 text-slate-800 placeholder-slate-400 px-3 py-3 text-base outline-none w-full"
          autocomplete="off"
        >
        <button id="btnAsk" onclick="startJourney()"
          class="bg-slate-900 hover:bg-emerald-600 text-white rounded-xl px-5 py-3 font-bold transition-all shadow-md active:scale-95 flex items-center gap-2">
          <span>Sor</span>
          <i class="fa-solid fa-arrow-right"></i>
        </button>
      </div>
    </div>

    <div class="mt-6 flex flex-wrap justify-center gap-2">
      <button onclick="fillQ('iPhone 15 alÄ±nÄ±r mÄ±?')" class="text-xs bg-white border border-slate-200 px-3 py-1.5 rounded-full text-slate-600 hover:border-emerald-500 hover:text-emerald-600 transition">ğŸ“± iPhone 15</button>
      <button onclick="fillQ('Dyson sÃ¼pÃ¼rge fiyatÄ±na deÄŸer mi?')" class="text-xs bg-white border border-slate-200 px-3 py-1.5 rounded-full text-slate-600 hover:border-emerald-500 hover:text-emerald-600 transition">ğŸ§¹ Dyson V15</button>
      <button onclick="fillQ('Hangi airfryer daha iyi?')" class="text-xs bg-white border border-slate-200 px-3 py-1.5 rounded-full text-slate-600 hover:border-emerald-500 hover:text-emerald-600 transition">ğŸŸ Airfryer</button>
    </div>
  </section>

  <section id="scene-loading" class="hidden flex flex-col items-center justify-center min-h-[50vh] text-center">
    <div class="w-16 h-16 border-4 border-emerald-100 border-t-emerald-600 rounded-full animate-spin mb-6"></div>
    <h3 class="text-lg font-bold text-slate-900 mb-2">Analiz Ediliyor...</h3>
    <p id="loadingStep" class="text-sm text-slate-500 font-medium">Veriler taranÄ±yor</p>

    <div class="mt-8 w-full max-w-xs bg-slate-100 rounded-full h-1.5 overflow-hidden">
      <div class="bg-emerald-500 h-full rounded-full animate-wiggle" style="width: 50%"></div>
    </div>
  </section>

  <section id="scene-results" class="hidden pb-10">

    <!-- ERROR CARD (prod) -->
    <div id="errorCard" class="hidden bg-red-50 border border-red-200 rounded-2xl p-4 mb-6">
      <div class="flex items-start gap-3">
        <div class="w-9 h-9 rounded-full bg-red-100 flex items-center justify-center text-red-600 flex-shrink-0">
          <i class="fa-solid fa-triangle-exclamation"></i>
        </div>
        <div>
          <div class="font-bold text-slate-900 mb-1">Bir sorun oldu</div>
          <p id="errorText" class="text-sm text-slate-700 leading-relaxed"></p>
          <button onclick="showScene('scene-home')" class="mt-3 text-sm font-bold text-red-700 hover:text-red-800">
            â† Geri dÃ¶n
          </button>
        </div>
      </div>
    </div>

    <div class="bg-gradient-to-br from-emerald-50 to-white border border-emerald-100 rounded-2xl p-5 mb-6 relative overflow-hidden shadow-sm">
      <div class="absolute top-0 right-0 p-3 opacity-10 text-emerald-900 text-6xl">
        <i class="fa-solid fa-quote-right"></i>
      </div>
      <div class="flex items-start gap-4 relative z-10">
        <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 flex-shrink-0">
          <i class="fa-solid fa-brain"></i>
        </div>
        <div>
          <h3 class="font-bold text-slate-900 mb-1">Caynana KararÄ±</h3>
          <p id="verdictText" class="text-sm text-slate-700 leading-relaxed"></p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-2xl border border-slate-200 shadow-xl shadow-slate-200/50 overflow-hidden mb-6">
      <div class="bg-slate-900 text-white text-center py-2 text-[10px] font-bold uppercase tracking-[0.2em]">
        <i class="fa-solid fa-star text-yellow-400 mr-1"></i> Tavsiye Edilen
      </div>

      <div class="p-5">
        <div class="aspect-video bg-slate-50 rounded-xl flex items-center justify-center p-4 mb-4 border border-slate-100 relative">
          <img id="heroImg" src="" alt="ÃœrÃ¼n" class="max-h-full max-w-full object-contain mix-blend-multiply">
        </div>

        <h2 id="heroTitle" class="text-xl font-bold text-slate-900 leading-tight mb-4"></h2>

        <div class="space-y-3 mb-6">
          <ul id="heroReasons" class="space-y-2"></ul>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <a id="heroLink" href="#" target="_blank" rel="noopener noreferrer"
             class="bg-emerald-600 hover:bg-emerald-700 text-white flex items-center justify-center py-3.5 rounded-xl font-bold text-sm transition shadow-lg shadow-emerald-500/30">
            Ä°ncele & Al
          </a>

          <button id="btnTTS" onclick="playTTS()"
            class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 flex items-center justify-center py-3.5 rounded-xl font-bold text-sm transition">
            <i class="fa-solid fa-volume-high mr-2 text-emerald-500"></i> Dinle
          </button>
        </div>
      </div>
    </div>

    <div class="space-y-3">
      <button onclick="resetApp()" class="w-full py-4 text-slate-500 font-medium text-sm hover:text-emerald-600 transition flex items-center justify-center gap-2">
        <i class="fa-solid fa-rotate-left"></i>
        Yeni bir ÅŸey sor
      </button>
    </div>
  </section>

  <section id="scene-about" class="hidden">
    <h2 class="text-2xl font-extrabold text-slate-900 mb-6">Biz Kimiz?</h2>
    <div class="prose prose-slate prose-sm text-slate-600 leading-relaxed">
      <p class="mb-4">
        <strong class="text-slate-900">Caynana</strong>, karmaÅŸÄ±k alÄ±ÅŸveriÅŸ dÃ¼nyasÄ±nda sizin safÄ±nÄ±zda duran, yapay zeka destekli bir karar motorudur.
      </p>
      <p class="mb-4">
        Ä°nternet, sahte yorumlar, ÅŸiÅŸirilmiÅŸ fiyatlar ve kafa karÄ±ÅŸtÄ±ran teknik terimlerle dolu. Biz, bu gÃ¼rÃ¼ltÃ¼yÃ¼ filtreleyip size en net, en dÃ¼rÃ¼st gerÃ§eÄŸi sunmak iÃ§in buradayÄ±z.
      </p>
      <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm my-6">
        <h3 class="font-bold text-slate-900 mb-2">Misyonumuz</h3>
        <p>TÃ¼keticiyi korumak, bÃ¼tÃ§esini savunmak ve "KeÅŸke almasaydÄ±m" cÃ¼mlesini tarihe gÃ¶mmek.</p>
      </div>
      <p>
        Arkada Ã§alÄ±ÅŸan algoritmalarÄ±mÄ±z, binlerce veri noktasÄ±nÄ± tarar; sadece fiyatÄ± deÄŸil, uzun dÃ¶nem kullanÄ±m maliyetlerini ve kronik arÄ±zalarÄ± da hesaplar. TÄ±pkÄ± detaycÄ± bir "Kaynana" gibi.
      </p>
    </div>
    <button onclick="showScene('scene-home')" class="mt-8 text-emerald-600 font-bold text-sm">â† Ana Sayfaya DÃ¶n</button>
  </section>

  <section id="scene-how" class="hidden">
    <h2 class="text-2xl font-extrabold text-slate-900 mb-6">NasÄ±l Ã‡alÄ±ÅŸÄ±r?</h2>

    <div class="space-y-6 relative">
      <div class="absolute left-4 top-2 bottom-2 w-0.5 bg-slate-200 -z-10"></div>

      <div class="flex gap-4">
        <div class="w-8 h-8 rounded-full bg-emerald-600 text-white flex items-center justify-center font-bold text-sm shrink-0 ring-4 ring-white">1</div>
        <div>
          <h3 class="font-bold text-slate-900">Sorunu Sor</h3>
          <p class="text-sm text-slate-600 mt-1">Ä°lgilendiÄŸin Ã¼rÃ¼nÃ¼n linkini yapÄ±ÅŸtÄ±r veya sadece ne aradÄ±ÄŸÄ±nÄ± yaz. (Ã–rn: "Ã–ÄŸrenci iÃ§in en iyi laptop")</p>
        </div>
      </div>

      <div class="flex gap-4">
        <div class="w-8 h-8 rounded-full bg-emerald-600 text-white flex items-center justify-center font-bold text-sm shrink-0 ring-4 ring-white">2</div>
        <div>
          <h3 class="font-bold text-slate-900">Analiz BaÅŸlar</h3>
          <p class="text-sm text-slate-600 mt-1">Yapay zekamÄ±z teknik Ã¶zellikleri, kullanÄ±cÄ± ÅŸikayetlerini ve fiyat geÃ§miÅŸini saniyeler iÃ§inde tarar.</p>
        </div>
      </div>

      <div class="flex gap-4">
        <div class="w-8 h-8 rounded-full bg-emerald-600 text-white flex items-center justify-center font-bold text-sm shrink-0 ring-4 ring-white">3</div>
        <div>
          <h3 class="font-bold text-slate-900">Karar AnÄ±</h3>
          <p class="text-sm text-slate-600 mt-1">Sana net bir Ã¶zet, riskler ve eÄŸer varsa daha iyi bir alternatif sunarÄ±z. KararÄ± sen verirsin.</p>
        </div>
      </div>
    </div>
    <button onclick="showScene('scene-home')" class="mt-8 text-emerald-600 font-bold text-sm">â† Ana Sayfaya DÃ¶n</button>
  </section>

  <section id="scene-faq" class="hidden">
    <h2 class="text-2xl font-extrabold text-slate-900 mb-6">SÄ±kÃ§a Sorulanlar</h2>
    <div class="space-y-4">

      <details class="group bg-white border border-slate-200 rounded-xl overflow-hidden transition-all duration-300">
        <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-4 text-slate-900 hover:bg-slate-50">
          <span>Hizmet Ã¼cretli mi?</span>
          <span class="transition group-open:rotate-180"><i class="fa-solid fa-chevron-down text-xs"></i></span>
        </summary>
        <div class="text-slate-600 text-sm p-4 pt-0 leading-relaxed">
          HayÄ±r, Caynana son kullanÄ±cÄ± iÃ§in tamamen Ã¼cretsizdir.
        </div>
      </details>

      <details class="group bg-white border border-slate-200 rounded-xl overflow-hidden transition-all duration-300">
        <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-4 text-slate-900 hover:bg-slate-50">
          <span>Neden size gÃ¼veneyim?</span>
          <span class="transition group-open:rotate-180"><i class="fa-solid fa-chevron-down text-xs"></i></span>
        </summary>
        <div class="text-slate-600 text-sm p-4 pt-0 leading-relaxed">
          Biz satÄ±cÄ± deÄŸiliz. Herhangi bir markanÄ±n bayisi deÄŸiliz. Ã–nerdiÄŸimiz Ã¼rÃ¼nlerden komisyon alabiliriz ancak algoritmamÄ±z "kÃ¶tÃ¼ Ã¼rÃ¼nÃ¼ iyi gÃ¶stermek" Ã¼zerine deÄŸil, "en iyi F/P Ã¼rÃ¼nÃ¼nÃ¼ bulmak" Ã¼zerine kuruludur.
        </div>
      </details>

      <details class="group bg-white border border-slate-200 rounded-xl overflow-hidden transition-all duration-300">
        <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-4 text-slate-900 hover:bg-slate-50">
          <span>Sesli yanÄ±t Ã¶zelliÄŸi nedir?</span>
          <span class="transition group-open:rotate-180"><i class="fa-solid fa-chevron-down text-xs"></i></span>
        </summary>
        <div class="text-slate-600 text-sm p-4 pt-0 leading-relaxed">
          Okumaya vaktiniz yoksa, analiz sonucunu size sesli olarak okuyabiliriz. Bu Ã¶zellik ÅŸu an Beta aÅŸamasÄ±ndadÄ±r.
        </div>
      </details>

    </div>
    <button onclick="showScene('scene-home')" class="mt-8 text-emerald-600 font-bold text-sm">â† Ana Sayfaya DÃ¶n</button>
  </section>

  <section id="scene-privacy" class="hidden">
    <h2 class="text-2xl font-extrabold text-slate-900 mb-6">Gizlilik PolitikasÄ±</h2>
    <div class="bg-white p-5 rounded-xl border border-slate-200 text-xs text-slate-500 h-96 overflow-y-auto leading-relaxed">
      <p class="mb-2 font-bold text-slate-900">1. Veri Toplama</p>
      <p class="mb-4">Caynana (Ä°talky Teknoloji A.Å.), hizmet kalitesini artÄ±rmak amacÄ±yla anonimleÅŸtirilmiÅŸ arama verilerini saklayabilir. KiÅŸisel kimlik bilgileriniz (Ad, Soyad, Adres) Ã¼yelik oluÅŸturmadÄ±ÄŸÄ±nÄ±z sÃ¼rece istenmez.</p>

      <p class="mb-2 font-bold text-slate-900">2. Ã‡erezler</p>
      <p class="mb-4">KullanÄ±cÄ± deneyimini iyileÅŸtirmek iÃ§in standart tarayÄ±cÄ± Ã§erezleri kullanÄ±yoruz. Bunlar tercihlerinizi hatÄ±rlamak iÃ§indir.</p>

      <p class="mb-2 font-bold text-slate-900">3. ÃœÃ§Ã¼ncÃ¼ Taraflar</p>
      <p class="mb-4">Ã–nerilen Ã¼rÃ¼n linkleri sizi Ã¼Ã§Ã¼ncÃ¼ taraf pazar yerlerine (Trendyol, Hepsiburada, Amazon vb.) yÃ¶nlendirir. O sitelerdeki gizlilik politikalarÄ± kendilerine aittir.</p>

      <p class="italic">Son GÃ¼ncelleme: Ocak 2026</p>
    </div>
    <button onclick="showScene('scene-home')" class="mt-8 text-emerald-600 font-bold text-sm">â† Ana Sayfaya DÃ¶n</button>
  </section>

  <section id="scene-contact" class="hidden">
    <h2 class="text-2xl font-extrabold text-slate-900 mb-2">Ä°letiÅŸim</h2>
    <p class="text-slate-500 mb-6 text-sm">GÃ¶rÃ¼ÅŸ, Ã¶neri veya iÅŸ birliÄŸi iÃ§in bize ulaÅŸÄ±n.</p>

    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
      <div class="flex items-center gap-4 mb-6">
        <div class="w-10 h-10 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-600">
          <i class="fa-solid fa-envelope"></i>
        </div>
        <div>
          <div class="text-xs text-slate-400 font-bold uppercase">E-Posta</div>
          <a href="mailto:info@italky.com" class="text-slate-900 font-medium">info@italky.com</a>
        </div>
      </div>

      <div class="flex items-center gap-4 mb-6">
        <div class="w-10 h-10 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-600">
          <i class="fa-solid fa-location-dot"></i>
        </div>
        <div>
          <div class="text-xs text-slate-400 font-bold uppercase">Konum</div>
          <span class="text-slate-900 font-medium">DÃ¼zce Teknopark, TÃ¼rkiye</span>
        </div>
      </div>

      <div class="pt-6 border-t border-slate-100">
        <button class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold text-sm hover:bg-slate-800 transition">
          Bize YazÄ±n
        </button>
      </div>
    </div>
    <button onclick="showScene('scene-home')" class="mt-8 text-emerald-600 font-bold text-sm">â† Ana Sayfaya DÃ¶n</button>
  </section>

</main>

<script>
  // --- STATE MANAGEMENT ---
  const API_ANALYZE = "/api/analyze";
  const API_TTS = "/api/tts";

  // Backend yoksa test etmek iÃ§in true yap.
  const MOCK_MODE = false;

  let lastNarration = "";
  let currentAudio = null;
  let loadingTimer = null;

  // --- HELPERS (prod) ---
  function stopLoadingSteps() {
    if (loadingTimer) {
      clearInterval(loadingTimer);
      loadingTimer = null;
    }
  }

  function showError(msg) {
    const card = document.getElementById("errorCard");
    const text = document.getElementById("errorText");
    text.textContent = msg || "Beklenmeyen bir hata oluÅŸtu.";
    card.classList.remove("hidden");
  }

  function hideError() {
    document.getElementById("errorCard").classList.add("hidden");
    document.getElementById("errorText").textContent = "";
  }

  function safeUrl(url) {
    try {
      const u = new URL(url, window.location.origin);
      if (u.protocol !== "http:" && u.protocol !== "https:") return "#";
      return u.href;
    } catch {
      return "#";
    }
  }

  function stopAudio() {
    if (currentAudio) {
      try { currentAudio.pause(); } catch {}
      currentAudio = null;
    }
  }

  // --- NAVIGATION & SCENES ---
  function showScene(sceneId) {
    stopLoadingSteps();
    document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
    document.getElementById(sceneId).classList.remove('hidden');
    window.scrollTo(0,0);
  }

  function toggleMenu() {
    const menu = document.getElementById('menuOverlay');
    if (menu.classList.contains('translate-x-full')) {
      menu.classList.remove('translate-x-full');
    } else {
      menu.classList.add('translate-x-full');
    }
  }

  function menuNav(sceneId) {
    toggleMenu();
    setTimeout(() => showScene(sceneId), 300);
  }

  function resetApp() {
    stopAudio();
    hideError();
    document.getElementById("q").value = "";
    document.getElementById("heroImg").src = "";
    document.getElementById("heroTitle").textContent = "";
    document.getElementById("verdictText").textContent = "";
    document.getElementById("heroReasons").innerHTML = "";
    document.getElementById("heroLink").href = "#";
    document.getElementById("heroLink").classList.add("pointer-events-none", "opacity-50");
    document.getElementById("btnTTS").innerHTML = `<i class="fa-solid fa-volume-high mr-2 text-emerald-500"></i> Dinle`;
    lastNarration = "";
    showScene("scene-home");
  }

  function fillQ(text) {
    document.getElementById("q").value = text;
  }

  function playLoadingSteps() {
    stopLoadingSteps();
    const steps = [
      "Fiyat geÃ§miÅŸi kontrol ediliyor...",
      "Kronik sorunlar taranÄ±yor...",
      "GerÃ§ek kullanÄ±cÄ± yorumlarÄ± okunuyor...",
      "Rakip analizleri yapÄ±lÄ±yor...",
      "Son karar hazÄ±rlanÄ±yor..."
    ];
    let i = 0;
    const el = document.getElementById("loadingStep");
    el.textContent = steps[0];

    loadingTimer = setInterval(() => {
      i++;
      el.textContent = steps[i] || "Son rÃ¶tuÅŸlar...";
      if (i >= steps.length) stopLoadingSteps();
    }, 800);
  }

  // --- MAIN FLOW ---
  async function startJourney() {
    hideError();
    const q = (document.getElementById("q").value || "").trim();
    if (!q) { showScene("scene-results"); showError("LÃ¼tfen bir Ã¼rÃ¼n adÄ± veya link girin ğŸ˜Š"); return; }

    stopAudio();
    showScene("scene-loading");
    playLoadingSteps();

    try {
      let data;

      if (MOCK_MODE) {
        await new Promise(r => setTimeout(r, 1800));
        data = {
          verdictText: "Bu fiyata bu performans riskli. Malzeme kalitesiyle ilgili Ã§ok sayÄ±da ÅŸikayet var. Rakipleri daha saÄŸlam.",
          recommended: {
            title: "Alternatif: TechPro X500",
            image: "https://via.placeholder.com/600x400?text=TechPro+X500",
            url: "https://www.trendyol.com/",
            reasons: ["Metal kasa yapÄ±sÄ± daha dayanÄ±klÄ±", "Servis aÄŸÄ± Ã§ok daha yaygÄ±n", "FiyatÄ± %15 daha uygun"]
          },
          narrationText: "BaÅŸkanÄ±m bu Ã¼rÃ¼ne bulaÅŸma derim. Plastik kalitesi Ã§ok kÃ¶tÃ¼. Onun yerine TechPro X500 al; hem metal kasa hem daha ucuz."
        };
      } else {
        const res = await fetch(API_ANALYZE, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ q })
        });

        if (!res.ok) {
          const t = await res.text().catch(() => "");
          throw new Error(t || "Analiz servisi yanÄ±t vermedi.");
        }
        data = await res.json();
      }

      // Results ekranÄ±na geÃ§
      showScene("scene-results");

      // Populate UI
      document.getElementById("verdictText").textContent = String(data.verdictText || "Veri alÄ±namadÄ±.").slice(0, 900);

      const rec = data.recommended || {};
      document.getElementById("heroTitle").textContent = String(rec.title || "Ã–neri BulunamadÄ±").slice(0, 180);

      const img = rec.image ? String(rec.image) : "";
      document.getElementById("heroImg").src = img || "https://via.placeholder.com/300?text=G%C3%B6rsel+Yok";

      // Safe link
      const link = safeUrl(rec.url || "#");
      const btnLink = document.getElementById("heroLink");
      btnLink.href = link;
      btnLink.setAttribute("rel", "noopener noreferrer");

      if (link === "#") btnLink.classList.add("pointer-events-none", "opacity-50");
      else btnLink.classList.remove("pointer-events-none", "opacity-50");

      // Reasons (XSS-safe)
      const reasonsList = document.getElementById("heroReasons");
      reasonsList.innerHTML = "";
      (rec.reasons || []).slice(0, 3).forEach(r => {
        const li = document.createElement("li");
        li.className = "flex items-start gap-2 text-sm text-slate-700";

        const icon = document.createElement("i");
        icon.className = "fa-solid fa-check-circle text-emerald-500 mt-0.5";

        const span = document.createElement("span");
        span.textContent = String(r || "").slice(0, 160);

        li.appendChild(icon);
        li.appendChild(span);
        reasonsList.appendChild(li);
      });

      lastNarration = String(data.narrationText || data.verdictText || "").slice(0, 1400);

    } catch (e) {
      showScene("scene-results");
      showError("Analiz alÄ±namadÄ±. " + (e && e.message ? e.message : "Servise ulaÅŸÄ±lamadÄ±."));
    }
  }

  // --- TTS (Play/Stop) ---
  async function playTTS() {
    if (!lastNarration) { showError("Okunacak metin bulunamadÄ±."); return; }

    const btn = document.getElementById("btnTTS");

    // EÄŸer Ã§alÄ±yorsa STOP
    if (currentAudio && !currentAudio.paused) {
      stopAudio();
      btn.disabled = false;
      btn.innerHTML = `<i class="fa-solid fa-volume-high mr-2 text-emerald-500"></i> Dinle`;
      return;
    }

    const originalContent = `<i class="fa-solid fa-volume-high mr-2 text-emerald-500"></i> Dinle`;
    btn.disabled = true;
    btn.innerHTML = `<i class="fa-solid fa-spinner animate-spin"></i> YÃ¼kleniyor`;

    try {
      const res = await fetch(API_TTS, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ text: lastNarration, voice: "shimmer" })
      });

      if (!res.ok) throw new Error("Ses servisi yanÄ±t vermedi");

      const data = await res.json();
      if (!data.audioBase64) throw new Error("Ses verisi boÅŸ");

      const bytes = Uint8Array.from(atob(data.audioBase64), c => c.charCodeAt(0));
      const blob = new Blob([bytes], { type: "audio/mpeg" });
      const url = URL.createObjectURL(blob);

      stopAudio();
      currentAudio = new Audio(url);

      btn.disabled = false;
      btn.innerHTML = `<i class="fa-solid fa-stop mr-2 text-emerald-500"></i> Durdur`;

      currentAudio.play();

      currentAudio.onended = () => {
        try { URL.revokeObjectURL(url); } catch {}
        stopAudio();
        btn.disabled = false;
        btn.innerHTML = originalContent;
      };

    } catch (e) {
      btn.disabled = false;
      btn.innerHTML = originalContent;
      showError("Ses Ã§alÄ±namadÄ±: " + (e && e.message ? e.message : "Bilinmeyen hata"));
    }
  }

  // Enter Key Support
  document.getElementById("q").addEventListener("keydown", (e) => {
    if (e.key === "Enter") startJourney();
  });

  // Ä°lk aÃ§Ä±lÄ±ÅŸ
  showScene("scene-home");
</script>

</body>
</html>
