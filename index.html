<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#000000" />
<title>CAYNANA.AI</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

<style>
  :root { --primary:#00C897; --bg-dark:#0b0f18; --font:'Plus Jakarta Sans',sans-serif; }
  * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html, body { height:100%; margin:0; }

  body{
    font-family:var(--font);
    background:#000;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  #app{
    width:100%; height:100%;
    max-width:480px; max-height:920px;
    aspect-ratio: 9 / 19.5;
    border-radius:24px; overflow:hidden;
    box-shadow:0 0 50px rgba(0,0,0,0.55);
    position:relative;
    background-color:var(--bg-dark);
    background-size:cover;
    background-position:60% 40%;
    background-repeat:no-repeat;
    transition: background-image 0.25s ease-in-out, background-position .25s ease;
  }

  @media (max-width:520px){
    body{ display:block; }
    #app{
      max-width:none; max-height:none; aspect-ratio:auto;
      border-radius:0; width:100vw; height:100vh; box-shadow:none;
    }
  }

  #app::after{
    content:'';
    position:absolute; inset:0;
    background:linear-gradient(to top,
      rgba(11,15,24,0.98) 0%,
      rgba(11,15,24,0.88) 18%,
      rgba(11,15,24,0.25) 55%,
      rgba(11,15,24,0.45) 100%
    );
    pointer-events:none;
    z-index:1;
  }

  header{
    position:relative; z-index:10;
    padding:16px 20px;
    padding-top:max(16px, env(safe-area-inset-top));
    display:flex; justify-content:space-between; align-items:flex-start; gap:14px;
  }
  .brand-group{ display:flex; flex-direction:column; gap:4px; }
  .logo{
    font-weight:800; font-size:24px; color:#fff;
    display:flex; align-items:center; gap:10px; line-height:1;
  }
  .logo i{ color:var(--primary); }
  .logo span{ color:var(--primary); }
  .slogan{ font-size:11px; font-weight:700; color:rgba(255,255,255,0.82); }
  .menu-btn{
    width:42px; height:42px; border-radius:50%;
    background:rgba(255,255,255,0.14);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    display:flex; align-items:center; justify-content:center;
    color:#fff; cursor:pointer; border:1px solid rgba(255,255,255,0.12);
    margin-top:2px;
  }

  #container{
    position:relative; z-index:5;
    height:100%;
    overflow-y:auto;
    padding:20px;
    padding-bottom:330px;
    scrollbar-width:none;
    -webkit-overflow-scrolling:touch;
  }
  #container::-webkit-scrollbar{ display:none; }

  #hero-text{ text-align:center; margin-top:64px; transition:opacity .25s ease; }
  #hero-title{
    font-size:36px; font-weight:800; line-height:1.1; color:#fff;
    text-shadow:0 6px 22px rgba(0,0,0,0.65);
    margin-bottom:10px;
  }
  #hero-desc{
    font-size:16px; color:rgba(255,255,255,0.92); font-weight:600;
    text-shadow:0 4px 18px rgba(0,0,0,0.55);
  }

  #chat-area{ margin-top:18px; display:none; }
  .msg-row{ display:flex; margin-bottom:16px; }
  .msg-row.user{ justify-content:flex-end; }
  .bubble{
    max-width:85%;
    padding:14px 18px;
    border-radius:20px;
    font-size:15px; line-height:1.5;
    word-wrap:break-word;
    font-weight:650;
  }
  .msg-row.ai .bubble{ background:rgba(255,255,255,0.95); color:#1a1a1a; border-bottom-left-radius:6px; }
  .msg-row.user .bubble{ background:var(--primary); color:#fff; border-bottom-right-radius:6px; }

  .audio-btn{
    margin-top:10px;
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,0.10);
    background:#fff;
    color:var(--primary);
    font-weight:900;
    font-size:12px;
    cursor:pointer;
    user-select:none;
  }
  .audio-btn.playing{ background:#ffeaea; color:#d32f2f; border-color:#d32f2f; }

  .image-preview{ width:100%; border-radius:12px; margin-bottom:10px; }

  .cards-wrapper{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px; }
  .card{
    background:#fff; border-radius:16px; padding:10px;
    display:flex; flex-direction:column;
    box-shadow:0 5px 15px rgba(0,0,0,0.12);
    position:relative; overflow:hidden;
  }
  .badge{
    position:absolute; top:10px; left:0;
    padding:4px 10px; font-size:10px; font-weight:900; color:#fff;
    border-top-right-radius:10px; border-bottom-right-radius:10px;
    z-index:2;
  }
  .badge.gold{ background:linear-gradient(90deg,#FFD700,#FFA500); }
  .badge.value{ background:linear-gradient(90deg,#00C897,#009688); }
  .badge.silver{ background:linear-gradient(90deg,#9E9E9E,#6f6f6f); }

  .card-img{ width:100%; height:110px; object-fit:cover; border-radius:12px; margin-bottom:8px; background:#f1f1f1; }
  .card-title{ font-size:12px; font-weight:800; color:#333; margin-bottom:4px; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }
  .card-price{ font-size:14px; font-weight:900; color:var(--primary); margin-bottom:8px; }
  .card-btn{
    margin-top:auto;
    background:#111; color:#fff;
    text-align:center; padding:9px; border-radius:10px;
    font-size:11px; font-weight:900; text-decoration:none;
  }

  #bottom-bar{
    position:fixed;
    left:0; right:0; bottom:0;
    z-index:20;
    background:rgba(255,255,255,0.92);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-top:1px solid rgba(255,255,255,0.35);
    padding-bottom:calc(env(safe-area-inset-bottom) + 18px);
    padding-top:14px;
  }
  #bottom-bar .inner{ max-width:480px; margin:0 auto; width:100%; }
  @media (max-width:520px){ #bottom-bar .inner{ max-width:none; } }

  #suggestion{
    position:absolute; top:-44px; left:50%;
    transform:translateX(-50%);
    background:#fff;
    padding:9px 16px;
    border-radius:22px;
    font-size:12px;
    font-weight:900;
    color:var(--primary);
    box-shadow:0 10px 24px rgba(0,0,0,0.18);
    white-space:nowrap;
  }

  .input-area{ padding:0 15px; display:flex; align-items:center; gap:10px; }
  .input-box{
    flex:1; height:52px; background:#fff; border-radius:26px;
    display:flex; align-items:center; padding:0 6px;
    border:1px solid rgba(0,0,0,0.06);
  }
  .tool-btn{ width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#666; cursor:pointer; }
  #user-input{ flex:1; border:none; outline:none; font-size:15px; padding:0 8px; font-family:var(--font); background:transparent; }
  #send-btn{
    width:52px; height:52px; border-radius:50%;
    border:none; background:var(--primary); color:#fff;
    font-size:18px; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 10px 22px rgba(0,200,151,0.25);
  }
  #send-btn:active{ transform:scale(0.92); }

  .dock{ display:flex; gap:12px; padding:10px 15px 0 15px; overflow-x:auto; scrollbar-width:none; }
  .dock::-webkit-scrollbar{ display:none; }
  .dock-item{ display:flex; flex-direction:column; align-items:center; gap:4px; opacity:0.45; transition:0.25s; cursor:pointer; min-width:64px; }
  .dock-item.active{ opacity:1; transform:translateY(-2px); }
  .dock-icon{ width:46px; height:46px; border-radius:16px; background:rgba(0,0,0,0.06); display:flex; align-items:center; justify-content:center; font-size:18px; color:#333; }
  .dock-item.active .dock-icon{ background:var(--primary); color:#fff; box-shadow:0 8px 18px rgba(0,0,0,0.18); }
  .dock-label{ font-size:10px; font-weight:900; color:#333; }

  .footer-info{ text-align:center; font-size:10px; color:#777; font-weight:800; margin-top:8px; padding-bottom:2px; }
  .it-flag-line{ width:62px; height:4px; margin:6px auto 0; border-radius:3px; overflow:hidden; display:flex; }
  .it-flag-line span{ flex:1; }
  .it-flag-line .g{ background:#009246; }
  .it-flag-line .w{ background:#fff; }
  .it-flag-line .r{ background:#ce2b37; }

  #file-upload{ display:none !important; }
</style>
</head>
<body>

<div id="app">
  <header>
    <div class="brand-group">
      <div class="logo"><i class="fa-solid fa-wand-magic-sparkles"></i>CAYNANA<span>.AI</span></div>
      <div class="slogan">Yapay Zek√¢nƒ±n Geleneksel Aklƒ±</div>
    </div>
    <div class="menu-btn"><i class="fa-solid fa-bars"></i></div>
  </header>

  <div id="container">
    <div id="hero-text">
      <div id="hero-title">Almadan √∂nce<br>Caynana‚Äôya sor.</div>
      <div id="hero-desc">Sonra ‚Äúke≈üke‚Äù dememek i√ßin buradayƒ±m.</div>
    </div>
    <div id="chat-area"></div>
  </div>

  <div id="bottom-bar">
    <div class="inner">
      <div id="suggestion">Her indirime atlayan sonunda pahalƒ± √∂der.</div>

      <div class="input-area">
        <div class="input-box">
          <div class="tool-btn" onclick="openCamera()"><i class="fa-solid fa-camera"></i></div>
          <input type="text" id="user-input" placeholder="Ne danƒ±≈ümak istersin?" autocomplete="off">
          <div class="tool-btn" id="mic-btn" onclick="startMic()"><i class="fa-solid fa-microphone"></i></div>
        </div>
        <button id="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
      </div>

      <div class="dock" id="dock-container"></div>

      <div class="footer-info">@CaynanaAI by Italky Technology</div>
      <div class="it-flag-line"><span class="g"></span><span class="w"></span><span class="r"></span></div>
    </div>
  </div>
</div>

<input type="file" id="file-upload" accept="image/*" capture="environment">

<script>
  const API_BASE = ""; // backend aynƒ± host ise bo≈ü bƒ±rak
  const CHAT_URL = API_BASE + "/api/chat";

  const MODES = {
    shopping:  { label:"Alƒ±≈üveri≈ü", icon:"fa-bag-shopping",  color:"#00C897", img:"images/hero-shopping.png",  title:"Almadan √∂nce<br>Caynana‚Äôya sor.", desc:"Sonra ‚Äúke≈üke‚Äù dememek i√ßin buradayƒ±m.", sugg:"Her indirime atlayan sonunda pahalƒ± √∂der.", ph:"Neye bakmƒ±≈ütƒ±n evladƒ±m?" },
    chat:      { label:"Sohbet",   icon:"fa-comments",      color:"#FFB300", img:"images/hero-chat.png",      title:"Caynana ile<br>dertle≈ü.", desc:"Anlat bakalƒ±m, canƒ±nƒ± sƒ±kan ne?", sugg:"Eskiden kom≈üuluk vardƒ±, ≈üimdi wifi var‚Ä¶", ph:"Naber Caynana?" },
    fal:       { label:"Fal",      icon:"fa-mug-hot",       color:"#8B5CF6", img:"images/hero-fal.png",       title:"Kahveni i√ßtin mi?<br>Gel falƒ±na bakayƒ±m.", desc:"Neyse halin, √ßƒ±ksƒ±n falin.", sugg:"Kapat fincanƒ±, fotoƒürafƒ±nƒ± √ßek g√∂nder.", ph:"Fincanƒ± √ßektin mi?" },
    dream:     { label:"R√ºya",     icon:"fa-cloud-moon",    color:"#6366F1", img:"images/hero-dream.png",     title:"R√ºyalar<br>haberci olabilir.", desc:"Hayƒ±rdƒ±r in≈üallah‚Ä¶", sugg:"Suya anlat derler ama sen bana anlat.", ph:"R√ºyanda ne g√∂rd√ºn?" },
    health:    { label:"Saƒülƒ±k",   icon:"fa-heart-pulse",   color:"#EF4444", img:"images/hero-health.png",    title:"Saƒülƒ±k olsun<br>gerisi bo≈ü.", desc:"Neren aƒürƒ±yor evladƒ±m?", sugg:"Terli terli soƒüuk su i√ßme!", ph:"≈ûik√¢yetin ne?" },
    diet:      { label:"Diyet",    icon:"fa-apple-whole",   color:"#84CC16", img:"images/hero-diet.png",      title:"Saƒülƒ±klƒ± beslen<br>zinde kal.", desc:"A√ß kalarak deƒüil, dengeli ye.", sugg:"Ak≈üam 7'den sonra buzdolabƒ±na k√ºs.", ph:"Hedefin ne?" },
    food:      { label:"Yemek",    icon:"fa-utensils",      color:"#F97316", img:"images/hero-food.png",      title:"Bug√ºn ne<br>pi≈üirsem?", desc:"Dolapta ne var s√∂yle, tarif vereyim.", sugg:"Malzemeyi ziyan etme, bereket ka√ßar.", ph:"Hangi malzemeler var?" },
    law:       { label:"Hukuk",    icon:"fa-scale-balanced",color:"#3B82F6", img:"images/hero-law.png",       title:"Hakkƒ±nƒ±<br>yedirme.", desc:"Danƒ±≈ümadan imza atma evladƒ±m.", sugg:"S√∂z u√ßar yazƒ± kalƒ±r.", ph:"Sorun nedir?" },
    astro:     { label:"Bur√ß",     icon:"fa-star",          color:"#D946EF", img:"images/hero-astro.png",     title:"Yƒ±ldƒ±zlar<br>ne diyor?", desc:"Merk√ºr retrosuna dikkat.", sugg:"Yƒ±ldƒ±znameye baktƒ±m, yolun a√ßƒ±k.", ph:"Burcun ne?" },
    translate: { label:"√áeviri",   icon:"fa-language",      color:"#64748B", img:"images/hero-translate.png", title:"Dil bilmek<br>altƒ±n bileziktir.", desc:"Anlamadƒ±ƒüƒ±n yazƒ±yƒ± g√∂ster √ßevireyim.", sugg:"Turist gelince mahcup olma.", ph:"√áevrilecek metin ne?" },
  };

  let currentMode="shopping";
  let pendingImage=null;
  let chatHistory={};

  marked.setOptions({ mangle:false, headerIds:false });

  function init(){ renderDock(); switchMode("shopping"); setupSwipe(); }

  function renderDock(){
    const dock=document.getElementById("dock-container");
    dock.innerHTML="";
    Object.keys(MODES).forEach(key=>{
      const m=MODES[key];
      const el=document.createElement("div");
      el.className=`dock-item ${key===currentMode?"active":""}`;
      el.onclick=()=>switchMode(key);
      el.innerHTML=`<div class="dock-icon"><i class="fa-solid ${m.icon}"></i></div><div class="dock-label">${m.label}</div>`;
      dock.appendChild(el);
    });
  }

  function switchMode(mode){
    const chatArea=document.getElementById("chat-area");
    chatHistory[currentMode]=chatArea.innerHTML;

    currentMode=mode;
    const m=MODES[mode];

    document.documentElement.style.setProperty("--primary", m.color);
    document.getElementById("hero-title").innerHTML=m.title;
    document.getElementById("hero-desc").innerHTML=m.desc;
    document.getElementById("suggestion").innerText=m.sugg;
    document.getElementById("user-input").placeholder=m.ph;

    document.getElementById("app").style.backgroundImage=`url('${m.img}?v=${Date.now()}')`;
    renderDock();

    chatArea.innerHTML = chatHistory[mode] || "";
    toggleHero(chatArea.innerHTML.trim()==="");
  }

  function toggleHero(show){
    const hero=document.getElementById("hero-text");
    hero.style.opacity=show?"1":"0";
    hero.style.pointerEvents=show?"all":"none";
    document.getElementById("chat-area").style.display=show?"none":"block";
  }

  function addMessage(role, text, imgData){
    const area=document.getElementById("chat-area");
    const row=document.createElement("div");
    row.className=`msg-row ${role}`;

    let content="";
    if(imgData) content += `<img src="${imgData}" class="image-preview">`;

    if(role==="ai"){
      content += DOMPurify.sanitize(marked.parse(text||""));
      content += `<div class="audio-btn" data-speech="${escapeAttr(text||'')}"><i class="fa-solid fa-volume-high"></i> Caynana Konu≈üuyor</div>`;
    }else{
      content += DOMPurify.sanitize(text||"");
    }

    row.innerHTML=`<div class="bubble">${content}</div>`;
    area.appendChild(row);
    document.getElementById("container").scrollTo(0, document.getElementById("container").scrollHeight);
  }

  function escapeAttr(s){
    return (s||"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function addLoading(){
    const id="loading-"+Date.now();
    const area=document.getElementById("chat-area");
    const row=document.createElement("div");
    row.className="msg-row ai";
    row.id=id;
    row.innerHTML=`<div class="bubble"><i class="fa-solid fa-circle-notch fa-spin"></i> Bakƒ±yorum evladƒ±m‚Ä¶</div>`;
    area.appendChild(row);
    return id;
  }
  function removeLoading(id){ const el=document.getElementById(id); if(el) el.remove(); }

  async function sendMessage(){
    const input=document.getElementById("user-input");
    const txt=input.value.trim();
    if(!txt && !pendingImage) return;

    toggleHero(false);

    if(currentMode==="shopping"){
      document.querySelectorAll(".cards-wrapper").forEach(el=>el.remove());
    }

    addMessage("user", txt, pendingImage);
    input.value="";

    const loadingId = addLoading();
    const payload = { message: txt, mode: currentMode, image: pendingImage };
    pendingImage=null;

    try{
      const res = await fetch(CHAT_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      removeLoading(loadingId);

      addMessage("ai", data.assistant_text || "Bir ≈üey diyemedim evladƒ±m‚Ä¶");
      if(data.data && data.data.length) renderCards(data.data);

    }catch(e){
      removeLoading(loadingId);
      addMessage("ai", "Backend √ßalƒ±≈ümƒ±yor evladƒ±m. /api/chat eri≈üimi yok.");
      console.error(e);
    }
  }

  function renderCards(list){
    const area=document.getElementById("chat-area");
    const wrapper=document.createElement("div");
    wrapper.className="cards-wrapper";

    (list||[]).forEach(item=>{
      const badgeClass = (item.badge || "silver");
      const badgeText =
        badgeClass==="gold" ? "√ñNERƒ∞LEN" :
        badgeClass==="value" ? "F/P" : "SE√áƒ∞M";

      const safeUrl = (item.url && (item.url.startsWith("http://") || item.url.startsWith("https://"))) ? item.url : "#";

      const card=document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <div class="badge ${badgeClass}">${badgeText}</div>
        <img src="${item.image || 'https://via.placeholder.com/150'}" class="card-img" onerror="this.src='https://via.placeholder.com/150'">
        <div class="card-title">${DOMPurify.sanitize(item.title || '')}</div>
        <div class="card-price">${DOMPurify.sanitize(item.price || '')}</div>
        <a href="${safeUrl}" target="_blank" class="card-btn" rel="noopener noreferrer">ƒ∞NCELE</a>
      `;
      wrapper.appendChild(card);
    });

    area.appendChild(wrapper);
    document.getElementById("container").scrollTo(0, document.getElementById("container").scrollHeight);
  }

  function openCamera(){ document.getElementById("file-upload").click(); }
  document.getElementById("file-upload").addEventListener("change", (e)=>{
    const file=e.target.files && e.target.files[0];
    if(!file) return;
    const r=new FileReader();
    r.onload = (evt)=>{
      pendingImage = evt.target.result;
      document.getElementById("user-input").value = "üì∑ Fotoƒüraf eklendi";
      document.getElementById("user-input").focus();
    };
    r.readAsDataURL(file);
  });

  function setupSwipe(){
    let startX=0;
    const app=document.getElementById("app");
    app.addEventListener("touchstart", e=>{ startX=e.changedTouches[0].screenX; }, {passive:true});
    app.addEventListener("touchend", e=>{
      const endX=e.changedTouches[0].screenX;
      if(Math.abs(startX-endX)<60) return;
      const keys=Object.keys(MODES);
      const i=keys.indexOf(currentMode);
      if(endX<startX) switchMode(keys[(i+1)%keys.length]);
      else switchMode(keys[(i-1+keys.length)%keys.length]);
    }, {passive:true});
  }

  document.getElementById("user-input").addEventListener("keypress",(e)=>{ if(e.key==="Enter") sendMessage(); });

  // ---- Caynana Konu≈üuyor (tarayƒ±cƒ± TTS) ----
  let speakingBtn=null;
  function stopSpeak(){
    if(window.speechSynthesis) window.speechSynthesis.cancel();
    if(speakingBtn){
      speakingBtn.classList.remove("playing");
      speakingBtn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana Konu≈üuyor`;
      speakingBtn=null;
    }
  }

  async function speakToggle(text, btn){
    text = (text||"").trim();
    if(!text) return;

    const same = (speakingBtn===btn && btn.classList.contains("playing"));
    stopSpeak();
    if(same) return;

    speakingBtn=btn;
    btn.classList.add("playing");
    btn.innerHTML = `<i class="fa-solid fa-stop"></i> Sus Kƒ±z!`;

    const u = new SpeechSynthesisUtterance(text);
    u.lang="tr-TR";
    u.rate=1.0;
    u.pitch=1.0;

    u.onend = ()=> stopSpeak();
    u.onerror = ()=> stopSpeak();

    window.speechSynthesis.speak(u);
  }

  document.getElementById("chat-area").addEventListener("click", (e)=>{
    const btn = e.target.closest(".audio-btn");
    if(!btn) return;
    const t = btn.getAttribute("data-speech") || "";
    speakToggle(t, btn);
  });

  // mic
  function startMic(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert("Mikrofon desteƒüi yok."); return; }
    const rec = new SR();
    rec.lang="tr-TR";
    rec.onresult = (e)=>{
      document.getElementById("user-input").value = e.results[0][0].transcript;
      sendMessage();
    };
    rec.start();
  }

  init();
</script>
</body>
</html>
