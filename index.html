<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content" />
  <title>Caynana AI</title>
  <link rel="icon" href="data:," />
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --bg0:#07070a; --bg1:#0b0b12;
      --glass: rgba(22,22,30,.78);
      --glass2: rgba(22,22,30,.92);
      --border: rgba(255,255,255,.12);
      --text:#ececec; --muted:#a9a9b3;
      --primary:#E6C25B;
      --shadow: 0 12px 40px rgba(0,0,0,.55);
      --r: 18px; --r2: 22px;
      --safe: env(safe-area-inset-top, 0px);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{
      margin:0; min-height:100vh; overflow-x:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(230,194,91,.18), transparent 55%),
        radial-gradient(900px 700px at 90% 15%, rgba(145,120,255,.14), transparent 55%),
        radial-gradient(900px 700px at 40% 100%, rgba(129,199,132,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .app{ max-width: 980px; margin:0 auto; padding: calc(14px + var(--safe)) 14px 16px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      position: sticky; top:0; padding: 10px 0 12px; z-index: 30;
      backdrop-filter: blur(12px);
    }
    .brand{ display:flex; align-items:center; gap:10px; user-select:none; }
    .logo{
      width:44px; height:44px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid var(--border); box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .logo::before{
      content:""; position:absolute; inset:-60%;
      background: radial-gradient(circle at 30% 30%, rgba(230,194,91,.45), transparent 55%),
                  radial-gradient(circle at 70% 70%, rgba(145,120,255,.35), transparent 55%);
      transform: rotate(18deg); opacity:.9;
    }
    .eyes{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center; gap:8px; z-index:2;
    }
    .eye{
      width:10px; height:10px; border-radius:999px; background: rgba(255,255,255,.92);
      overflow:hidden; position:relative; transform: translateY(1px);
      animation: blink 5.8s infinite;
    }
    .eye:nth-child(2){ animation-delay:.2s; }
    .pupil{
      width:4px; height:4px; border-radius:999px; background: rgba(0,0,0,.72);
      position:absolute; left:3px; top:3px; animation: look 4.2s ease-in-out infinite;
    }
    @keyframes blink{
      0%, 92%, 100%{ transform: scaleY(1) translateY(1px); }
      94%{ transform: scaleY(.12) translateY(1px); }
      96%{ transform: scaleY(1) translateY(1px); }
    }
    @keyframes look{
      0%, 100%{ transform: translate(0,0); }
      25%{ transform: translate(2px,1px); }
      50%{ transform: translate(-1px,2px); }
      75%{ transform: translate(1px,-1px); }
    }
    .brandTitle{ line-height:1.05; }
    .brandTitle b{ font-size:14px; letter-spacing:.2px; }
    .brandTitle div{ font-size:12px; color:var(--muted); margin-top:2px; }

    .topActions{ display:flex; align-items:center; gap:10px; }
    .iconBtn{
      width:42px; height:42px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      box-shadow: 0 8px 26px rgba(0,0,0,.35);
      cursor:pointer; user-select:none;
    }
    .iconBtn:active{ transform: scale(.98); }
    .iconBtn svg{ width:18px; height:18px; stroke: rgba(255,255,255,.85); fill:none; stroke-width:2; }

    .hero{
      display:flex; gap:14px; padding: 14px;
      border-radius: var(--r2);
      background: var(--glass);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      overflow:hidden; position:relative;
    }
    .hero::after{
      content:""; position:absolute; right:-120px; top:-120px;
      width:280px; height:280px;
      background: radial-gradient(circle, rgba(230,194,91,.18), transparent 60%);
      pointer-events:none;
    }
    .heroLeft{ flex:1; min-width:0; }
    .heroTitle{ font-size:22px; font-weight:900; margin-bottom:6px; }
    .heroDesc{ font-size:13px; color: var(--muted); line-height:1.45; margin-bottom:12px; }
    .heroPills{ display:flex; flex-wrap:wrap; gap:8px; }
    .pill{
      font-size:12px; padding:8px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.85);
      display:flex; align-items:center; gap:8px;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--primary); box-shadow: 0 0 0 6px rgba(230,194,91,.12); }

    .oz-lines{ display:flex; gap:8px; padding: 12px 4px 0; opacity:.9; }
    .oz-lines span{ flex:1; height:5px; border-radius:999px; background: rgba(255,255,255,.08); transition: background .25s ease; }

    .panel{
      margin-top: 12px;
      border-radius: var(--r2);
      border:1px solid var(--border);
      background: var(--glass2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .chatArea{ height: min(54vh, 520px); overflow:auto; padding:12px; scroll-behavior:smooth; }
    .msg-row{ display:flex; margin:10px 0; }
    .msg-row.user{ justify-content:flex-end; }
    .msg-row.bot{ justify-content:flex-start; }
    .msg-bubble{
      max-width:82%; padding:10px 12px; border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      line-height:1.45; font-size:14px;
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
      white-space: pre-wrap; word-break: break-word;
    }
    .msg-bubble.user{ background: linear-gradient(180deg, rgba(230,194,91,.20), rgba(230,194,91,.10)); border-color: rgba(230,194,91,.22); }
    .msg-bubble.bot{ background: rgba(255,255,255,.06); }

    .composer{
      display:flex; gap:10px; padding:12px;
      border-top: 1px solid rgba(255,255,255,.08);
      align-items:flex-end;
    }
    .inp{
      flex:1; min-height:44px; max-height:120px; resize:none;
      border-radius:16px; border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 10px 12px; outline:none; font-size:14px; line-height:1.3;
    }
    .sendBtn{
      width:52px; height:44px; border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(230,194,91,.14);
      cursor:pointer; display:flex; align-items:center; justify-content:center;
      user-select:none;
    }
    .sendBtn:active{ transform: scale(.98); }

    /* Drawer */
    .drawerMask{
      position: fixed; inset:0; background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none; z-index: 80;
    }
    .drawer{
      position:absolute; top:0; right:0;
      width: min(92vw, 360px); height:100%;
      background: linear-gradient(180deg, rgba(22,22,30,.96), rgba(16,16,22,.96));
      border-left: 1px solid rgba(255,255,255,.10);
      box-shadow: -20px 0 60px rgba(0,0,0,.55);
      padding: calc(14px + var(--safe)) 14px 14px;
      display:flex; flex-direction:column; gap:12px;
    }
    .drawerTop{ display:flex; align-items:center; justify-content:space-between; }
    .drawerTitle{ font-weight:900; display:flex; align-items:center; gap:10px; }
    .chip{ font-size:11px; padding: 6px 10px; border-radius:999px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); color: rgba(255,255,255,.85); }

    .profileCard{
      border-radius: 18px; padding:12px; display:flex; gap:10px; align-items:center;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      position:relative; overflow:hidden;
    }
    .profileCard::before{
      content:""; position:absolute; inset:-40%;
      background: radial-gradient(circle at 20% 20%, rgba(230,194,91,.18), transparent 50%),
                  radial-gradient(circle at 80% 40%, rgba(145,120,255,.16), transparent 50%);
      transform: rotate(20deg); opacity:.85; pointer-events:none;
    }
    .avatar{
      width:46px; height:46px; border-radius:16px; object-fit:cover;
      border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06);
      position:relative; z-index:1;
    }
    .pinfo{ position:relative; z-index:1; min-width:0; }
    .pname{ font-weight:900; }
    .pmeta{ color: var(--muted); font-size:12px; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .menuGroup{ display:flex; flex-direction:column; gap:8px; }
    .menuBtn{
      border-radius:16px; padding:11px 12px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer; user-select:none;
      display:flex; align-items:center; justify-content:space-between;
      color: rgba(255,255,255,.92);
    }
    .menuBtn small{ color: var(--muted); font-weight:600; }
    .danger{ background: rgba(255,82,82,.10); border-color: rgba(255,82,82,.20); }
    .danger small{ color: rgba(255,190,190,.9); }

    /* Auth modal */
    .modalMask{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      z-index: 90; background: rgba(0,0,0,.60); backdrop-filter: blur(10px); padding: 18px;
    }
    .modal{
      width:min(92vw, 440px);
      border-radius: 22px;
      background: rgba(22,22,30,.96);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .modalBody{ padding: 14px; }
    .stack{ display:flex; flex-direction:column; gap:10px; }
    .btn{
      border-radius:16px; padding:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.92);
      cursor:pointer; font-weight:900;
      display:flex; align-items:center; justify-content:center;
    }
    .btnLight{ background:#fff; color:#000; }
    .hint{ color: var(--muted); font-size:12px; line-height:1.45; }
    @media (max-width: 520px){
      .msg-bubble{ max-width: 92%; }
    }
  </style>
</head>

<body>
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <div class="eyes">
            <div class="eye"><div class="pupil"></div></div>
            <div class="eye"><div class="pupil"></div></div>
          </div>
        </div>
        <div class="brandTitle">
          <b>CAYNANA</b>
          <div>Yapay Zek√¢nƒ±n Geleneksel Aklƒ±</div>
        </div>
      </div>

      <div class="topActions">
        <div class="iconBtn" id="notifBtn" title="Bildirim">
          <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        </div>

        <div class="iconBtn" id="hambBtn" title="Men√º">
          <svg viewBox="0 0 24 24"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
        </div>
      </div>
    </div>

    <div class="hero">
      <div class="heroLeft">
        <div class="heroTitle">Caynana ile<br>Dertle≈ü.</div>
        <div class="heroDesc">Hadi gel evladƒ±m, anlat bakalƒ±m.</div>
        <div class="heroPills">
          <div class="pill"><span class="dot"></span><span id="whoPill">Misafir modundasƒ±n</span></div>
          <div class="pill">üîí <span id="termsPill">S√∂zle≈üme: ‚Äî</span></div>
        </div>
      </div>
    </div>

    <div class="oz-lines">
      <span style="background:#E6C25B"></span><span style="background:#81C784"></span><span style="background:#CE93D8"></span><span style="background:#7986CB"></span>
    </div>

    <div class="panel">
      <div class="chatArea" id="chatContainer"></div>
      <div class="composer">
        <textarea id="text" class="inp" rows="1" placeholder="Yaz bakalƒ±m evladƒ±m..."></textarea>
        <div class="sendBtn" id="sendBtn" title="G√∂nder">‚û§</div>
      </div>
    </div>

  </div>

  <!-- Drawer -->
  <div class="drawerMask" id="drawerMask">
    <div class="drawer">
      <div class="drawerTop">
        <div class="drawerTitle">Men√º <span class="chip" id="menuChip">‚Äî</span></div>
        <div class="iconBtn" id="drawerClose" title="Kapat">
          <svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18"/></svg>
        </div>
      </div>

      <div class="profileCard">
        <img id="drawerAvatar" class="avatar" src="https://via.placeholder.com/150" alt="avatar" />
        <div class="pinfo">
          <div class="pname" id="drawerName">Misafir</div>
          <div class="pmeta" id="drawerMeta">Giri≈ü yaparsan seni tanƒ±rƒ±m.</div>
        </div>
      </div>

      <div class="menuGroup" id="menuActions"></div>

      <div style="margin-top:auto; color:rgba(255,255,255,.45); font-size:12px; display:flex; justify-content:space-between;">
        <span>¬© CaynanaAI</span><span>O.√ñzyiƒüit</span>
      </div>
    </div>
  </div>

  <!-- Auth modal -->
  <div class="modalMask" id="authModal">
    <div class="modal">
      <div class="modalHead">
        <b>Google ile Giri≈ü</b>
        <div class="iconBtn" id="authCloseX" title="Kapat">
          <svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18"/></svg>
        </div>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="hint">Mobil/PC fark etmez: √∂nce ‚ÄúBaƒülan‚Äù dener, olmazsa alttaki Google butonunu kullan.</div>
          <div class="btn btnLight" id="googleLoginBtn">Google ile Baƒülan</div>
          <div id="googleBtnMount" style="display:flex; justify-content:center;"></div>
          <div id="googleFallbackHint" class="hint" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
import { initAuth, handleLogin, logout, acceptTerms } from './js/auth.js';
import { fetchTextResponse, addUserBubble, typeWriter as typeWriterLib } from './js/chat.js';
import { BASE_DOMAIN, STORAGE_KEY } from './js/config.js';
import { openFalPanel, closeFalPanel, handleFalPhoto } from './js/fal.js';
import { initNotif } from './js/notif.js';

const $ = (id) => document.getElementById(id);
let chatHistory = [], idleTimer = null, isTracking = false;

// auth.js hook'larƒ±
window.enterApp = () => {
  $("loginOverlay")?.classList.remove("active");
};

window.showTermsOverlay = () => {
  const t = $("termsOverlay");
  if (!t) return;
  t.style.display = "flex";
  t.classList.add("active");
};

async function waitForGsi(timeoutMs = 8000){
  const t0 = Date.now();
  while (Date.now() - t0 < timeoutMs){
    if (window.google?.accounts?.id) return true;
    await new Promise(r => setTimeout(r, 50));
  }
  return false;
}
function enableAuthButtons(){
  $("googleLoginBtn")?.classList.remove("disabled");
  $("appleLoginBtn")?.classList.remove("disabled");
  if ($("loginHint")) $("loginHint").textContent = "Devam et evladƒ±m.";
}

// EYES
function setGaze(x, y) {
  const L=$("eyeL"), R=$("eyeR");
  if(!L || !R) return;
  const gx = Math.min(Math.max(x*20, -20), 20);
  const gy = Math.min(Math.max(y*15, -15), 15);
  L.style.setProperty('--gx', gx+'px'); L.style.setProperty('--gy', gy+'px');
  R.style.setProperty('--gx', gx+'px'); R.style.setProperty('--gy', gy+'px');
}
function setLids(top, bot=0) {
  const L=$("eyeL"), R=$("eyeR");
  if(!L || !R) return;
  [L,R].forEach(e=>{
    e.querySelector('.lid-top').style.height = top+'%';
    e.querySelector('.lid-bot').style.height = bot+'%';
  });
}
function autoLook() {
  if($("mobileFrame")?.classList.contains("sleeping") || isTracking) return;
  const rx = (Math.random()-0.5)*1.5, ry = (Math.random()-0.5)*0.5;
  setGaze(rx, ry);
  setTimeout(()=>setGaze(0,0), 1000);
}
function resetIdle() {
  $("mobileFrame")?.classList.remove("sleeping");
  setLids(0,0);
  clearTimeout(idleTimer);
  idleTimer = setTimeout(() => {
    if(!isTracking) {
      $("mobileFrame")?.classList.add("sleeping");
      setLids(60,20);
    }
  }, 30000);
}
window.addEventListener("pointermove", (e) => {
  resetIdle();
  if(isTracking) return;
  const rect = $("mobileFrame")?.getBoundingClientRect();
  if(!rect || rect.width<=0 || rect.height<=0) return;
  const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
  const y = ((e.clientY - rect.top) / rect.height) * 2 - 1;
  setGaze(x,y);
}, { passive:true });

// CHAT
async function doSend(forcedText=null){
  const inputEl = $("msgInput");
  const txt = (forcedText ?? inputEl?.value ?? "").trim();
  if(!txt) return;

  addUserBubble(txt);
  if(inputEl && forcedText==null) inputEl.value = "";
  chatHistory.push({ role: "user", content: txt });

  const holder = document.createElement("div");
  holder.className = "bubble bot loading";
  holder.textContent = "‚Ä¶";
  $("chat")?.appendChild(holder);
  holder.scrollIntoView({behavior:"smooth", block:"end"});

  let reply = "Evladƒ±m bir ≈üeyler ters gitti.";
  try{
    const out = await fetchTextResponse(txt, "chat", chatHistory);
    reply = out?.text || reply;
  }catch(e){}

  try{ holder.remove(); }catch(e){}
  typeWriterLib(reply, "chat");
  chatHistory.push({ role: "assistant", content: reply });
}

// MENU ACTIONS
function handleMenuAction(action){
  $("menuOverlay")?.classList.remove("open");
  if(action==="fal"){ openFalPanel(); return; }
  if(action==="shopping"){ doSend("Alƒ±≈üveri≈ü moduna ge√ßelim: Ne almak istiyorsun?"); return; }
  if(action==="translate"){ doSend("Terc√ºman: Metni yapƒ±≈ütƒ±r, dili s√∂yle (TR/EN/DE/AR vs)."); return; }
  if(action==="diet"){ doSend("Diyet: Bug√ºn hedefin nedir; kilo mu, koruma mƒ±?"); return; }
  if(action==="health"){ doSend("Saƒülƒ±k: Ne ≈üikayetin var evladƒ±m?"); return; }
  if(action==="special"){ doSend("√ñzel G√ºn: Hangi tarihleri hatƒ±rlatayƒ±m?"); return; }
  if(action==="reminder"){ location.href = "pages/hatirlatici.html"; return; }
  if(action==="tarot"){ location.href="pages/tarot.html"; return; }
  if(action==="horoscope"){ location.href="pages/burc.html"; return; }
  if(action==="dream"){ location.href="pages/ruya.html"; return; }
  location.href = `pages/${action}.html`;
}

// ACCOUNT DELETE
async function deleteAccount(){
  const user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  if(!user?.id) return alert("√ñnce giri≈ü yap evladƒ±m.");
  if(!confirm("Hesabƒ±nƒ± silmek istiyor musun?")) return;

  const idToken = (localStorage.getItem("google_id_token") || "").trim();

  try{
    const r = await fetch(`${BASE_DOMAIN}/api/profile/delete`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ user_id: user.id, email: user.email || "", google_id_token: idToken || "" })
    });
    if(r.ok){
      alert("Hesabƒ±n silindi.");
      localStorage.clear();
      location.reload();
      return;
    }
  }catch(e){}

  try{
    const r2 = await fetch(`${BASE_DOMAIN}/api/profile/update`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        user_id: user.id,
        meta: { email: user.email || "", deleted_at: new Date().toISOString() },
        google_id_token: idToken || ""
      })
    });
    if(r2.ok){
      alert("Silme talebin alƒ±ndƒ±.");
      localStorage.clear();
      location.reload();
      return;
    }
  }catch(e){}

  alert("Silme endpoint'i yok/√ßalƒ±≈ümƒ±yor.");
}

document.addEventListener("DOMContentLoaded", async () => {
  resetIdle();
  setInterval(autoLook, 4000);

  // notif ba≈ülat
  try { await initNotif({ baseUrl: BASE_DOMAIN }); } catch(e) {}

  const okGsi = await waitForGsi();
  if(okGsi) enableAuthButtons();
  else if($("loginHint")) $("loginHint").textContent = "Google y√ºklenemedi evladƒ±m (GSI yok).";

  initAuth();

  $("sendBtn")?.addEventListener("click", () => doSend());
  $("msgInput")?.addEventListener("keydown", (e) => {
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); doSend(); }
  });

  $("hambBtn")?.addEventListener("click", () => $("menuOverlay")?.classList.add("open"));
  $("menuOverlay")?.addEventListener("click", (e) => { if(e.target.id==="menuOverlay") $("menuOverlay")?.classList.remove("open"); });

  document.querySelectorAll(".menu-action").forEach(el => {
    el.addEventListener("click", () => handleMenuAction(el.getAttribute("data-action")));
  });

  const camT = () => {
    $("mobileFrame")?.classList.toggle("tracking-active");
    isTracking = !isTracking;
    resetIdle();
  };
  $("camBtn")?.addEventListener("click", camT);
  window.toggleCam = camT;

  $("notifBtn")?.addEventListener("click", () => $("notifDropdown")?.classList.toggle("show"));

  $("googleLoginBtn")?.addEventListener("click", () => handleLogin("google"));
  $("appleLoginBtn")?.addEventListener("click", () => alert("Apple ile giri≈ü yakƒ±nda evladƒ±m."));

  $("termsAcceptBtn")?.addEventListener("click", async () => {
    if(!$("termsCheck")?.checked) return alert("Onayla evladƒ±m.");
    const ok = await acceptTerms();
    if(!ok) return alert("S√∂zle≈üme onayƒ± kaydedilemedi.");
    $("termsOverlay").style.display="none";
    $("termsOverlay").classList.remove("active");
    window.enterApp?.();
  });

  $("logoutBtn")?.addEventListener("click", () => logout());
  $("deleteAccountBtn")?.addEventListener("click", () => deleteAccount());

  // session check
  const user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  if(user && (user.id || user.email)) {
    $("loginOverlay")?.classList.remove("active");
    if(!user.terms_accepted_at) window.showTermsOverlay?.();
  }
});

window.openFal = openFalPanel;
window.closeFal = closeFalPanel;
window.handleFalFile = handleFalPhoto;
</script>
</body>
</html>
