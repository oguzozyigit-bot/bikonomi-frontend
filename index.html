<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Caynana AI v2.0 Final</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  /* --- TEMEL & RENKLER --- */
  :root { --bg: #0e0e0e; --text: #ececec; --gold: #ffb300; --pastel-green: #d9f99d; --card-bg: #1a1a1a; --border-color: #333; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; background: #000; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; color: var(--text); overflow: hidden; height: 100dvh; display:flex; justify-content:center;}
  
  .mobile-frame { width: 100%; max-width: 480px; background: var(--bg); display: flex; flex-direction: column; height: 100%; position: relative; }

  /* --- ÜST BAR (HEADER) --- */
  .topbar { flex: 0 0 60px; background: rgba(14,14,14,0.95); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 3000; }
  .hamb-btn { background: none; border: none; font-size: 24px; color: #aaa; cursor: pointer; padding: 5px; }
  
  .brand-area { display: flex; align-items: center; gap: 8px; justify-content: center; flex: 1; }
  .brand-area img { height: 32px; border-radius: 6px; }
  .brand-name { font-weight: 700; font-size: 16px; color: #fff; }

  .notif-btn { background: none; border: none; position: relative; cursor: pointer; padding: 5px; display: flex; align-items: center; }
  .notif-btn svg { width: 26px; height: 26px; stroke: #aaa; fill: none; stroke-width: 2; transition: 0.2s; }
  .notif-btn:active svg { stroke: var(--pastel-green); }
  .badge { position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; background: #ff5252; border-radius: 50%; display: none; border: 1px solid #000; }

  /* --- GÖZLER (Face Container) --- */
  .face-container { flex: 0 0 160px; background: linear-gradient(to bottom, var(--bg), transparent); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 2000; transition: 0.3s; }
  .face-container.hidden { flex-basis: 0; opacity: 0; overflow: hidden; }

  .eyes-row { display: flex; gap: 24px; margin-bottom: 10px; }
  .eye { width: 80px; height: 55px; position: relative; --lidTop:0%; --lidBot:0%; --gx:0px; --gy:0px; }
  .sclera { width: 100%; height: 100%; background: #e0e0e0; border-radius: 50%; overflow: hidden; position: relative; border: 2px solid #222; box-shadow: inset 0 0 10px rgba(0,0,0,0.8); }
  .iris { width: 28px; height: 28px; background: radial-gradient(circle, #5d4037 0%, #281a16 100%); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(calc(-50% + var(--gx)), calc(-50% + var(--gy))); border: 1px solid rgba(255,255,255,0.25); transition: transform 0.1s linear; }
  .pupil { width: 8px; height: 8px; background: #000; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
  .lid-top, .lid-bot { position: absolute; left: 0; width: 100%; background: var(--bg); z-index: 10; transition: height 0.1s; }
  .lid-top { top: 0; height: var(--lidTop); border-bottom: 2px solid #222; }
  .lid-bot { bottom: 0; height: var(--lidBot); border-top: 2px solid #222; }

  /* --- SOHBET ALANI (DÜZELTİLDİ) --- */
  .chat-area { 
    flex: 1; 
    overflow-y: auto; 
    padding: 20px 16px 100px 16px; 
    display: flex; flex-direction: column; gap: 16px; 
    scroll-behavior: smooth;
    scrollbar-width: none;
  }
  
  .bubble { 
    max-width: 85%; padding: 12px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; 
    position: relative; word-wrap: break-word; flex-shrink: 0; /* Büzüşmeyi engeller */
    animation: pop 0.2s ease;
  }
  .bubble.bot { align-self: flex-start; background: #1c1c1c; border-left: 3px solid var(--gold); color: #ddd; border-top-left-radius: 4px; }
  .bubble.user { align-self: flex-end; background: #222; border-right: 3px solid var(--pastel-green); color: #fff; border-top-right-radius: 4px; text-align: right; }

  /* --- ALT DOCK (GİRİŞ ALANI) --- */
  .input-dock { position: absolute; bottom: 0; width: 100%; background: rgba(14,14,14,0.98); padding: 10px 16px 20px 16px; border-top: 1px solid var(--border-color); z-index: 3000; }
  .dock-inner { display: flex; align-items: flex-end; gap: 10px; background: #1a1a1a; border-radius: 24px; padding: 6px; }
  
  /* İkon butonlar (Kamera vs) */
  .icon-btn { width: 40px; height: 40px; border-radius: 50%; background: transparent; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }
  .icon-btn svg { width: 22px; height: 22px; stroke: #aaa; fill: none; }
  .icon-btn.active svg { stroke: var(--gold); }

  textarea { flex: 1; background: transparent; border: none; outline: none; color: #fff; font-size: 16px; resize: none; padding: 10px; max-height: 100px; font-family: inherit; }
  
  .send-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--pastel-green); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #000; transition: 0.2s; box-shadow: 0 0 10px rgba(217, 249, 157, 0.2); }
  .send-btn:active { transform: scale(0.95); }

  /* --- SOL MENÜ (SIDEBAR) --- */
  .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 5000; transform: translateX(-100%); transition: 0.3s; display: flex; backdrop-filter: blur(5px); }
  .menu-overlay.open { transform: translateX(0); }
  .sidebar { width: 80%; max-width: 280px; background: #161616; height: 100%; display: flex; flex-direction: column; border-right: 1px solid #333; box-shadow: 5px 0 30px #000; }
  
  .new-chat-btn { margin: 20px; padding: 14px; background: #222; color: var(--pastel-green); border: 1px solid #333; border-radius: 12px; cursor: pointer; text-align: center; font-weight: 600; display:flex; align-items:center; justify-content:center; gap:10px;}
  .history-list { flex: 1; overflow-y: auto; padding: 0 20px; }
  .history-item { padding: 15px 0; border-bottom: 1px solid #222; color: #aaa; font-size: 14px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .history-item:hover { color: #fff; }

  /* --- LOGIN EKRANI --- */
  .full-overlay { position: fixed; inset: 0; background: #000; z-index: 6000; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.4s; }
  .full-overlay.active { opacity: 1; pointer-events: auto; }
  .auth-btn { background: #fff; color: #000; padding: 12px 24px; border-radius: 24px; border: none; font-weight: bold; cursor: pointer; }

  #camVideo { display: none; }
  
  @keyframes pop { from{transform:scale(0.9); opacity:0;} to{transform:scale(1); opacity:1;} }
</style>
</head>
<body>

<div class="mobile-frame" id="mobileFrame">
  
  <div class="full-overlay active" id="loginOverlay">
    <div style="font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 20px;">Caynana<span style="color:#d9f99d">.AI</span></div>
    <div id="g_id_onload" 
         data-client_id="SENIN_GOOGLE_CLIENT_ID_BURAYA" 
         data-callback="handleCredentialResponse"
         data-auto_select="true">
    </div>
    <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="filled_black" data-text="signin_with" data-size="large"></div>
    <p style="color:#666; font-size:12px; margin-top:20px;">v2.0 App Only</p>
  </div>

  <div class="topbar">
    <button class="hamb-btn" onclick="toggleMenu()">
        <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
    </button>
    <div class="brand-area">
      <img src="assets/images/caynana-logo.png" alt="Logo">
      <div class="brand-name">Caynana AI</div>
    </div>
    <button class="notif-btn" onclick="openNotifications()">
      <div class="badge" id="notifBadge"></div>
      <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
    </button>
  </div>

  <div class="menu-overlay" id="sideMenu" onclick="if(event.target===this) toggleMenu()">
    <div class="sidebar">
      <div class="new-chat-btn" onclick="location.reload()">
        <span>+</span> Yeni Sohbet
      </div>
      <div class="history-list">
        <div class="history-item">Bugün</div>
        <div class="history-item">Diyet Listem</div>
        <div class="history-item">Maç Sonucu</div>
      </div>
      <div style="margin-top:auto; padding:20px; text-align:center; color:#444; font-size:11px;">@CaynanaAI v2.0</div>
    </div>
  </div>

  <div class="face-container" id="faceContainer">
    <div class="eyes-row">
      <div class="eye" id="eyeL">
        <div class="sclera"><div class="iris"><div class="pupil"></div></div></div>
        <div class="lid-top"></div><div class="lid-bot"></div>
      </div>
      <div class="eye" id="eyeR">
        <div class="sclera"><div class="iris"><div class="pupil"></div></div></div>
        <div class="lid-top"></div><div class="lid-bot"></div>
      </div>
    </div>
  </div>

  <div class="chat-area" id="chat">
    <div class="bubble bot">Hoş geldin evladım. Gözüm üstünde, anlat bakalım.</div>
  </div>

  <div class="input-dock">
    <div class="dock-inner">
      <button class="icon-btn" id="camBtn" onclick="toggleCam()">
        <svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
      </button>
      <textarea id="msgInput" rows="1" placeholder="Ne lazım evladım?"></textarea>
      <button class="send-btn" id="sendBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
      </button>
    </div>
  </div>
</div>

<video id="camVideo" autoplay playsinline muted></video>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script type="module">
  import { initAuth, handleLogin } from './js/auth.js'; // Eski Auth dosyan durmalı!
  import { fetchTextResponse } from './js/chat.js';
  import { BASE_DOMAIN } from './js/config.js';

  window.handleCredentialResponse = handleLogin; 
  window.toggleMenu = () => document.getElementById('sideMenu').classList.toggle('open');
  window.openNotifications = () => alert("Henüz bildirim yok evladım.");

  // --- KAMERA & GÖZ TAKİBİ ---
  let isTracking = true;
  const eyeL = document.getElementById('eyeL'), eyeR = document.getElementById('eyeR');
  
  window.toggleCam = () => {
      isTracking = !isTracking;
      document.getElementById('camBtn').classList.toggle('active');
      document.getElementById('faceContainer').classList.toggle('hidden');
  };

  // Basit Mouse Takibi (Kamera kapalıyken de çalışsın)
  window.addEventListener('pointermove', (e) => {
      if(!isTracking) return;
      const x = (e.clientX / window.innerWidth) * 2 - 1;
      const y = (e.clientY / window.innerHeight) * 2 - 1;
      setGaze(x, y);
  });

  function setGaze(x, y) {
      const gx = Math.min(Math.max(x * 15, -15), 15);
      const gy = Math.min(Math.max(y * 10, -10), 10);
      [eyeL, eyeR].forEach(e => { 
          e.style.setProperty('--gx', gx+'px'); 
          e.style.setProperty('--gy', gy+'px'); 
      });
  }

  // --- MESAJ & SES ---
  const chatDiv = document.getElementById('chat');
  const msgInput = document.getElementById('msgInput');

  async function sendMessage() {
    const txt = msgInput.value.trim();
    if(!txt) return;

    addBubble(txt, 'user');
    msgInput.value = '';

    // Backend'e Sor
    const res = await fetchTextResponse(txt);
    addBubble(res.text, 'bot');
    
    // Konuş
    playVoice(res.text);
  }

  function addBubble(text, type) {
    const b = document.createElement('div');
    b.className = `bubble ${type}`;
    b.innerText = text;
    chatDiv.appendChild(b);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  async function playVoice(text) {
      try {
        const res = await fetch(`${BASE_DOMAIN}/api/speech`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: text })
        });
        const data = await res.json();
        if(data.audio_data) {
            const audio = new Audio("data:audio/mp3;base64," + data.audio_data);
            audio.play();
        }
      } catch(e) { console.error("Ses hatası:", e); }
  }

  document.getElementById('sendBtn').addEventListener('click', sendMessage);
  
  // Başlangıç
  window.onload = () => {
      initAuth(); // Oturumu kontrol et
      // Giriş yapılmışsa overlay kalkar (auth.js hallediyor)
      document.getElementById('loginOverlay').classList.remove('active'); // Test için manuel açtım, auth.js varsa bunu sil.
  };
</script>
</body>
</html>
