<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>Caynana AI</title>
<style>
  :root {
    --bg: #0e0e0e;
    --text: #ececec;
    --gold: #ffb300;
    --pistachio: #bef264;
    --glass: rgba(15, 15, 15, 0.98);
    --border: rgba(255, 255, 255, 0.1);
    --lip-color: #c62828;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  /* N√úKLEER KORUMA: EKRAN Kƒ∞Lƒ∞TLƒ∞ */
  html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    background: var(--bg);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: var(--text);
    overflow: hidden;
    position: fixed; top: 0; left: 0;
  }

  .app-container {
    width: 100%; height: 100%;
    max-width: 480px; margin: 0 auto;
    position: relative;
    display: flex; flex-direction: column;
  }

  /* --- TOPBAR --- */
  .topbar {
    position: absolute; top: 0; left: 0; right: 0;
    height: 75px;
    background: var(--glass);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 16px;
    z-index: 2000;
  }

  .hamb-btn { background: none; border: none; cursor: pointer; padding: 8px; }
  .hamb-icon { display: block; width: 24px; height: 2px; background: #aaa; position: relative; }
  .hamb-icon::before, .hamb-icon::after { content:''; position: absolute; left: 0; width: 24px; height: 2px; background: #aaa; }
  .hamb-icon::before { top: -6px; } .hamb-icon::after { top: 6px; }

  .brand-wrapper { display: flex; flex-direction: column; align-items: center; margin-top: 4px; }
  .logo-area { display: flex; align-items: center; gap: 10px; }
  .brand-name { font-weight: 700; font-size: 16px; letter-spacing: 0.5px; color: #fff; }
  .slogan { font-size: 10px; color: #888; letter-spacing: 0.3px; margin-top: 2px; font-weight: 400; }

  /* SEESAW SVG */
  .seesaw-svg { width: 40px; height: 20px; overflow: visible; }
  .seesaw-bar { transform-origin: 20px 14px; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
  .tilt-left .seesaw-bar { transform: rotate(-15deg); }
  .tilt-right .seesaw-bar { transform: rotate(15deg); }

  /* MENU */
  .menu-overlay {
    position: fixed; inset: 0; z-index: 3000;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
    opacity: 0; pointer-events: none; transition: 0.3s;
  }
  .menu-sidebar {
    position: absolute; top: 0; left: 0; bottom: 0; width: 260px;
    background: #1a1a1a; border-right: 1px solid #333;
    transform: translateX(-100%); transition: 0.3s cubic-bezier(0.19, 1, 0.22, 1);
    padding: 80px 20px 20px; display: flex; flex-direction: column; gap: 15px;
  }
  .menu-overlay.open { opacity: 1; pointer-events: auto; }
  .menu-overlay.open .menu-sidebar { transform: translateX(0); }
  .menu-item { color: #ccc; text-decoration: none; font-size: 16px; padding: 10px; border-bottom: 1px solid #333; }

  /* --- FACE PANEL --- */
  .face-panel {
    position: absolute; top: 75px; left: 0; right: 0; height: 160px; z-index: 1500;
    background: linear-gradient(to bottom, var(--bg) 85%, transparent);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transform: translateY(-120%); opacity: 0; pointer-events: none;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s;
  }
  .app-container.tracking-active .face-panel { transform: translateY(0); opacity: 1; pointer-events: auto; }

  /* UYKU & NEFES */
  .face-panel.sleeping .eyes-row { animation: sleepBreath 3s ease-in-out infinite; }
  .face-panel.sleeping .brow { transform: translateY(10px) rotate(5deg) !important; transition: 1s; }
  .face-panel.sleeping .lid-top { height: 60% !important; border-bottom: 3px solid #111; transition: 1s !important; }
  .face-panel.sleeping .lid-bot { height: 60% !important; border-top: 3px solid #111; transition: 1s !important; }
  @keyframes sleepBreath { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.96) translateY(2px); } }

  /* G√ñZLER */
  .eyes-row { display: flex; gap: 26px; margin-bottom: 14px; transition: 0.3s; }
  .eye { width: 100px; height: 70px; position: relative; --lidTop:0%; --lidBot:0%; --gx:0px; --gy:0px; }
  
  .brow { 
    position: absolute; top: -14px; left: 0; width: 100%; height: 18px; 
    background: #222; border-radius: 99px; transform-origin: center; 
    transition: 0.3s cubic-bezier(0.2, 1.5, 0.5, 1); /* Ka≈ü hareketi esnek */
    box-shadow: 0 4px 8px rgba(0,0,0,0.6); 
  }
  
  .sclera { width: 100%; height: 100%; background: #ddd; border-radius: 50%; overflow: hidden; position: relative; box-shadow: inset 0 0 10px rgba(0,0,0,0.8); border: 2px solid #222; }
  .iris { width: 36px; height: 36px; background: radial-gradient(circle, #5d4037 0%, #281a16 100%); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(calc(-50% + var(--gx)), calc(-50% + var(--gy))); border: 1px solid rgba(255,255,255,0.2); }
  .pupil { width: 12px; height: 12px; background: #000; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
  .reflection { position: absolute; top: 6px; right: 6px; width: 5px; height: 5px; background: #fff; border-radius: 50%; opacity: 0.8; }
  
  /* KAPAKLAR - Daha keskin blink i√ßin transition s√ºresi JS ile oynanacak */
  .lid-top, .lid-bot { position: absolute; left: 0; width: 100%; background: var(--bg); z-index: 10; transition: height 0.08s ease-in-out; }
  .lid-top { top: 0; height: var(--lidTop); border-bottom: 2px solid #222; }
  .lid-bot { bottom: 0; height: var(--lidBot); border-top: 2px solid #222; }

  /* DUYGU MODLARI (CSS) */
  .eye.angry .brow { transform: translateY(8px) rotate(15deg); }
  .eye.angry .lid-top { height: 35% !important; } /* G√∂zleri kƒ±sar */
  
  .eye.shock .brow { transform: translateY(-15px); }
  .eye.shock .iris { transform: scale(0.8) translate(calc(-50% + var(--gx)), calc(-50% + var(--gy))); } /* G√∂z bebekleri k√º√ß√ºl√ºr */
  
  .eye.happy .brow { transform: translateY(-5px); }
  .eye.happy .lid-bot { height: 40% !important; } /* Alttan kƒ±sar (g√ºl√ºmseme) */

  /* DUDAK */
  .mouth-wrapper { width: 50px; height: 26px; display: flex; justify-content: center; align-items: center; position: relative; }
  .mouth { width: 36px; height: 4px; background: var(--lip-color); border-radius: 10px; transition: 0.15s; opacity: 0.8; }
  .face-panel.speaking .mouth { width: 40px; height: 20px; border-radius: 50%; border: 2px solid var(--lip-color); background: #4e1a1a; animation: talkAnim 0.2s infinite alternate; }
  @keyframes talkAnim { 0% { transform: scaleY(0.7); } 100% { transform: scaleY(1.2); } }
  .face-panel.mumbling .mouth { height: 6px; width: 38px; animation: mumbleAnim 0.15s infinite alternate; }
  @keyframes mumbleAnim { 0% { transform: translateX(-1px); } 100% { transform: translateX(1px); } }

  .close-track-btn { margin-top: 12px; background: rgba(198, 40, 40, 0.15); color: #ef9a9a; border: 1px solid rgba(198, 40, 40, 0.4); padding: 6px 16px; border-radius: 20px; font-size: 11px; font-weight: 600; cursor: pointer; transition: 0.2s; }

  /* CHAT */
  .chat-area { flex: 1; overflow-y: auto; padding: 90px 16px 120px 16px; display: flex; flex-direction: column; gap: 16px; transition: padding-top 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
  .app-container.tracking-active .chat-area { padding-top: 240px; }
  .bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.45; animation: pop 0.2s ease; }
  @keyframes pop { from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
  .bubble.bot { align-self: flex-start; background: #1c1c1c; border-left: 3px solid var(--gold); color: #ddd; border-top-left-radius: 4px; }
  .bubble.user { align-self: flex-end; background: #222; border-right: 3px solid var(--pistachio); color: #fff; text-align: right; border-top-right-radius: 4px; }

  /* DOCK */
  .input-dock { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, #0e0e0e 85%, transparent); padding: 10px 16px 30px 16px; z-index: 2000; }
  .main-track-btn { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); background: #1f1f1f; border: 1px solid #444; color: #aaa; font-size: 12px; padding: 8px 18px; border-radius: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.4); transition: 0.2s; }
  .app-container.tracking-active .main-track-btn { display: none; }
  .dock-inner { display: flex; align-items: flex-end; gap: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 26px; padding: 8px 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  .icon-btn { width: 42px; height: 42px; border-radius: 50%; border: none; background: transparent; color: #888; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
  .icon-btn svg { width: 22px; height: 22px; stroke-width: 2; }
  .icon-btn.active { color: var(--gold); background: rgba(255,179,0,0.15); }
  textarea { flex: 1; background: transparent; border: none; outline: none; color: #fff; font-size: 16px; resize: none; padding: 10px 5px; max-height: 120px; min-height: 24px; font-family: inherit; }
  .footer { position: absolute; bottom: 6px; width:100%; text-align: center; font-size: 10px; color: #444; pointer-events: none; z-index: 2100; }
  #camVideo { display: none; }
</style>
</head>
<body>

<div class="app-container" id="appContainer">
  
  <div class="menu-overlay" id="menuOverlay">
    <div class="menu-sidebar">
      <a href="#" class="menu-item">Ayarlar</a>
      <a href="#" class="menu-item">Ge√ßmi≈üi Temizle</a>
      <a href="#" class="menu-item">Hakkƒ±nda</a>
      <a href="#" class="menu-item" style="color:#d32f2f;">√áƒ±kƒ±≈ü</a>
    </div>
  </div>

  <div class="topbar">
    <button class="hamb-btn" id="hambBtn"><span class="hamb-icon"></span></button>
    <div class="brand-wrapper" id="brandWrapper">
      <div class="logo-area">
        <svg class="seesaw-svg" viewBox="0 0 40 20">
          <polygon points="17,14 23,14 20,8" fill="none" stroke="#666" stroke-width="1.5" />
          <g class="seesaw-bar" id="seesawBar">
             <line x1="0" y1="8" x2="40" y2="8" stroke="#ccc" stroke-width="2" stroke-linecap="round" />
             <circle cx="3" cy="5" r="3" fill="#bef264" />
             <circle cx="37" cy="5" r="3" fill="#ffb300" />
          </g>
        </svg>
        <div class="brand-name">Caynana AI</div>
      </div>
      <div class="slogan">Yapay Zek√¢nƒ±n Geleneksel Aklƒ±</div>
    </div>
    <div style="width:24px;"></div>
  </div>

  <div class="face-panel" id="facePanel">
    <div class="eyes-row">
      <div class="eye" id="eyeL">
        <div class="brow"></div>
        <div class="sclera"><div class="iris"><div class="pupil"></div><div class="reflection"></div></div></div>
        <div class="lid-top"></div><div class="lid-bot"></div>
      </div>
      <div class="eye" id="eyeR">
        <div class="brow"></div>
        <div class="sclera"><div class="iris"><div class="pupil"></div><div class="reflection"></div></div></div>
        <div class="lid-top"></div><div class="lid-bot"></div>
      </div>
    </div>
    <div class="mouth-wrapper"><div class="mouth"></div></div>
    <button class="close-track-btn" id="closeTrackBtn">Takibi Kapat</button>
  </div>

  <div class="chat-area" id="chat">
    <div class="bubble bot">G√∂z√ºm √ºzerinde evladƒ±m...</div>
  </div>

  <div class="input-dock">
    <button class="main-track-btn" id="openTrackBtn">üëÅÔ∏è Takip et</button>
    <div class="dock-inner">
      <button class="icon-btn" id="camBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
      </button>
      <textarea id="msgInput" rows="1" placeholder="Mesaj yaz..."></textarea>
      <button class="icon-btn" id="micBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
      </button>
    </div>
  </div>

  <div class="footer">@CaynanAI By Ozyigit's 2026</div>
</div>

<video id="camVideo" autoplay playsinline muted></video>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script>
  const appContainer = document.getElementById('appContainer');
  const facePanel = document.getElementById('facePanel');
  const chat = document.getElementById('chat');
  const msgInput = document.getElementById('msgInput');
  const eyeL = document.getElementById('eyeL');
  const eyeR = document.getElementById('eyeR');
  const brandWrapper = document.getElementById('brandWrapper');
  const menuOverlay = document.getElementById('menuOverlay');
  const hambBtn = document.getElementById('hambBtn');
  
  const openTrackBtn = document.getElementById('openTrackBtn');
  const closeTrackBtn = document.getElementById('closeTrackBtn');
  const camBtn = document.getElementById('camBtn');
  const micBtn = document.getElementById('micBtn');
  const camVideo = document.getElementById('camVideo');

  let isTracking = false;
  let isCameraOn = false;
  let isMicListening = false;
  let faceMesh, camera;
  let idleTimer = null;
  const IDLE_LIMIT = 10000;

  const clamp = (v, min, max) => Math.min(Math.max(v, min), max);
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  const scrollChat = () => chat.scrollTop = chat.scrollHeight;

  // --- UYKU MODU: DOZING OFF ---
  async function dozeSequence() {
    if(!isTracking || isMicListening || facePanel.classList.contains('speaking')) return;
    
    // 1. Aƒüƒ±rla≈ü
    setLids(70, 0); await sleep(1200);
    // 2. ƒ∞rkil (Uyan)
    if(!isTracking) return; // Kullanƒ±cƒ± araya girmi≈ü olabilir
    setLids(10, 0); await sleep(600);
    // 3. Tekrar aƒüƒ±rla≈ü
    if(!isTracking) return;
    setLids(85, 0); await sleep(1500);
    // 4. Uyu
    if(!isTracking) return;
    facePanel.classList.add('sleeping');
  }

  function resetIdle() {
    if (!isTracking) return;
    clearTimeout(idleTimer);

    // Uyuyorsa uyandƒ±r
    if (facePanel.classList.contains('sleeping')) {
      facePanel.classList.remove('sleeping');
      setLids(0, 0);
      setTimeout(blink, 200);
    }
    
    // Timer'ƒ± kur
    idleTimer = setTimeout(dozeSequence, IDLE_LIMIT);
  }

  // Etkile≈üim dinleyicileri
  ['mousemove', 'mousedown', 'keydown', 'touchstart', 'input'].forEach(evt => window.addEventListener(evt, resetIdle));

  hambBtn.addEventListener('click', (e) => { e.stopPropagation(); menuOverlay.classList.toggle('open'); });
  menuOverlay.addEventListener('click', () => menuOverlay.classList.remove('open'));

  // --- G√ñZ FONKSƒ∞YONLARI ---
  function setGaze(x, y) {
    if(facePanel.classList.contains('sleeping')) return;
    const gx = clamp(x * 24, -24, 24);
    const gy = clamp(y * 20, -20, 20);
    [eyeL, eyeR].forEach(e => { e.style.setProperty('--gx', gx+'px'); e.style.setProperty('--gy', gy+'px'); });
  }

  function setLids(top, bot=0) {
    if(facePanel.classList.contains('sleeping')) return;
    [eyeL, eyeR].forEach(e => { e.style.setProperty('--lidTop', top+'%'); e.style.setProperty('--lidBot', bot+'%'); });
  }

  // Her bir g√∂z√º ayrƒ± kontrol etmek i√ßin (Wink i√ßin)
  function setSingleLid(eye, top) {
    if(facePanel.classList.contains('sleeping')) return;
    eye.style.setProperty('--lidTop', top+'%');
  }

  // Daha belirgin blink
  async function blink() { 
    if(facePanel.classList.contains('sleeping')) return;
    setLids(100); 
    await sleep(150); // Biraz daha uzun kapalƒ± kalsƒ±n
    setLids(0); 
  }
  
  // Random blink
  setInterval(() => { if(isTracking && Math.random()<0.08) blink(); }, 2500);

  async function approveNod() {
    if(!isTracking || facePanel.classList.contains('sleeping')) return;
    setGaze(0, 0.8); await sleep(150); setGaze(0, -0.4); await sleep(150); setGaze(0, 0);
  }

  // --- DUYGU ANALƒ∞Zƒ∞ (REAKSƒ∞YON) ---
  function setMood(mood) {
    [eyeL, eyeR].forEach(e => e.classList.remove('angry', 'shock', 'happy'));
    if(mood !== 'normal') {
      [eyeL, eyeR].forEach(e => e.classList.add(mood));
    }
  }

  // --- MOD GE√áƒ∞≈ûƒ∞ ---
  function toggleMode(active) {
    isTracking = active;
    if(active) { 
      appContainer.classList.add('tracking-active'); startCamera(); resetIdle(); 
    } else { 
      appContainer.classList.remove('tracking-active'); stopCamera(); setGaze(0,0); 
      facePanel.classList.remove('sleeping'); clearTimeout(idleTimer);
      setMood('normal');
    }
    setTimeout(scrollChat, 450);
  }
  openTrackBtn.addEventListener('click', () => toggleMode(true));
  closeTrackBtn.addEventListener('click', () => toggleMode(false));

  // --- INPUT / TEXT ---
  msgInput.addEventListener('input', () => {
    resetIdle();
    msgInput.style.height = 'auto';
    msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + 'px';
    brandWrapper.classList.add('tilt-left');
    if(isTracking) {
      const x = Math.sin(msgInput.value.length * 0.15) * 0.5;
      setGaze(x, 0.7);
      facePanel.classList.add('mumbling');
    }
  });

  msgInput.addEventListener('keyup', () => {
    resetIdle();
    setTimeout(() => { facePanel.classList.remove('mumbling'); brandWrapper.classList.remove('tilt-left'); if(isTracking) setGaze(0,0); }, 800);
  });

  msgInput.addEventListener('keydown', async (e) => {
    resetIdle();
    if(e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      const txt = msgInput.value.trim();
      if(!txt) return;
      addBubble(txt, 'user');
      msgInput.value = '';
      msgInput.style.height = 'auto';
      facePanel.classList.remove('mumbling');
      brandWrapper.classList.remove('tilt-left');
      await approveNod();
      setTimeout(() => botReply(txt, false), 600);
    }
  });

  function addBubble(txt, type) {
    const d = document.createElement('div'); d.className = `bubble ${type}`; d.innerText = txt; chat.appendChild(d); scrollChat(); return d;
  }

  async function botReply(userTxt, voiceMode) {
    resetIdle();
    let ans = "Hƒ±mm...";
    let mood = "normal";
    const t = userTxt.toLowerCase();

    // Duygu Analizi
    if(t.includes('aptal') || t.includes('salak') || t.includes('k√∂t√º')) { ans = "Bana mƒ± dedin? Terbiyeni takƒ±n!"; mood = "angry"; }
    else if(t.includes('hahaha') || t.includes('komik') || t.includes('g√ºzel')) { ans = "Ho≈üuna gitti demek, alem adamsƒ±n."; mood = "happy"; }
    else if(t.includes('yuh') || t.includes('≈üok') || t.includes('nasƒ±')) { ans = "Ben de ≈üa≈üƒ±rdƒ±m valla."; mood = "shock"; }
    else if(t.includes('merhaba')) ans = "Sana da merhaba ba≈ükanƒ±m.";
    else ans = "Bunu kaydettim. Ba≈üka?";

    if(isTracking) setMood(mood);

    brandWrapper.classList.add('tilt-right');
    if(voiceMode) speak(ans);

    const b = addBubble('', 'bot');
    for(let c of ans) { b.innerText += c; scrollChat(); await sleep(35); }
    if(!voiceMode) brandWrapper.classList.remove('tilt-right');
    
    // Cevap bitince mood sƒ±fƒ±rla
    setTimeout(() => setMood('normal'), 2000);
  }

  function speak(text) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'tr-TR';
    u.onstart = () => { resetIdle(); facePanel.classList.add('speaking'); };
    u.onend = () => { 
      facePanel.classList.remove('speaking'); brandWrapper.classList.remove('tilt-right'); 
      resetIdle(); 
    };
    window.speechSynthesis.speak(u);
  }

  micBtn.addEventListener('click', () => {
    if(!isTracking) toggleMode(true);
    resetIdle();
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return alert("Mikrofon desteƒüi yok");
    if(isMicListening) return;
    const r = new SR(); r.lang = 'tr-TR';
    micBtn.classList.add('active'); isMicListening = true;
    r.onstart = () => brandWrapper.classList.add('tilt-left');
    r.onresult = async (ev) => { const txt = ev.results[0][0].transcript; addBubble(txt, 'user'); await approveNod(); botReply(txt, true); };
    r.onend = () => { micBtn.classList.remove('active'); isMicListening = false; brandWrapper.classList.remove('tilt-left'); };
    r.start();
  });

  // --- Y√úZ TAKƒ∞Bƒ∞ & WINK ---
  async function startCamera() {
    if(isCameraOn) return;
    faceMesh = new FaceMesh.FaceMesh({locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
    faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true});
    faceMesh.onResults(onFace);
    try {
      camera = new Camera(camVideo, { onFrame: async()=>{ await faceMesh.send({image:camVideo}); }, width:640, height:480 });
      await camera.start(); isCameraOn = true; camBtn.classList.add('active');
    } catch(e) { console.log(e); }
  }
  function stopCamera() { isCameraOn = false; camBtn.classList.remove('active'); }

  // G√∂z a√ßƒ±klƒ±ƒüƒ± hesaplama (Basit vertical distance)
  function getEyeHeight(lm, idxTop, idxBot) {
    const dy = lm[idxTop].y - lm[idxBot].y; // Normalize
    return Math.abs(dy); // Mesafe
  }

  function onFace(res) {
    if(!isTracking || !isCameraOn || facePanel.classList.contains('sleeping')) return;
    
    if(res.multiFaceLandmarks && res.multiFaceLandmarks.length>0) {
      const lm = res.multiFaceLandmarks[0];
      const nose = lm[1];
      
      // Kafa Hareketi
      setGaze(-(nose.x-0.5)*3, (nose.y-0.5)*3);

      // Wink Algƒ±lama
      // Sol G√∂z (Landmarks: 159 top, 145 bot)
      // Saƒü G√∂z (Landmarks: 386 top, 374 bot)
      const leftH = getEyeHeight(lm, 159, 145);
      const rightH = getEyeHeight(lm, 386, 374);
      
      const THRESHOLD = 0.012; // Kapanma e≈üiƒüi (kameraya g√∂re deƒüi≈üebilir)

      // Ayna Mantƒ±ƒüƒ±: Kullanƒ±cƒ± Sol g√∂z√ºn√º kapatƒ±rsa -> Ekranda Saƒü g√∂z (eyeR) kapanmalƒ±
      if (leftH < THRESHOLD && rightH > THRESHOLD) {
        setSingleLid(eyeR, 100); // Kullanƒ±cƒ± Sol kƒ±rptƒ± -> Caynana Saƒü kƒ±rptƒ±
        setSingleLid(eyeL, 0);
      } 
      else if (rightH < THRESHOLD && leftH > THRESHOLD) {
        setSingleLid(eyeL, 100); // Kullanƒ±cƒ± Saƒü kƒ±rptƒ± -> Caynana Sol kƒ±rptƒ±
        setSingleLid(eyeR, 0);
      } 
      else if (leftH < THRESHOLD && rightH < THRESHOLD) {
         // ƒ∞kisi de kapalƒ± (Normal Blink)
         // Blink fonksiyonu zaten random √ßalƒ±≈üƒ±yor, burayƒ± bo≈ü ge√ßebiliriz veya manuel blink tetikleyebiliriz
      }
      else {
        // ƒ∞kisi de a√ßƒ±k
        setLids(0,0);
      }
    }
  }
</script>
</body>
</html>
