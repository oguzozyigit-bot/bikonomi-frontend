<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>CAYNANA.AI – Almadan Önce Sor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { --primary: #10B981; --bg: #ffffff; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #fff; margin: 0; padding: 0; color: #333; }
    
    /* --- ÖZEL KART RENKLERİ --- */
    /* Platinyum: Gri/Gümüş parlak */
    .card-platinyum { background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); border-left: 5px solid #666; }
    .card-platinyum .award-icon { color: #555; background: #fff; }

    /* Altın: Sarı */
    .card-altın { background: linear-gradient(135deg, #fff7e6 0%, #ffecb3 100%); border-left: 5px solid #FFC107; }
    .card-altın .award-icon { color: #d4a002; background: #fff; }

    /* Gümüş */
    .card-gümüş { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-left: 5px solid #bdc3c7; }
    .card-gümüş .award-icon { color: #7f8c8d; background: #fff; }

    /* Bronz */
    .card-bronz { background: linear-gradient(135deg, #fae3d9 0%, #ffcba4 100%); border-left: 5px solid #d35400; }
    .card-bronz .award-icon { color: #d35400; background: #fff; }

    /* Titanyum: Koyu metalik */
    .card-titanyum { background: linear-gradient(135deg, #e0e0e0 0%, #cfd8dc 100%); border-left: 5px solid #455a64; }
    .card-titanyum .award-icon { color: #455a64; background: #fff; }

    /* Zümrüt: Yeşil */
    .card-zümrüt { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 5px solid #2ecc71; }
    .card-zümrüt .award-icon { color: #27ae60; background: #fff; }

    /* Safir: Mavi */
    .card-safir { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 5px solid #2980b9; }
    .card-safir .award-icon { color: #2980b9; background: #fff; }

    /* Yakut: Kırmızı */
    .card-yakut { background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-left: 5px solid #e74c3c; }
    .card-yakut .award-icon { color: #c0392b; background: #fff; }

    /* Elmas: Açık Mavi/Buz */
    .card-elmas { background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border-left: 5px solid #00bcd4; }
    .card-elmas .award-icon { color: #00bcd4; background: #fff; }

    /* Kristal: Beyaz/Mavi */
    .card-kristal { background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-left: 5px solid #9b59b6; }
    .card-kristal .award-icon { color: #8e44ad; background: #fff; }

    /* --- DİĞER CSS --- */
    .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .brand { font-size: 20px; font-weight: 800; color: #333; display: flex; align-items: center; gap: 5px; }
    .brand span { background: var(--primary); color: #fff; padding: 2px 8px; border-radius: 6px; }
    .hero { text-align: center; padding: 20px; }
    .hero h1 { font-size: 26px; margin: 0 0 10px 0; color: #111; }
    .hero h1 span { color: var(--primary); }
    .search-box { position: relative; max-width: 600px; margin: 0 auto; display: flex; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 30px; border: 1px solid #eee; background: #fff; padding: 5px; }
    .search-box input { flex: 1; border: none; outline: none; padding: 12px 15px; font-size: 16px; border-radius: 30px; }
    .search-actions { display: flex; align-items: center; gap: 8px; padding-right: 5px; }
    .icon-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: #f5f5f5; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .search-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--primary); color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    
    .result-area { max-width: 600px; margin: 20px auto; padding: 0 15px; display: none; }
    .result-text { white-space: pre-line; line-height: 1.6; color: #444; margin-bottom: 20px; }
    .voice-btn { display: inline-flex; align-items: center; gap: 8px; background: #f0f0f0; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; color: #333; cursor: pointer; border: none; margin-bottom: 15px; }
    .voice-btn.playing { background: #e0f2f1; color: var(--primary); }
    
    .card { display: flex; align-items: center; padding: 15px; border-radius: 12px; margin-bottom: 12px; text-decoration: none; color: inherit; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
    .card:active { transform: scale(0.98); }
    .award-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0; font-size: 18px; }
    .card-content { flex: 1; }
    .card-badge { font-size: 10px; text-transform: uppercase; font-weight: 800; opacity: 0.7; letter-spacing: 0.5px; margin-bottom: 3px; }
    .card-title { font-size: 15px; font-weight: 700; margin-bottom: 3px; line-height: 1.2; }
    .card-reason { font-size: 12px; color: #666; }
    
    .loader { text-align: center; padding: 40px; display: none; }
    .spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin: 0 auto 10px; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    
    /* Resim Önizleme */
    #imgPreviewBox { text-align: center; margin-top: 10px; display: none; }
    #imgPreviewBox img { height: 100px; border-radius: 8px; border: 1px solid #ddd; }
    #heroImg { width: 100%; max-height: 250px; object-fit: contain; margin-bottom: 15px; display: none; border-radius: 8px; }
  </style>
</head>
<body>

<div class="header">
  <div class="brand"><span>C</span> CAYNANA</div>
  <div style="font-size:12px; color:#999;">v3.1</div>
</div>

<div class="hero">
  <h1>Almadan Önce <br><span>CAYNANA'ya Sor</span></h1>
</div>

<div class="search-box">
  <input type="text" id="q" placeholder="Ürün adı veya link yapıştır..." onkeypress="handleEnter(event)">
  <div class="search-actions">
    <button class="icon-btn" onclick="startVoice()"><i class="fas fa-microphone"></i></button>
    <button class="icon-btn" onclick="document.getElementById('fileInput').click()"><i class="fas fa-camera"></i></button>
    <button class="search-btn" onclick="analyze()"><i class="fas fa-arrow-right"></i></button>
  </div>
</div>
<input type="file" id="fileInput" hidden accept="image/*" onchange="previewImage()">

<div id="imgPreviewBox">
  <img id="previewImg" src="">
  <br>
  <button onclick="clearImage()" style="background:none; border:none; color:red; font-size:12px; cursor:pointer;">Resmi Kaldır</button>
</div>

<div id="loader" class="loader">
  <div class="spinner"></div>
  <div style="color:#888; font-size:14px;">Mağazalar geziliyor evladım...</div>
</div>

<div id="resultArea" class="result-area">
  <img id="heroImg" src="">
  <h2 id="headline" style="font-size:18px; margin-bottom:10px;"></h2>
  
  <button id="speakBtn" class="voice-btn" onclick="toggleSpeak()">
    <i class="fas fa-play-circle"></i> Caynana'yı Konuştur
  </button>
  
  <div id="text" class="result-text"></div>
  <div id="cards"></div>
  
  <a id="waBtn" href="#" target="_blank" style="display:block; text-align:center; background:#25D366; color:white; padding:12px; border-radius:8px; text-decoration:none; font-weight:bold; margin-top:20px;">
    <i class="fab fa-whatsapp"></i> WhatsApp'ta Paylaş
  </a>
  <button onclick="reset()" style="display:block; width:100%; margin-top:10px; background:#f5f5f5; border:none; padding:10px; color:#666; border-radius:8px; cursor:pointer;">Yeni Sorgu</button>
</div>

<script>
  let sessionImg = "";
  let audio = null;
  let audioText = "";

  function handleEnter(e) { if(e.key === 'Enter') analyze(); }

  function previewImage() {
    const file = document.getElementById('fileInput').files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      sessionImg = e.target.result;
      document.getElementById('previewImg').src = sessionImg;
      document.getElementById('imgPreviewBox').style.display = 'block';
    }
    reader.readAsDataURL(file);
  }

  function clearImage() {
    sessionImg = "";
    document.getElementById('fileInput').value = "";
    document.getElementById('imgPreviewBox').style.display = 'none';
  }

  async function analyze() {
    const q = document.getElementById('q').value;
    if(!q && !sessionImg) return alert("Evladım boş boş bakma, bir şey yaz.");
    
    // ARAYÜZÜ TEMİZLE
    const prevQ = q; // Paylaşım için sakla
    document.getElementById('q').value = "";
    clearImage();
    
    document.getElementById('loader').style.display = 'block';
    document.getElementById('resultArea').style.display = 'none';
    if(audio) { audio.pause(); audio = null; }

    try {
      const res = await fetch('/api/analyze', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ q: q, img: sessionImg })
      });
      const data = await res.json();
      
      document.getElementById('headline').innerText = data.headline || "Analiz Sonucu";
      document.getElementById('text').innerText = data.text || "Detay yok.";
      audioText = data.speech_text || "";
      
      if(data.product_img) {
          document.getElementById('heroImg').src = data.product_img;
          document.getElementById('heroImg').style.display = 'block';
      } else {
          document.getElementById('heroImg').style.display = 'none';
      }

      // KARTLARI OLUŞTUR (RENK SORUNU BURADA ÇÖZÜLDÜ)
      const cardsDiv = document.getElementById('cards');
      cardsDiv.innerHTML = "";
      
      if(data.recommendations) {
        data.recommendations.forEach(rec => {
          // Ödül adını al ve CSS uyumlu hale getir (platinyum öneri -> card-platinyum)
          let awardKey = rec.award.toLocaleLowerCase('tr-TR').split(' ')[0]; // Sadece ilk kelimeyi al (Platinyum)
          
          // İkon seçimi
          let icon = "fa-shopping-bag";
          if(rec.site.toLowerCase().includes("amazon")) icon = "fa-amazon";
          
          const html = `
            <a href="${rec.url}" target="_blank" class="card card-${awardKey}">
              <div class="award-icon"><i class="fas ${icon}"></i></div>
              <div class="card-content">
                <div class="card-badge">${rec.award}</div>
                <div class="card-title">${rec.product_name}</div>
                <div class="card-reason">${rec.reason}</div>
              </div>
              <i class="fas fa-chevron-right" style="opacity:0.3"></i>
            </a>
          `;
          cardsDiv.innerHTML += html;
        });
      }
      
      // WhatsApp Linki
      const shareUrl = `https://wa.me/?text=${encodeURIComponent(data.headline + "\n\n" + window.location.origin + "?q=" + prevQ)}`;
      document.getElementById('waBtn').href = shareUrl;

      document.getElementById('loader').style.display = 'none';
      document.getElementById('resultArea').style.display = 'block';
      
    } catch(err) {
      alert("Hata oluştu: " + err);
      document.getElementById('loader').style.display = 'none';
    }
  }

  async function toggleSpeak() {
    if(audio) {
      audio.pause(); audio = null;
      document.getElementById('speakBtn').classList.remove('playing');
      return;
    }
    const btn = document.getElementById('speakBtn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Hazırlanıyor...';
    
    try {
      const res = await fetch('/api/speak', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text: audioText || document.getElementById('text').innerText})
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      audio = new Audio(url);
      audio.onended = () => { 
          audio = null; 
          btn.innerHTML = '<i class="fas fa-play-circle"></i> Caynana\'yı Konuştur';
          btn.classList.remove('playing');
      };
      audio.play();
      btn.innerHTML = '<i class="fas fa-stop"></i> Durdur';
      btn.classList.add('playing');
    } catch(e) {
      alert("Ses hatası");
      btn.innerHTML = '<i class="fas fa-play-circle"></i> Caynana\'yı Konuştur';
    }
  }

  function reset() {
    document.getElementById('resultArea').style.display = 'none';
    document.getElementById('q').value = "";
  }
  
  function startVoice() {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'tr-TR';
    document.getElementById('q').placeholder = "Dinliyorum...";
    recognition.onresult = (event) => {
        document.getElementById('q').value = event.results[0][0].transcript;
        analyze();
    };
    recognition.start();
  }
</script>
</body>
</html>
