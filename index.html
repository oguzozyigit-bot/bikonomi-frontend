<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>CAYNANA.AI ‚Äì Karar Danƒ±≈ümanƒ±m</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://bikonomi-api-1.onrender.com; connect-src 'self' https://bikonomi-api-1.onrender.com; img-src 'self' data: blob: https:; media-src 'self' data: blob: https:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com data:; script-src 'self' 'unsafe-inline';">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#10B981">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root { --bg-body: #F7F9FC; --text-main: #1A1A1A; --primary: #10B981; --border: #E2E8F0; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); display: flex; flex-direction: column; min-height: 100vh; }
    
    /* MODAL */
    #onboardingModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    .modal-title { font-size: 22px; font-weight: 800; margin-bottom: 20px; }
    .gender-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .gender-btn { padding: 12px; border: 2px solid var(--border); border-radius: 12px; background: white; cursor: pointer; }
    .gender-btn.selected { border-color: var(--primary); background: #ECFDF5; color: var(--primary); font-weight: bold; }
    .form-input { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 15px; font-size: 16px; }
    .save-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }

    /* HEADER */
    header { padding: 15px 20px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 10; }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .logo-text { font-weight: 800; font-size: 20px; }
    .header-btn { background: #ECFDF5; border: none; width: 36px; height: 36px; border-radius: 50%; color: var(--primary); cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 5px; }
    .profile-bar { background: #F8FAFC; padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; color: #475569; display: flex; justify-content: space-between; margin-bottom: 10px; }
    
    /* MODES */
    .mode-selector-wrap { overflow-x: auto; scrollbar-width: none; }
    .mode-selector { display: flex; gap: 6px; padding-bottom: 2px; min-width: max-content; }
    .mode-btn { border: 1px solid var(--border); background: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; color: #64748B; cursor: pointer; white-space: nowrap; transition: 0.2s; }
    .mode-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* MAIN */
    main { flex: 1; padding: 20px; width: 100%; max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; }
    .search-container { position: relative; margin-bottom: 15px; margin-top: 20px; }
    .search-bar { display: flex; align-items: center; background: white; border: 2px solid var(--border); border-radius: 16px; padding: 5px; height: 56px; }
    #q { flex: 1; border: none; outline: none; font-size: 16px; padding-left: 10px; }
    .action-btn { width: 44px; height: 44px; border-radius: 12px; border: none; background: transparent; color: #666; cursor: pointer; font-size: 18px; }
    .search-btn { background: var(--primary); color: white; }
    .chips-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 20px; scrollbar-width: none; }
    .chip { background: white; border: 1px solid var(--border); padding: 8px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; }

    /* RESULT */
    .result-box { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .result-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .result-title { font-size: 18px; font-weight: 800; }
    .result-text { font-size: 15px; line-height: 1.6; color: #333; margin-bottom: 15px; }

    /* SCORE */
    .score-container { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .score-gauge { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; background: #eee; }
    .score-verdict { font-weight: 800; font-size: 16px; }

    /* LISTS */
    .list-item { font-size: 13px; margin-bottom: 6px; padding-left: 15px; position: relative; }
    .list-item::before { content: '‚Ä¢'; position: absolute; left: 0; color: var(--primary); font-weight: bold; }

    /* RECS */
    .rec-card { display: flex; align-items: center; background: white; border: 1px solid #eee; border-radius: 12px; padding: 12px; margin-bottom: 10px; text-decoration: none; color: inherit; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .rec-content { flex: 1; margin-left: 10px; }
    .rec-name { font-weight: 700; font-size: 14px; }
    .rec-reason { font-size: 11px; color: #666; }
    .award-badge { font-size: 10px; font-weight: 800; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; }
    .theme-gold { border-left: 4px solid #FFD700; }
    .theme-default { border-left: 4px solid #10B981; }

    /* COACH PLAN CARD */
    .coach-card { background: #F0FDF9; border: 1px solid #CCFBF1; border-radius: 16px; padding: 20px; margin-bottom: 20px; }
    .coach-section { margin-bottom: 15px; }
    .coach-title { font-size: 12px; font-weight: 800; color: #059669; text-transform: uppercase; margin-bottom: 5px; }
    .coach-text { font-size: 14px; line-height: 1.5; color: #064E3B; }
    .boost-box { background: white; border-radius: 12px; padding: 15px; text-align: center; font-weight: 700; color: #059669; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

    /* LOADING */
    #scene-loading { text-align: center; padding-top: 50px; }
    .spinner { width: 40px; height: 40px; border: 4px solid #E5E7EB; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .scene { display: none; }
    .scene.active { display: block; }
    #installBtn { display: none; }
    #imgWrap { display:none; text-align:center; margin-bottom:15px; } #imgPreview { max-height:150px; border-radius:10px; }
    footer { text-align: center; padding: 30px; font-size: 12px; color: #888; background: #F1F5F9; margin-top: auto; }
    .whatsapp-btn { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: #25D366; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
  </style>
</head>
<body>

<div id="onboardingModal" style="display:none;">
    <div class="modal-content">
        <div class="modal-title">Ho≈ü Geldin Evladƒ±m!</div>
        <div class="gender-grid">
            <div class="gender-btn" id="btn-female" onclick="selectGender('female')">üë© Kƒ±zƒ±m</div>
            <div class="gender-btn" id="btn-male" onclick="selectGender('male')">üë® Oƒülum</div>
        </div>
        <input type="text" id="cityInput" class="form-input" placeholder="Hangi ≈ûehir? (√ñrn: ƒ∞stanbul)">
        <button class="save-btn" onclick="saveProfile()">Kaydet ve Ba≈üla</button>
    </div>
</div>

<header>
    <div class="header-top">
        <div class="logo-text" onclick="location.reload()">CAYNANA</div>
        <div class="header-actions">
            <button class="header-btn" onclick="resetAll()"><i class="fa-solid fa-magnifying-glass"></i></button>
            <button class="header-btn" onclick="openProfile()"><i class="fa-solid fa-user"></i></button>
            <button id="installBtn" class="header-btn" onclick="installPWA()"><i class="fa-solid fa-download"></i></button>
        </div>
    </div>
    <div class="profile-bar" id="profileBar" style="display:none;">
        <span id="profileText">-</span>
        <span class="profile-edit" onclick="openProfile()">D√ºzenle</span>
    </div>
    <div class="mode-selector-wrap">
        <div class="mode-selector">
            <button class="mode-btn active" id="mode-shopping" onclick="setMode('shopping')">Alƒ±≈üveri≈ü</button>
            <button class="mode-btn" id="mode-food" onclick="setMode('food')">Yemek</button>
            <button class="mode-btn" id="mode-pharmacy" onclick="setMode('pharmacy')">Eczane</button>
            <button class="mode-btn" id="mode-travel" onclick="setMode('travel')">Tatil</button>
            <button class="mode-btn" id="mode-cinema" onclick="setMode('cinema')">Sinema</button>
            <button class="mode-btn" id="mode-life" onclick="setMode('life')">Ya≈üam</button>
        </div>
    </div>
</header>

<main>
    <section id="scene-home" class="scene active">
        <div class="search-container">
            <div class="hero-title">Karar <span>Danƒ±≈ümanƒ±m</span></div>
            <div class="hero-sub">Alƒ±≈üveri≈ü, mekan, eczane... Kaynanana sor.</div>
            
            <div id="imgWrap">
                <img id="imgPreview" src="">
                <button class="action-btn" onclick="clearImage()">‚úï</button>
            </div>

            <form id="searchForm" onsubmit="event.preventDefault(); start();">
                <div class="search-bar">
                    <button type="button" class="action-btn" onclick="startVoice()"><i class="fa-solid fa-microphone"></i></button>
                    <input id="q" type="text" placeholder="Ne arƒ±yorsun evladƒ±m?" autocomplete="off">
                    <button type="button" class="action-btn" id="camBtn" onclick="triggerFile()"><i class="fa-solid fa-camera"></i></button>
                    <button type="button" class="action-btn search-btn" onclick="start()"><i class="fa-solid fa-arrow-right"></i></button>
                </div>
                <input id="fileInput" type="file" accept="image/*" style="display:none" onchange="handleFile(this.files[0])">
            </form>
            <div class="chips-container" id="chipContainer"></div>
        </div>
    </section>

    <section id="scene-loading" class="scene">
        <div class="loader-box">
            <div class="spinner"></div>
            <h3>Ara≈ütƒ±rƒ±yorum...</h3>
            <p id="loadingSub">Bekle evladƒ±m...</p>
            <button onclick="resetAll()" style="margin-top:20px; border:1px solid #ccc; background:white; padding:5px 10px; border-radius:10px;">ƒ∞ptal</button>
        </div>
    </section>

    <section id="scene-results" class="scene">
        <div class="result-box">
            <div class="result-header">
                <div class="result-title" id="finalHeadline">Sonu√ß</div>
                <button id="btnListen" class="speech-toggle" onclick="toggleSpeech()">Dinle</button>
            </div>
            
            <div id="scoreArea" class="score-container" style="display:none;">
                <div class="score-gauge" id="scoreGauge"><span id="scoreVal"></span></div>
                <div class="score-text-area"><div class="score-verdict" id="scoreVerdict"></div></div>
            </div>

            <div id="finalText" class="result-text"></div>
            
            <div id="listsWrap"></div>

            <div id="coachWrap" class="coach-card" style="display:none;">
                <div class="coach-section">
                    <div class="coach-title">DURUM √ñZETƒ∞</div>
                    <div class="coach-text" id="coachSummary"></div>
                </div>
                <div class="coach-section">
                    <div class="coach-title">KENDƒ∞NE SORMAN GEREKENLER</div>
                    <div id="coachQuestions"></div>
                </div>
                <div class="coach-section">
                    <div class="coach-title">BUG√úNK√ú ADIMIN</div>
                    <div class="coach-text" id="coachToday"></div>
                </div>
                <div class="boost-box" id="coachBoost"></div>
            </div>

            <div id="warnWrap" class="warn-box" style="display:none;"></div>
        </div>

        <h4 id="recTitle" style="margin:20px 0 10px; text-align:center; font-size:12px; color:#666;">√ñNERƒ∞LER</h4>
        <div id="recommendationList"></div>

        <button onclick="resetAll()" style="width:100%; padding:15px; background:white; border:1px solid #ddd; border-radius:12px; margin-top:20px;">Yeni Sorgu</button>
    </section>

    <section id="scene-static" class="scene">
        <div class="result-box">
            <div class="result-header">
                <div class="result-title" id="staticTitle">Bilgi</div>
                <button onclick="showScene('scene-home')" style="border:none; background:#eee; width:30px; height:30px; border-radius:50%;">‚úï</button>
            </div>
            <div id="staticText" class="result-text"></div>
        </div>
    </section>
</main>

<footer>
    <div style="margin-top:10px;">¬© 2026 CAYNANA.AI</div>
</footer>

<a href="https://wa.me/" id="waShareBtn" target="_blank" class="whatsapp-btn"><i class="fa-brands fa-whatsapp"></i></a>

<script>
    const API_BASE = "https://bikonomi-api-1.onrender.com";
    let session = { q: "", img: "", mode: "shopping", gender: "neutral", city: "" };
    let currentAudio = null;
    let audioText = "";
    let deferredPrompt = null;
    let loadingInterval = null;

    const CONTENTS = { "hakkimizda": "<h3>Hakkƒ±mƒ±zda</h3><p>Caynana, yapay zeka destekli bir karar danƒ±≈ümanƒ±dƒ±r.</p>" };

    document.addEventListener('DOMContentLoaded', () => {
        init();
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBtn').style.display = 'flex'; });
    });

    function init() {
        const g = localStorage.getItem("caynana_gender");
        const c = localStorage.getItem("caynana_city");
        if(!g || !c) document.getElementById("onboardingModal").style.display = "flex";
        else { session.gender = g; session.city = c; updateProfileBar(); }
        setMode("shopping");
    }

    let tempGender = "neutral";
    window.selectGender = function(g) {
        tempGender = g;
        document.querySelectorAll(".gender-btn").forEach(b => b.classList.remove("selected"));
        document.getElementById("btn-"+g).classList.add("selected");
    }

    window.saveProfile = function() {
        const city = document.getElementById("cityInput").value.trim();
        if(!city) return alert("≈ûehir yaz evladƒ±m.");
        localStorage.setItem("caynana_gender", tempGender);
        localStorage.setItem("caynana_city", city);
        session.gender = tempGender;
        session.city = city;
        document.getElementById("onboardingModal").style.display = "none";
        updateProfileBar();
    }

    function updateProfileBar() {
        const icon = session.gender === "female" ? "üë©" : (session.gender === "male" ? "üë®" : "üôÇ");
        document.getElementById("profileText").innerText = `${icon} | ${session.city}`;
        document.getElementById("profileBar").style.display = "flex";
    }

    window.openProfile = () => document.getElementById("onboardingModal").style.display = "flex";

    window.setMode = function(mode) {
        session.mode = mode;
        document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));
        document.getElementById("mode-"+mode).classList.add("active");
        
        const q = document.getElementById("q");
        const c = document.getElementById("chipContainer");
        const cam = document.getElementById("camBtn");
        c.innerHTML = "";

        if(mode === "shopping") {
            cam.style.display = "block";
            q.placeholder = "√úr√ºn adƒ± veya linki...";
            addChip("Airfryer √∂nerisi", "fire");
        } else {
            cam.style.display = "none";
            if(mode === "life") {
                q.placeholder = "Derdin ne yavrum?";
                addChip("Bug√ºn motivasyona ihtiyacƒ±m var", "heart");
            } else {
                q.placeholder = "Ne arƒ±yorsun?";
            }
        }
    }

    function addChip(txt, icon) {
        const d = document.createElement("div");
        d.className = "chip";
        d.innerHTML = `<i class="fa-solid fa-${icon}"></i> ${txt}`;
        d.onclick = () => { document.getElementById("q").value = txt; start(); };
        document.getElementById("chipContainer").appendChild(d);
    }

    window.resetAll = function() {
        window.stopSpeech();
        window.clearImage();
        document.getElementById("q").value = "";
        clearInterval(loadingInterval);
        showScene("scene-home");
    }

    window.triggerFile = () => document.getElementById("fileInput").click();
    window.handleFile = (file) => {
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            session.img = e.target.result;
            document.getElementById("imgPreview").src = session.img;
            document.getElementById("imgWrap").style.display = "block";
        };
        reader.readAsDataURL(file);
    }
    window.clearImage = () => {
        session.img = "";
        document.getElementById("fileInput").value = "";
        document.getElementById("imgWrap").style.display = "none";
    }

    window.startVoice = () => {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SR) return alert("Tarayƒ±cƒ± desteklemiyor.");
        const rec = new SR();
        rec.lang = 'tr-TR';
        rec.start();
        document.getElementById("q").placeholder = "Dinliyorum...";
        rec.onresult = (e) => { document.getElementById("q").value = e.results[0][0].transcript; start(); }
    }

    window.openContent = (key) => {
        document.getElementById("staticTitle").textContent = key.toUpperCase();
        document.getElementById("staticText").innerHTML = CONTENTS[key] || "ƒ∞√ßerik yok.";
        showScene("scene-static");
    }

    window.showScene = (id) => {
        document.querySelectorAll(".scene").forEach(s => s.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        window.scrollTo(0,0);
    }

    window.installPWA = async () => {
        if(!deferredPrompt) return;
        deferredPrompt.prompt();
        deferredPrompt = null;
        document.getElementById("installBtn").style.display = "none";
    }

    window.start = async function() {
        const q = document.getElementById("q").value.trim();
        if(!q && !session.img) return alert("Soru sor evladƒ±m.");
        
        showScene("scene-loading");
        const sub = document.getElementById("loadingSub");
        let i=0; const txts=["Arƒ±yorum...","ƒ∞nceliyorum...","Yazƒ±yorum..."];
        loadingInterval = setInterval(()=>{ sub.innerText=txts[i++%3]; }, 800);

        try {
            const res = await fetch(API_BASE + "/api/analyze", {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({...session, q, user: {gender: session.gender, city: session.city}})
            });
            clearInterval(loadingInterval);
            if(!res.ok) throw new Error("Hata olu≈ütu");
            const data = await res.json();
            renderResult(data);
        } catch(e) {
            clearInterval(loadingInterval);
            alert("Baƒülantƒ± hatasƒ±!");
            showScene("scene-home");
        }
    }

    function renderResult(data) {
        audioText = data.speech_text;
        document.getElementById("finalHeadline").innerText = data.headline;
        document.getElementById("finalText").innerText = data.text;
        
        // Reset Views
        document.getElementById("scoreArea").style.display = "none";
        document.getElementById("listsWrap").innerHTML = "";
        document.getElementById("coachWrap").style.display = "none";
        document.getElementById("recommendationList").innerHTML = "";
        document.getElementById("recTitle").style.display = "none";

        // Logic Switch
        if(session.mode === "life" && data.coach_plan) {
            // LIFE MODE
            document.getElementById("coachWrap").style.display = "block";
            document.getElementById("coachSummary").innerText = data.coach_plan.summary || "";
            document.getElementById("coachToday").innerText = data.coach_plan.today_step || "";
            document.getElementById("coachBoost").innerText = data.coach_plan.confidence_boost || "";
            
            const qDiv = document.getElementById("coachQuestions");
            qDiv.innerHTML = "";
            (data.coach_plan.clarifying_questions || []).forEach(q => {
                qDiv.innerHTML += `<div class="list-item">${q}</div>`;
            });

        } else if(session.mode === "shopping") {
            // SHOPPING MODE
            if(data.score && data.score.value > 0) {
                const sArea = document.getElementById("scoreArea");
                sArea.style.display = "flex";
                document.getElementById("scoreVal").innerText = data.score.value;
                document.getElementById("scoreVerdict").innerText = data.score.label;
                document.getElementById("scoreVerdict").style.color = data.score.color;
                document.getElementById("scoreGauge").style.background = `conic-gradient(${data.score.color} ${data.score.value}%, #eee 0)`;
            }
            // Pros/Cons
            const listWrap = document.getElementById("listsWrap");
            if(data.pros) createList(listWrap, "Artƒ±lar", data.pros, "check", "green");
            if(data.cons) createList(listWrap, "Eksiler", data.cons, "xmark", "red");
            
            // Recs
            renderRecs(data.recommendations);

        } else {
            // OTHER MODES (Food, Travel, etc.)
            renderRecs(data.recommendations);
        }

        // Warnings
        const wBox = document.getElementById("warnWrap");
        if(data.chronic_issues && data.chronic_issues.length) {
            wBox.style.display = "block";
            wBox.innerHTML = "‚ö†Ô∏è " + data.chronic_issues.join("<br>");
        } else { wBox.style.display = "none"; }

        const wa = document.getElementById("waShareBtn");
        wa.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(data.headline + " - Caynana")}`;
        
        showScene("scene-results");
    }

    function renderRecs(recs) {
        if(!recs || recs.length === 0) return;
        document.getElementById("recTitle").style.display = "block";
        const list = document.getElementById("recommendationList");
        recs.forEach(r => {
            const a = document.createElement("a");
            a.className = "rec-card theme-default";
            a.href = r.url || "#";
            a.target = "_blank";
            a.innerHTML = `
                <div class="rec-content">
                    <div class="award-badge">${r.award}</div>
                    <div class="rec-name">${r.product_name}</div>
                    <div class="rec-reason">${r.reason}</div>
                </div>
                <div class="rec-arrow"><i class="fa-solid fa-chevron-right"></i></div>
            `;
            list.appendChild(a);
        });
    }

    function createList(parent, title, arr, icon, color) {
        if(!arr || arr.length===0) return;
        const d = document.createElement("div");
        d.innerHTML = `<div style="font-weight:700; color:${color}; margin:10px 0 5px;"><i class="fa-solid fa-${icon}"></i> ${title}</div>`;
        arr.forEach(i => { d.innerHTML += `<div class="list-item">${i}</div>`; });
        parent.appendChild(d);
    }

    window.stopSpeech = () => {
        if(currentAudio) { currentAudio.pause(); currentAudio=null; }
        document.getElementById("btnListen").classList.remove("active");
    }

    window.toggleSpeech = async () => {
        const btn = document.getElementById("btnListen");
        if(currentAudio) return window.stopSpeech();
        if(!audioText) return;
        
        btn.classList.add("active");
        try {
            const res = await fetch(API_BASE + "/api/speak", {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({text: audioText})
            });
            const blob = await res.blob();
            currentAudio = new Audio(URL.createObjectURL(blob));
            currentAudio.onended = window.stopSpeech;
            currentAudio.play();
        } catch(e) { window.stopSpeech(); }
    }
</script>
</body>
</html>
