<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>Caynana AI</title>
<style>
  :root {
    --bg: #0e0e0e;
    --panel: #181818;
    --text: #ececec;
    --gold: #ffb300;
    --pistachio: #bef264; /* Fƒ±stƒ±k Ye≈üili */
    --glass: rgba(20, 20, 20, 0.85); /* Biraz daha koyu blur */
    --border: rgba(255, 255, 255, 0.08);
    --lip-color: #d84315; /* Hafif kiremit rengi */
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body, html {
    margin: 0; padding: 0;
    height: 100%;
    background: var(--bg);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: var(--text);
    overflow: hidden;
  }

  /* --- ANA KAP --- */
  .app-container {
    width: 100%; height: 100%;
    max-width: 480px;
    margin: 0 auto;
    position: relative;
    display: flex;
    flex-direction: column;
    background: var(--bg);
  }

  /* --- TOPBAR --- */
  .topbar {
    position: absolute; top: 0; left: 0; right: 0;
    height: 60px;
    background: var(--glass);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    z-index: 1100; /* En √ºstte */
  }
  .hamb { font-size: 24px; cursor: pointer; color: #aaa; background:none; border:none; }
  .brand { font-weight: 700; font-size: 16px; letter-spacing: 0.5px; color: #fff; }
  .status-dot { width: 8px; height: 8px; background: var(--gold); border-radius: 50%; box-shadow: 0 0 8px var(--gold); }

  /* --- EYES & MOUTH WRAPPER (Sabit Panel) --- */
  .face-panel {
    position: absolute;
    top: 60px; /* Topbar altƒ± */
    left: 0; right: 0;
    height: 180px; /* G√∂zler + Dudak i√ßin yer */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    background: linear-gradient(to bottom, var(--bg) 80%, transparent); /* Alt kƒ±sƒ±m yumu≈üak ge√ßi≈ü */
    
    /* Animasyonlar */
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
    
    /* Varsayƒ±lan: Gƒ∞ZLƒ∞ (Yukarƒ±da) */
    transform: translateY(-100%);
    opacity: 0;
    pointer-events: none;
  }

  /* Tracking Aktifken Face Panel G√∂r√ºn√ºr */
  .app-container.tracking-active .face-panel {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
  }

  .eyes-row {
    display: flex;
    justify-content: center;
    gap: 24px;
    margin-bottom: 20px;
  }

  /* --- EYE CSS --- */
  .eye {
    width: 110px; height: 80px;
    position: relative;
    --lidTop: 0%; --lidBot: 0%; 
    --gx: 0px; --gy: 0px;
  }
  
  .brow {
    position: absolute; top: -12px; left: 5%; width: 90%; height: 18px;
    background: #222; border-radius: 10px;
    transform-origin: center; transition: 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
  }
  .sclera {
    width: 100%; height: 100%;
    background: #e0e0e0;
    border-radius: 50%;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 0 12px rgba(0,0,0,0.9);
    border: 2px solid #2a2a2a;
  }
  .iris {
    width: 40px; height: 40px;
    background: radial-gradient(circle, #5d4037 0%, #3e2723 100%);
    border-radius: 50%;
    position: absolute; top: 50%; left: 50%;
    transform: translate(calc(-50% + var(--gx)), calc(-50% + var(--gy)));
    border: 1px solid rgba(255,255,255,0.15);
  }
  .pupil {
    width: 14px; height: 14px; background: #000; border-radius: 50%;
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  }
  .reflection {
    position: absolute; top: 6px; right: 6px;
    width: 6px; height: 6px; background: rgba(255,255,255,0.9);
    border-radius: 50%; filter: blur(0.5px);
  }
  
  .lid-top, .lid-bot {
    position: absolute; left: 0; width: 100%; background: var(--bg); z-index: 10;
    transition: height 0.08s ease-out;
  }
  .lid-top { top: 0; height: var(--lidTop); border-bottom: 2px solid #222; }
  .lid-bot { bottom: 0; height: var(--lidBot); border-top: 2px solid #222; }

  /* --- MOUTH (DUDAK) CSS --- */
  .mouth-wrapper {
    width: 60px; height: 24px;
    position: relative;
    display: flex; justify-content: center; align-items: center;
  }
  .mouth {
    width: 100%; height: 100%;
    background: transparent;
    border-bottom: 3px solid #7d5a5a; /* Kapalƒ±yken √ßizgi */
    border-radius: 50%;
    transition: 0.2s;
    opacity: 0.7;
  }
  
  /* Konu≈üurken Dudak Hareketi */
  .face-panel.speaking .mouth {
    border-bottom: none;
    background: #5a3a3a; /* Aƒüƒ±z i√ßi */
    height: 18px; width: 40px;
    border-radius: 50%;
    animation: talkAnim 0.18s infinite alternate;
    box-shadow: inset 0 -4px 0 #3e2723; /* Dil efekti */
  }

  @keyframes talkAnim {
    0% { height: 10px; width: 45px; transform: scaleY(0.8); }
    100% { height: 24px; width: 38px; transform: scaleY(1.1); }
  }

  /* Takip Kapat Butonu (Y√ºz√ºn altƒ±nda) */
  .track-toggle-mini {
    margin-top: 15px;
    background: rgba(255,255,255,0.06);
    color: #888; border: none;
    padding: 6px 12px; border-radius: 20px;
    font-size: 11px; cursor: pointer;
    transition: 0.2s;
  }
  .track-toggle-mini:hover { color: #fff; background: rgba(255,255,255,0.1); }

  /* --- CHAT AREA --- */
  .chat-area {
    flex: 1;
    overflow-y: auto;
    padding-left: 16px; padding-right: 16px; padding-bottom: 100px;
    
    /* Kritik Ge√ßi≈ü */
    padding-top: 80px; /* Varsayƒ±lan: Topbar (60) + Bo≈üluk (20) */
    transition: padding-top 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    
    display: flex; flex-direction: column; gap: 16px;
    scroll-behavior: smooth;
  }
  
  /* Tracking Aktifken Chat A≈üaƒüƒ± ƒ∞ner */
  .app-container.tracking-active .chat-area {
    padding-top: 250px; /* Topbar (60) + FacePanel (180) + Bo≈üluk (10) */
  }

  .bubble {
    max-width: 86%;
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 15px; line-height: 1.45;
    position: relative;
    animation: pop 0.2s ease;
  }
  @keyframes pop { from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}

  .bubble.bot {
    align-self: flex-start;
    background: #1c1c1c;
    border-left: 3px solid var(--gold);
    border-top-left-radius: 4px; color: #ddd;
  }
  
  .bubble.user {
    align-self: flex-end;
    background: #252525;
    border-right: 3px solid var(--pistachio);
    border-top-right-radius: 4px; color: #fff;
    text-align: right;
  }

  /* --- INPUT DOCK --- */
  .input-dock {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: linear-gradient(to top, #0e0e0e 90%, transparent);
    padding: 10px 16px 30px 16px;
    z-index: 1200;
  }

  /* Ana Takip A√ßma Butonu (G√∂zler yokken) */
  .main-track-btn {
    position: absolute; top: -45px; left: 50%; transform: translateX(-50%);
    background: rgba(30,30,30,0.9);
    border: 1px solid #444; color: #aaa;
    font-size: 13px; padding: 8px 16px; border-radius: 20px;
    cursor: pointer; backdrop-filter: blur(4px);
    transition: 0.2s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }
  /* Takip a√ßƒ±ksa bu buton gizlensin */
  .app-container.tracking-active .main-track-btn {
    display: none;
  }

  .dock-inner {
    display: flex; align-items: flex-end; gap: 10px;
    background: #1e1e1e; border: 1px solid #333;
    border-radius: 24px; padding: 8px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.4);
  }

  .dock-btn {
    width: 40px; height: 40px; border-radius: 50%; border: none;
    background: transparent; color: #999; font-size: 20px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: 0.2s;
  }
  .dock-btn.active { color: var(--gold); background: rgba(255,179,0,0.15); }
  
  textarea {
    flex: 1; background: transparent; border: none; outline: none;
    color: #fff; font-size: 16px; resize: none; padding: 10px 5px;
    max-height: 120px; min-height: 24px; font-family: inherit;
  }

  .footer {
    position: absolute; bottom: 5px; left: 0; right: 0;
    text-align: center; font-size: 10px; color: #444; pointer-events: none; z-index: 1201;
  }
  
  #camVideo { display: none; }
</style>
</head>
<body>

<div class="app-container" id="appContainer">
  <div class="topbar">
    <button class="hamb">‚ò∞</button>
    <div class="brand">Caynana AI</div>
    <div class="status-dot"></div>
  </div>

  <div class="face-panel" id="facePanel">
    <div class="eyes-row">
      <div class="eye" id="eyeL">
        <div class="brow"></div>
        <div class="sclera">
          <div class="iris"><div class="pupil"></div><div class="reflection"></div></div>
        </div>
        <div class="lid-top"></div><div class="lid-bot"></div>
      </div>
      <div class="eye" id="eyeR">
        <div class="brow"></div>
        <div class="sclera">
          <div class="iris"><div class="pupil"></div><div class="reflection"></div></div>
        </div>
        <div class="lid-top"></div><div class="lid-bot"></div>
      </div>
    </div>
    
    <div class="mouth-wrapper">
      <div class="mouth"></div>
    </div>

    <button class="track-toggle-mini" id="closeTrackBtn">Takibi Kapat</button>
  </div>

  <div class="chat-area" id="chat">
    <div class="bubble bot">G√∂z√ºm √ºzerinde... Anlat bakalƒ±m derdin ne?</div>
  </div>

  <div class="input-dock">
    <button class="main-track-btn" id="openTrackBtn">üëÅÔ∏è Takip et</button>
    
    <div class="dock-inner">
      <button class="dock-btn" id="camBtn">üì∑</button>
      <textarea id="msgInput" rows="1" placeholder="Mesaj yaz..."></textarea>
      <button class="dock-btn" id="micBtn">üéôÔ∏è</button>
    </div>
  </div>

  <div class="footer">@CaynanAI By Ozyigit's 2026</div>
</div>

<video id="camVideo" autoplay playsinline muted></video>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script>
  // DOM
  const appContainer = document.getElementById('appContainer');
  const facePanel = document.getElementById('facePanel');
  const chat = document.getElementById('chat');
  const msgInput = document.getElementById('msgInput');
  const eyeL = document.getElementById('eyeL');
  const eyeR = document.getElementById('eyeR');
  
  const openTrackBtn = document.getElementById('openTrackBtn');
  const closeTrackBtn = document.getElementById('closeTrackBtn');
  const camBtn = document.getElementById('camBtn');
  const micBtn = document.getElementById('micBtn');
  const camVideo = document.getElementById('camVideo');

  // State
  let isTracking = false;
  let isCameraOn = false;
  let isMicListening = false;
  let faceMesh, camera;

  // Helpers
  const clamp = (v, min, max) => Math.min(Math.max(v, min), max);
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  const scrollChat = () => chat.scrollTop = chat.scrollHeight;

  // --- G√ñZ FONKSƒ∞YONLARI ---
  function setGaze(x, y) {
    const gx = clamp(x * 22, -22, 22);
    const gy = clamp(y * 18, -18, 18);
    [eyeL, eyeR].forEach(e => {
      e.style.setProperty('--gx', gx+'px');
      e.style.setProperty('--gy', gy+'px');
    });
  }

  function setLids(top, bot=0) {
    [eyeL, eyeR].forEach(e => {
      e.style.setProperty('--lidTop', top+'%');
      e.style.setProperty('--lidBot', bot+'%');
    });
  }

  async function blink() {
    setLids(100); await sleep(120); setLids(0);
  }
  
  // Random blink
  setInterval(() => { if(isTracking && Math.random()<0.08) blink(); }, 2500);

  async function approveNod() {
    if(!isTracking) return;
    setGaze(0, 0.9); await sleep(150);
    setGaze(0, -0.2); await sleep(150);
    setGaze(0, 0);
  }

  // --- MOD GE√áƒ∞≈ûLERƒ∞ (Layout Deƒüi≈üimi) ---
  function toggleMode(active) {
    isTracking = active;
    if(active) {
      appContainer.classList.add('tracking-active');
      startCamera(); // Otomatik kamera a√ß (isteƒüe baƒülƒ±)
    } else {
      appContainer.classList.remove('tracking-active');
      stopCamera();
      setGaze(0,0);
    }
    // Chat en alta kaysƒ±n deƒüi≈üimde
    setTimeout(scrollChat, 450);
  }

  openTrackBtn.addEventListener('click', () => toggleMode(true));
  closeTrackBtn.addEventListener('click', () => toggleMode(false));

  // --- MESAJLA≈ûMA ---
  function addBubble(txt, type) {
    const d = document.createElement('div');
    d.className = `bubble ${type}`;
    d.innerText = txt;
    chat.appendChild(d);
    scrollChat();
    return d;
  }

  msgInput.addEventListener('input', () => {
    msgInput.style.height = 'auto';
    msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + 'px';
    // Okuma efekti
    if(isTracking) {
      const x = Math.sin(msgInput.value.length * 0.15) * 0.4;
      setGaze(x, 0.7);
    }
  });

  msgInput.addEventListener('keydown', async (e) => {
    if(e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      const txt = msgInput.value.trim();
      if(!txt) return;
      addBubble(txt, 'user');
      msgInput.value = '';
      msgInput.style.height = 'auto';
      await approveNod();
      setTimeout(() => botReply(txt, false), 600);
    }
  });

  async function botReply(userTxt, voiceMode) {
    // Basit mantƒ±k
    let ans = "Hƒ±mm, anladƒ±m.";
    const t = userTxt.toLowerCase();
    if(t.includes('merhaba')) ans = "Sana da merhaba ba≈ükanƒ±m.";
    else if(t.includes('g√ºzel')) ans = "Tabii g√ºzel, ben yaptƒ±m.";
    else if(t.includes('takip')) ans = "G√∂z√ºm hep √ºzerinde merak etme.";
    else ans = "Bu dediƒüini not aldƒ±m. Ba≈üka?";

    // Konu≈üma Modu (Dudak + Ses)
    if(voiceMode) {
      speak(ans);
    }

    // Yazƒ± efekti
    const b = addBubble('', 'bot');
    for(let c of ans) {
      b.innerText += c;
      scrollChat();
      await sleep(35);
    }
  }

  // --- TTS & DUDAK SENKRONU ---
  function speak(text) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'tr-TR';
    
    // Konu≈üurken class ekle -> CSS animasyonu ba≈ülar
    u.onstart = () => {
      facePanel.classList.add('speaking');
      if(isTracking) setMood('happy'); // Konu≈üurken hafif mutlu
    };
    
    u.onend = () => {
      facePanel.classList.remove('speaking');
      if(isTracking) setMood('normal');
    };
    
    window.speechSynthesis.speak(u);
  }

  function setMood(m) {
    if(m==='happy') setLids(0, 40); // Alt kapak kƒ±sƒ±k
    else setLids(0,0);
  }

  // --- Mƒ∞KROFON ---
  micBtn.addEventListener('click', () => {
    if(!isTracking) toggleMode(true); // Mikrofon basƒ±nca y√ºz gelsin
    
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return alert("Ses desteƒüi yok");
    
    if(isMicListening) return;
    
    const r = new SR();
    r.lang = 'tr-TR';
    
    micBtn.classList.add('active');
    isMicListening = true;
    
    r.onresult = async (ev) => {
      const txt = ev.results[0][0].transcript;
      addBubble(txt, 'user');
      await approveNod();
      botReply(txt, true); // Sesli yanƒ±t
    };
    
    r.onend = () => {
      micBtn.classList.remove('active');
      isMicListening = false;
    };
    r.start();
  });

  // --- KAMERA / TOUCH ---
  document.addEventListener('pointermove', (e) => {
    if(!isTracking || isCameraOn) return;
    const x = (e.clientX / window.innerWidth)*2 - 1;
    const y = (e.clientY / window.innerHeight)*2 - 1;
    setGaze(x, y);
  });

  async function startCamera() {
    if(isCameraOn) return;
    if(!faceMesh) {
      faceMesh = new FaceMesh.FaceMesh({locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
      faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true});
      faceMesh.onResults(onFace);
    }
    try {
      camera = new Camera(camVideo, {
        onFrame: async()=>{ await faceMesh.send({image:camVideo}); },
        width:640, height:480
      });
      await camera.start();
      isCameraOn = true;
      camBtn.classList.add('active');
    } catch(e) { console.log(e); }
  }

  function stopCamera() {
    isCameraOn = false;
    camBtn.classList.remove('active');
    // camera.stop() her zaman stabil deƒüil, flag yeterli.
  }

  camBtn.addEventListener('click', () => {
    if(!isTracking) toggleMode(true);
    if(isCameraOn) stopCamera(); else startCamera();
  });

  function onFace(res) {
    if(!isTracking || !isCameraOn) return;
    if(res.multiFaceLandmarks && res.multiFaceLandmarks.length>0) {
      const lm = res.multiFaceLandmarks[0];
      const nose = lm[1];
      // Mirror effect (-x)
      setGaze(-(nose.x-0.5)*3, (nose.y-0.5)*3);
    }
  }

</script>
</body>
</html>
