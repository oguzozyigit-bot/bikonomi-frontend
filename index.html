<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>CAYNANA.AI ‚Äì Karar Danƒ±≈ümanƒ±m</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <meta http-equiv="Content-Security-Policy"
        content="default-src * data: blob: 'unsafe-inline' 'unsafe-eval';
                 script-src * data: blob: 'unsafe-inline' 'unsafe-eval';
                 connect-src * data: blob:;
                 img-src * data: blob:;
                 media-src * data: blob:;
                 frame-src * data: blob:;">

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#10B981">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/9386/9386895.png">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg-body:#F8FAFC;
      --text-main:#0f172a;
      --text-muted:#64748b;

      --primary:#10B981;
      --primary-dark:#059669;

      --border:#E2E8F0;

      --good:#10B981;
      --warn:#F59E0B;
      --bad:#EF4444;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0;
      font-family:'Inter',sans-serif;
      background:var(--bg-body);
      color:var(--text-main);
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /* --- ONBOARDING MODAL --- */
    #onboardingModal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.92);
      z-index:9999;
      display:none;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(6px);
      padding:16px;
    }
    .modal-content{
      background:#fff;
      width:min(420px,100%);
      padding:22px;
      border-radius:22px;
      text-align:center;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    .modal-title{font-size:20px;font-weight:900;margin:0 0 6px;color:#0b1220}
    .modal-sub{font-size:13px;color:#64748b;margin:0 0 18px;line-height:1.45}
    .form-group{margin-bottom:14px;text-align:left}
    .form-label{font-size:12px;font-weight:800;color:#475569;margin-bottom:6px;display:block}
    .form-input{
      width:100%;
      padding:12px;
      border:2px solid var(--border);
      border-radius:14px;
      font-size:15px;
      outline:none;
      background:#fff;
    }
    .form-input:focus{border-color:var(--primary)}
    .gender-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .gender-btn{
      padding:12px;
      border:2px solid var(--border);
      border-radius:14px;
      background:#fff;
      font-size:13px;
      font-weight:800;
      cursor:pointer;
      color:#64748b;
      user-select:none;
    }
    .gender-btn.selected{
      border-color:var(--primary);
      background:#ECFDF5;
      color:var(--primary);
    }
    .save-btn{
      width:100%;
      padding:14px;
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:14px;
      font-size:15px;
      font-weight:900;
      cursor:pointer;
      margin-top:6px;
    }

    /* --- HEADER --- */
    header{
      position:sticky; top:0; z-index:10;
      padding:14px 16px 10px;
      background:rgba(255,255,255,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid #EEF2F7;
    }
    .header-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      max-width:920px;
      margin:0 auto;
    }
    .logo-container{
      display:flex; align-items:center; gap:10px;
      cursor:pointer; user-select:none;
    }
    .logo-icon{
      width:32px; height:32px;
      border-radius:10px;
      background:var(--primary);
      color:#fff;
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      box-shadow:0 6px 20px rgba(16,185,129,.20);
    }
    .logo-text{
      font-weight:900;
      letter-spacing:-.4px;
      color:#0b1220;
      font-size:16px;
    }
    .header-actions{display:flex; gap:8px}
    .header-btn{
      width:34px; height:34px;
      border-radius:999px;
      border:1px solid #E6F6EF;
      background:#ECFDF5;
      color:var(--primary);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition:.15s;
    }
    .header-btn:hover{transform:translateY(-1px)}

    .profile-bar{
      max-width:920px;
      margin:10px auto 0;
      display:none;
      justify-content:space-between;
      align-items:center;
      padding:8px 10px;
      border-radius:14px;
      background:#F8FAFC;
      border:1px solid #E2E8F0;
      font-size:12px;
      color:#475569;
      font-weight:800;
    }
    .profile-edit{color:var(--primary);cursor:pointer;text-decoration:underline}

    /* --- MODE SELECTOR (PILL TABS) --- */
    .mode-selector-wrap{
      max-width:920px;
      margin:10px auto 0;
      overflow-x:auto;
      -ms-overflow-style:none;
      scrollbar-width:none;
    }
    .mode-selector-wrap::-webkit-scrollbar{display:none}
    .mode-selector{
      display:flex;
      justify-content:center;
      gap:8px;
      min-width:max-content;
      padding-bottom:2px;
    }
    .mode-btn{
      border:1px solid var(--border);
      background:#fff;
      padding:7px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      color:#64748b;
      cursor:pointer;
      transition:.15s;
      white-space:nowrap;
    }
    .mode-btn.active{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
      box-shadow:0 10px 30px rgba(16,185,129,.16);
    }

    /* --- MAIN --- */
    main{
      flex:1;
      padding:22px 16px;
      width:100%;
      max-width:920px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
    }

    .scene{display:none}
    .scene.active{display:block}

    /* HOME = FULL CENTER */
    #scene-home{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      min-height:calc(100vh - 190px);
    }
    .hero-title{
      text-align:center;
      font-size:34px;
      font-weight:900;
      line-height:1.05;
      margin:0 0 10px;
      color:#0b1220;
      letter-spacing:-.8px;
    }
    .hero-title span{color:var(--primary)}
    .hero-sub{
      text-align:center;
      color:var(--text-muted);
      font-size:13px;
      margin:0 0 22px;
      line-height:1.55;
      max-width:520px;
    }

    .search-container{
      width:min(720px,100%);
      margin:0 auto 10px;
    }
    .search-bar{
      display:flex;
      align-items:center;
      background:#fff;
      border:1px solid #E8EEF6;
      border-radius:999px;
      padding:6px;
      height:52px;
      box-shadow:0 14px 40px rgba(15,23,42,.06);
    }
    #q{
      flex:1;
      border:none;
      outline:none;
      font-size:15px;
      height:100%;
      background:transparent;
      padding:0 10px;
      color:#0f172a;
    }
    #q::placeholder{color:#94a3b8;font-weight:600}

    .action-btn{
      width:40px;
      height:40px;
      border-radius:999px;
      border:none;
      background:transparent;
      color:#64748b;
      font-size:16px;
      cursor:pointer;
      transition:.15s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .action-btn:hover{background:#F8FAFC}
    .search-btn{
      width:42px;height:42px;
      background:var(--primary);
      color:#fff;
      box-shadow:0 12px 30px rgba(16,185,129,.22);
    }
    .search-btn:hover{background:var(--primary-dark)}

    .chips-container{
      display:flex;
      justify-content:center;
      gap:10px;
      overflow-x:auto;
      padding:8px 0 0;
      scrollbar-width:none;
      width:min(720px,100%);
      margin:0 auto;
    }
    .chips-container::-webkit-scrollbar{display:none}
    .chip{
      background:#fff;
      border:1px solid #E8EEF6;
      padding:7px 12px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      color:#475569;
      white-space:nowrap;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(15,23,42,.04);
    }
    .chip i{color:var(--primary); margin-right:6px}

    /* LOADING */
    .loader-box{text-align:center;padding:60px 0}
    .spinner{
      width:40px;height:40px;
      border:4px solid #E5E7EB;
      border-top-color:var(--primary);
      border-radius:50%;
      animation:spin 1s infinite linear;
      margin:0 auto 14px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* RESULTS */
    .result-box{
      background:#fff;
      border-radius:22px;
      padding:18px;
      border:1px solid #EEF2F7;
      box-shadow:0 18px 60px rgba(15,23,42,.06);
      margin-bottom:12px;
    }
    .result-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:12px;
    }
    .result-title{
      font-size:18px;
      font-weight:900;
      line-height:1.25;
      color:#0b1220;
    }
    .speech-toggle{
      background:#F1F5F9;
      border:1px solid #E2E8F0;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      color:#334155;
      white-space:nowrap;
    }
    .speech-toggle.active{background:#ECFDF5;border-color:#BBF7D0;color:#166534}

    .score-container{
      display:flex;align-items:center;gap:12px;
      margin:12px 0 14px;
      padding-bottom:14px;
      border-bottom:1px solid #F1F5F9;
    }
    .score-gauge{
      width:52px;height:52px;border-radius:50%;
      background:conic-gradient(var(--primary) 0%, #eee 0);
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;
    }
    .score-inner{
      width:42px;height:42px;border-radius:50%;
      background:#fff;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:14px;
      border:1px solid #EEF2F7;
    }
    .score-verdict{font-size:15px;font-weight:900}

    .result-text{font-size:14px;line-height:1.7;color:#334155;white-space:pre-line;margin:0 0 12px}

    .list-item{font-size:13px;margin-bottom:6px;padding-left:15px;position:relative;color:#334155}
    .list-item::before{content:'‚Ä¢';position:absolute;left:0;color:var(--primary);font-weight:900}

    .warn-box{
      background:#FFF7ED;border:1px solid #FFEDD5;color:#C2410C;
      padding:10px;border-radius:14px;font-size:13px;font-weight:800;margin-top:10px
    }

    .recommendations-title{font-size:12px;font-weight:900;color:#64748b;margin:10px 0}
    .rec-card{
      display:flex;align-items:center;
      background:#fff;
      border-radius:16px;
      padding:12px;
      margin-bottom:10px;
      text-decoration:none;
      color:inherit;
      border:1px solid #EEF2F7;
      box-shadow:0 10px 30px rgba(15,23,42,.05);
      position:relative;
      overflow:hidden;
    }
    .rec-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--primary)}
    .rec-content{flex:1;margin-left:10px}
    .award-badge{
      display:inline-block;
      font-size:11px;
      font-weight:900;
      background:#ECFDF5;
      color:var(--primary);
      border:1px solid #BBF7D0;
      padding:3px 8px;
      border-radius:999px;
      margin-bottom:6px;
    }
    .rec-name{font-weight:900;font-size:14px;color:#0b1220}
    .rec-reason{font-size:11px;color:#64748b;font-weight:700}
    .rec-arrow{color:#94a3b8}

    /* STATIC */
    .static-box{
      background:#fff;border-radius:22px;padding:18px;
      border:1px solid #EEF2F7;
      box-shadow:0 18px 60px rgba(15,23,42,.06);
    }
    .static-title{font-size:18px;font-weight:900;margin:0 0 10px;color:#0b1220}
    .static-content{color:#334155;line-height:1.7;font-size:14px}
    .back-btn{
      display:inline-flex;align-items:center;gap:8px;
      margin-bottom:12px;
      background:#ECFDF5;border:1px solid #BBF7D0;color:#0f5132;
      padding:8px 12px;border-radius:999px;font-weight:900;cursor:pointer
    }

    /* FOOTER */
    footer{
      padding:18px 16px;
      text-align:center;
      font-size:12px;
      color:#94a3b8;
      background:transparent;
    }
    .footer-links{
      display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:10px
    }
    .footer-links a{color:#64748b;text-decoration:none;font-weight:900}
    .company-tag{display:flex;flex-direction:column;gap:8px;align-items:center}
    .italian-bar{width:120px;height:4px;border-radius:999px;background:linear-gradient(90deg,#1f8a5b,#ffffff,#d93b3b);opacity:.28}

    /* WhatsApp floating */
    .whatsapp-btn{
      position:fixed;bottom:18px;right:18px;
      width:56px;height:56px;background:#25D366;color:white;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:28px;box-shadow:0 14px 40px rgba(0,0,0,.25);
      z-index:100;text-decoration:none;
    }
  </style>
</head>

<body>

  <!-- Onboarding -->
  <div id="onboardingModal">
    <div class="modal-content">
      <div class="modal-title">Ho≈ü Geldin Evladƒ±m!</div>
      <div class="modal-sub">Sana doƒüru hitap edebilmem ve ≈üehrine √∂zel √∂neriler verebilmem i√ßin seni tanƒ±mam lazƒ±m.</div>

      <div class="form-group">
        <label class="form-label">Sana nasƒ±l hitap edeyim?</label>
        <div class="gender-grid">
          <div class="gender-btn" id="btn-female" onclick="selectGender('female')">üë© Kƒ±zƒ±m / Canƒ±m</div>
          <div class="gender-btn" id="btn-male" onclick="selectGender('male')">üë® Oƒülum / Pa≈üam</div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Hangi ≈üehirdesin?</label>
        <input type="text" id="cityInput" class="form-input" placeholder="√ñrn: ƒ∞stanbul, D√ºzce...">
      </div>

      <button class="save-btn" onclick="saveProfile()">Kaydet ve Ba≈üla</button>
    </div>
  </div>

  <header>
    <div class="header-top">
      <div class="logo-container" onclick="resetAll()">
        <div class="logo-icon">C</div>
        <div class="logo-text">CAYNANA.AI</div>
      </div>

      <div class="header-actions">
        <button class="header-btn" onclick="resetAll()" title="Yeni Arama"><i class="fa-solid fa-magnifying-glass"></i></button>
        <button class="header-btn" onclick="openProfile()" title="Profil"><i class="fa-solid fa-user-gear"></i></button>
      </div>
    </div>

    <div class="profile-bar" id="profileBar">
      <span id="profileText">Misafir</span>
      <span class="profile-edit" onclick="openProfile()">D√ºzenle</span>
    </div>

    <div class="mode-selector-wrap">
      <div class="mode-selector">
        <button class="mode-btn active" id="mode-shopping" onclick="setMode('shopping')"><i class="fa-solid fa-bag-shopping"></i> Alƒ±≈üveri≈ü</button>
        <button class="mode-btn" id="mode-food" onclick="setMode('food')"><i class="fa-solid fa-utensils"></i> Yemek</button>
        <button class="mode-btn" id="mode-travel" onclick="setMode('travel')"><i class="fa-solid fa-plane"></i> Tatil</button>
        <button class="mode-btn" id="mode-cinema" onclick="setMode('cinema')"><i class="fa-solid fa-film"></i> Sinema</button>
        <button class="mode-btn" id="mode-pharmacy" onclick="setMode('pharmacy')"><i class="fa-solid fa-pills"></i> Eczane</button>
        <button class="mode-btn" id="mode-life" onclick="setMode('life')"><i class="fa-solid fa-cloud-sun"></i> Ya≈üam</button>
      </div>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section id="scene-home" class="scene active">
      <div class="hero-title">Karar <br><span>Danƒ±≈ümanƒ±m.</span></div>
      <div class="hero-sub">Alƒ±≈üveri≈ü, mekan, plan... Kaynanana danƒ±≈ü, pi≈üman olma.</div>

      <form id="searchForm" class="search-container" onsubmit="event.preventDefault(); start();">
        <div class="search-bar">
          <button type="button" class="action-btn" onclick="startVoice()" title="Sesle yaz"><i class="fa-solid fa-microphone"></i></button>
          <input id="q" type="text" placeholder="√úr√ºn adƒ±, linki veya sor..." autocomplete="off">
          <button type="button" class="action-btn" id="camBtn" onclick="triggerFile()" title="Foto ekle"><i class="fa-solid fa-camera"></i></button>
          <button type="button" class="action-btn search-btn" onclick="start()" title="G√∂nder"><i class="fa-solid fa-arrow-right"></i></button>
        </div>
        <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none" onchange="handleFile(this.files[0])">
      </form>

      <div class="chips-container" id="chipContainer"></div>
    </section>

    <!-- LOADING -->
    <section id="scene-loading" class="scene">
      <div class="loader-box">
        <div class="spinner"></div>
        <h3 style="margin:0 0 6px;font-weight:900;color:#0b1220">Kaynanan Ara≈ütƒ±rƒ±yor...</h3>
        <p id="loadingSub" style="margin:0;color:#64748b;font-weight:700">Hazƒ±rlanƒ±yor...</p>
        <button onclick="resetAll()" style="margin-top:18px;background:none;border:1px solid #e2e8f0;padding:7px 14px;border-radius:999px;cursor:pointer;font-weight:900;color:#475569">ƒ∞ptal</button>
      </div>
    </section>

    <!-- RESULTS -->
    <section id="scene-results" class="scene">
      <div class="result-box">
        <div class="result-header">
          <div class="result-title" id="finalHeadline">Sonu√ß</div>
          <button id="btnListen" class="speech-toggle" onclick="toggleSpeech()"><i class="fa-solid fa-volume-high"></i> Dinle</button>
        </div>

        <div id="scoreArea" class="score-container" style="display:none;">
          <div class="score-gauge" id="scoreGauge"><div class="score-inner" id="scoreVal">0</div></div>
          <div class="score-text-area"><div class="score-verdict" id="scoreVerdict">-</div></div>
        </div>

        <div id="finalText" class="result-text"></div>

        <div id="listsWrap"></div>
        <div id="warnWrap" style="display:none;" class="warn-box"></div>
      </div>

      <a id="waShareBtn" href="#" target="_blank"
         style="display:none;width:100%;padding:12px;background:#25D366;color:#fff;border-radius:14px;text-align:center;text-decoration:none;font-weight:900;margin-bottom:12px;">
        <i class="fa-brands fa-whatsapp"></i> Payla≈ü
      </a>

      <div class="recommendations-title" id="recTitle">√ñNERƒ∞LER</div>
      <div id="recommendationList"></div>
    </section>

    <!-- STATIC -->
    <section id="scene-static" class="scene">
      <button class="back-btn" onclick="showScene('scene-home')"><i class="fa-solid fa-arrow-left"></i> Geri</button>
      <div class="static-box">
        <h2 class="static-title" id="staticTitle">Bilgi</h2>
        <div class="static-content" id="staticText"></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-links">
      <a href="#" onclick="openContent('hakkimizda')">Hakkƒ±mƒ±zda</a>
      <a href="#" onclick="openContent('anayasasi')">Caynana Anayasasƒ±</a>
      <a href="#" onclick="openContent('sss')">Sƒ±k√ßa Sorulan Sorular</a>
      <a href="#" onclick="openContent('gizlilik')">Gizlilik Politikasƒ±</a>
      <a href="#" onclick="openContent('sartlar')">Kullanƒ±m ≈ûartlarƒ±</a>
      <a href="#" onclick="openContent('iletisim')">ƒ∞leti≈üim</a>
      <a href="#" onclick="openContent('sorumluluk')">Yasal Uyarƒ±</a>
    </div>

    <div class="company-tag">
      <span>¬© 2025 CAYNANA.AI BY ITALKY TECHNOLOGY</span>
      <div class="italian-bar"></div>
    </div>
  </footer>

  <a href="https://wa.me/?text=Caynana" target="_blank" class="whatsapp-btn" aria-label="WhatsApp">
    <i class="fa-brands fa-whatsapp"></i>
  </a>

  <script>
    // ‚úÖ API
    const API_BASE = "https://bikonomi-api-1.onrender.com";

    // ‚úÖ Session
    let session = { q:"", img:"", mode:"shopping", gender:"neutral", city:"" };

    // ‚úÖ Audio
    let currentAudio = null;
    let audioText = "";

    // ---------- ONBOARDING ----------
    function init(){
      const g = localStorage.getItem("caynana_gender");
      const c = localStorage.getItem("caynana_city");

      if(!g || !c){
        document.getElementById("onboardingModal").style.display = "flex";
        document.getElementById("profileBar").style.display = "none";
      } else {
        session.gender = g;
        session.city = c;
        updateProfileBar();
      }

      setMode("shopping");
    }

    let tempGender = "neutral";
    window.selectGender = function(g){
      tempGender = g;
      document.querySelectorAll(".gender-btn").forEach(b => b.classList.remove("selected"));
      const el = document.getElementById("btn-" + g);
      if(el) el.classList.add("selected");
    };

    window.saveProfile = function(){
      const city = document.getElementById("cityInput").value.trim();
      if(!city){
        alert("L√ºtfen ≈üehrini yaz evladƒ±m.");
        return;
      }
      localStorage.setItem("caynana_gender", tempGender);
      localStorage.setItem("caynana_city", city);

      session.gender = tempGender;
      session.city = city;

      document.getElementById("onboardingModal").style.display = "none";
      updateProfileBar();
      setMode(session.mode || "shopping");
    };

    function updateProfileBar(){
      const gIcon = session.gender === "female" ? "üë© Kƒ±zƒ±m" : (session.gender === "male" ? "üë® Oƒülum" : "üôÇ Evladƒ±m");
      document.getElementById("profileText").innerText = `${gIcon} | üìç ${session.city}`;
      document.getElementById("profileBar").style.display = "flex";
    }

    window.openProfile = function(){
      document.getElementById("cityInput").value = session.city || localStorage.getItem("caynana_city") || "";
      document.querySelectorAll(".gender-btn").forEach(b => b.classList.remove("selected"));

      const g = session.gender || localStorage.getItem("caynana_gender") || "neutral";
      if(g === "female" || g === "male"){
        const el = document.getElementById("btn-" + g);
        if(el) el.classList.add("selected");
        tempGender = g;
      }

      document.getElementById("onboardingModal").style.display = "flex";
    };

    // ---------- MODES ----------
    window.setMode = function(mode){
      session.mode = mode;

      document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));
      const btn = document.getElementById("mode-" + mode);
      if(btn) btn.classList.add("active");

      const q = document.getElementById("q");
      const c = document.getElementById("chipContainer");
      const camBtn = document.getElementById("camBtn");

      c.innerHTML = "";

      // Shopping dƒ±≈üƒ± kamera kapalƒ±
      if(mode === "shopping"){
        camBtn.style.display = "inline-flex";
        q.placeholder = "√úr√ºn adƒ±, linki veya sor...";
        addChip("En iyi airfryer hangisi?", "fire");
        addChip("iPhone 15 alƒ±nƒ±r mƒ±?", "mobile");
      } else {
        camBtn.style.display = "none";

        if(mode === "food"){
          q.placeholder = `${session.city || "Bulunduƒüun ≈üehir"} i√ßinde ne yemek istersin?`;
          addChip("En iyi kahvaltƒ± nerede?", "utensils");
          addChip("Romantik ak≈üam yemeƒüi", "heart");
        } else if(mode === "travel"){
          q.placeholder = "Nereye gitmek istersin?";
          addChip("Haftasonu gezilecek yerler", "car");
          addChip("Vizesiz √ºlkeler", "passport");
        } else if(mode === "pharmacy"){
          q.placeholder = "Hangi il√ßedesin?";
          addChip(`${session.city || "≈ûehrim"} merkez n√∂bet√ßi eczane`, "pills");
          addChip("En yakƒ±n eczane", "location-dot");
        } else if(mode === "cinema"){
          q.placeholder = "Hangi filmi merak ediyorsun?";
          addChip("Vizyondaki filmler", "film");
          addChip("Bu film izlenir mi?", "circle-question");
        } else {
          q.placeholder = "Derdin ne yavrum?";
          addChip("Bug√ºn ne giysem?", "shirt");
          addChip("Canƒ±m sƒ±kƒ±lƒ±yor", "face-meh");
        }
      }
    };

    function addChip(txt, icon){
      const d = document.createElement("div");
      d.className = "chip";
      d.onclick = () => { document.getElementById("q").value = txt; start(); };
      d.innerHTML = `<i class="fa-solid fa-${icon}"></i>${txt}`;
      document.getElementById("chipContainer").appendChild(d);
    }

    // ---------- FILE ----------
    window.triggerFile = function(){
      document.getElementById("fileInput").click();
    };

    window.handleFile = async function(file){
      if(!file) return;
      try{
        const base64 = await fileToBase64(file);
        session.img = base64; // data:image/...;base64,...
        alert("Foto eklendi. ≈ûimdi sorunu g√∂nder.");
      } catch(e){
        console.error(e);
        alert("Foto okunamadƒ±.");
      }
    };

    function fileToBase64(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ---------- VOICE INPUT ----------
    window.startVoice = function(){
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SpeechRecognition){
        alert("Tarayƒ±cƒ± sesle yazmayƒ± desteklemiyor.");
        return;
      }
      const rec = new SpeechRecognition();
      rec.lang = "tr-TR";
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      rec.onresult = (e) => {
        const txt = e.results?.[0]?.[0]?.transcript || "";
        document.getElementById("q").value = txt;
      };
      rec.onerror = () => alert("Ses algƒ±lanamadƒ±. Tekrar dene.");
      rec.start();
    };

    // ---------- MAIN ----------
    window.start = async function(){
      const qVal = document.getElementById("q").value.trim();
      if(!qVal && !session.img){
        alert("Bir ≈üey sor evladƒ±m.");
        return;
      }

      showScene("scene-loading");
      document.getElementById("loadingSub").innerText = session.city ? `${session.city} i√ßin hazƒ±rlanƒ±yor...` : "Hazƒ±rlanƒ±yor...";

      try{
        const payload = { ...session, q: qVal, img: session.img };
        payload.user = { gender: session.gender, city: session.city };

        const res = await fetch(API_BASE + "/api/analyze", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        if(!res.ok) throw new Error("Baƒülantƒ± hatasƒ±");
        const data = await res.json();
        renderResult(data);

        session.img = "";
        document.getElementById("fileInput").value = "";
      } catch(e){
        console.error(e);
        alert("Hata: " + e.message);
        showScene("scene-home");
      }
    };

    function renderResult(data){
      document.getElementById("q").value = "";
      audioText = data.speech_text || "";

      document.getElementById("finalHeadline").textContent = data.headline || "Sonu√ß";
      document.getElementById("finalText").innerText = data.text || "";

      // Score
      const sBox = document.getElementById("scoreArea");
      if(session.mode === "shopping" && data.score && Number(data.score.value) > 0){
        sBox.style.display = "flex";
        const val = Number(data.score.value);
        const col = data.score.color || "#10B981";

        document.getElementById("scoreVal").innerText = val;
        document.getElementById("scoreVerdict").innerText = data.score.label || "";
        document.getElementById("scoreVerdict").style.color = col;

        document.getElementById("scoreGauge").style.background =
          `conic-gradient(${col} ${val}%, #eee 0)`;
      } else {
        sBox.style.display = "none";
      }

      // Lists
      const listWrap = document.getElementById("listsWrap");
      listWrap.innerHTML = "";

      if(Array.isArray(data.pros) && data.pros.length) createList(listWrap, "Artƒ±lar / ƒ∞yi Yanlar", data.pros, "#16a34a", "check");
      if(Array.isArray(data.cons) && data.cons.length) createList(listWrap, "Eksiler / K√∂t√º Yanlar", data.cons, "#dc2626", "xmark");
      if(Array.isArray(data.outfit) && data.outfit.length) createList(listWrap, "Kƒ±yafet √ñnerim", data.outfit, "#2563eb", "shirt");

      // Warnings
      const wBox = document.getElementById("warnWrap");
      if(Array.isArray(data.chronic_issues) && data.chronic_issues.length){
        wBox.style.display = "block";
        wBox.innerHTML = "<strong>‚ö†Ô∏è Dikkat:</strong><br>" + data.chronic_issues.map(x => escapeHtml(x)).join("<br>");
      } else {
        wBox.style.display = "none";
      }

      // Recommendations
      const rList = document.getElementById("recommendationList");
      rList.innerHTML = "";

      if(Array.isArray(data.recommendations) && data.recommendations.length){
        data.recommendations.forEach(r => {
          const a = document.createElement("a");
          a.className = "rec-card";
          a.href = r.url || "#";
          a.target = "_blank";
          a.rel = "noopener";

          a.innerHTML = `
            <div class="rec-content">
              <div class="award-badge">${escapeHtml(r.award || "√ñneri")}</div>
              <div class="rec-name">${escapeHtml(r.product_name || "√úr√ºn")}</div>
              <div class="rec-reason">${escapeHtml(r.reason || "")}</div>
            </div>
            <div class="rec-arrow"><i class="fa-solid fa-chevron-right"></i></div>
          `;
          rList.appendChild(a);
        });
      } else {
        rList.innerHTML = "<div style='text-align:center;color:#94a3b8;font-weight:800'>√ñneri yok.</div>";
      }

      // WhatsApp
      const waBtn = document.getElementById("waShareBtn");
      waBtn.style.display = "block";
      const msg = `${data.headline || "Caynana"}\n${(data.text || "").slice(0, 450)}\n\nCaynana Tavsiyesi`;
      waBtn.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`;

      showScene("scene-results");
    }

    function createList(parent, title, arr, color, icon){
      const wrap = document.createElement("div");
      wrap.style.margin = "10px 0 14px";
      wrap.innerHTML = `<div style="font-weight:900;color:${color};margin-bottom:8px">
        <i class="fa-solid fa-${icon}"></i> ${title}
      </div>`;
      arr.forEach(i => {
        wrap.innerHTML += `<div class="list-item">${escapeHtml(i)}</div>`;
      });
      parent.appendChild(wrap);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ---------- STATIC CONTENT ----------
    const CONTENTS = {
      "hakkimizda": `
        <h3>1. CAYNANA nedir?</h3>
        <p>CAYNANA, yapay zek√¢ destekli bir alƒ±≈üveri≈ü ve karar danƒ±≈ümanƒ±dƒ±r. √úr√ºnleri analiz eder, mekan tavsiyesi verir, ne giyeceƒüine karƒ±≈üƒ±r.</p>
        <h3>2. Amacƒ± Nedir?</h3>
        <p>Seni hatalƒ± kararlardan korumak.</p>
      `,
      "anayasasi": `
        <h3>CAYNANA ANAYASASI</h3>
        <p>1. Caynana asla yalan s√∂ylemez, dobra konu≈üur.</p>
        <p>2. Seni gaza getirmez, frenler.</p>
        <p>3. √úr√ºn satmaya √ßalƒ±≈ümaz, paranƒ± korur.</p>
        <p>4. Her konuda bir fikri vardƒ±r.</p>
      `,
      "sss": `
        <h3>SSS</h3>
        <p><strong>Puan neden deƒüi≈üir?</strong><br>Yeni yorumlar geldik√ße yapay zeka puanƒ± g√ºnceller.</p>
      `,
      "gizlilik": `
        <h3>Gizlilik Politikasƒ±</h3>
        <p>Aramalarƒ±nƒ±z anonimdir. Ki≈üisel veri saklanmaz.</p>
      `,
      "sartlar": `
        <h3>Kullanƒ±m ≈ûartlarƒ±</h3>
        <p>Bu bir tavsiye asistanƒ±dƒ±r. Son karar size aittir.</p>
      `,
      "iletisim": `
        <h3>ƒ∞leti≈üim</h3>
        <p>D√ºzce Teknopark<br>info@italky.com</p>
      `,
      "sorumluluk": `
        <h3>Yasal Uyarƒ±</h3>
        <p>Sonu√ßlar yapay zeka tahminidir. Hatalƒ± olabilir.</p>
      `
    };

    window.openContent = function(key){
      const content = CONTENTS[key] || "<p>ƒ∞√ßerik hazƒ±rlanƒ±yor...</p>";

      let title = "Bilgi";
      if(key === "hakkimizda") title = "Hakkƒ±mƒ±zda";
      if(key === "anayasasi") title = "Caynana Anayasasƒ±";
      if(key === "sss") title = "Sƒ±k√ßa Sorulan Sorular";
      if(key === "gizlilik") title = "Gizlilik Politikasƒ±";
      if(key === "sartlar") title = "Kullanƒ±m ≈ûartlarƒ±";
      if(key === "iletisim") title = "ƒ∞leti≈üim";
      if(key === "sorumluluk") title = "Yasal Uyarƒ±";

      document.getElementById("staticTitle").textContent = title;
      document.getElementById("staticText").innerHTML = content;
      showScene("scene-static");
    };

    // ---------- SCENE & AUDIO ----------
    window.showScene = function(id){
      document.querySelectorAll(".scene").forEach(s => s.classList.remove("active"));
      const el = document.getElementById(id);
      if(el) el.classList.add("active");
      window.scrollTo(0,0);
      stopSpeech();
    };

    window.resetAll = function(){
      stopSpeech();
      session.img = "";
      document.getElementById("fileInput").value = "";
      document.getElementById("q").value = "";
      showScene("scene-home");
    };

    window.stopSpeech = function(){
      const btn = document.getElementById("btnListen");
      if(currentAudio){
        currentAudio.pause();
        currentAudio = null;
      }
      if(btn){
        btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Dinle';
        btn.classList.remove("active");
      }
    };

    window.toggleSpeech = async function(){
      const btn = document.getElementById("btnListen");

      if(currentAudio){
        stopSpeech();
        return;
      }
      if(!audioText){
        alert("Metin yok");
        return;
      }

      btn.innerHTML = "Y√ºkleniyor...";
      btn.classList.add("active");

      try{
        const res = await fetch(API_BASE + "/api/speak", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ text: audioText })
        });

        if(!res.ok) throw new Error("Ses servisi hatasƒ±");

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        currentAudio = new Audio(url);
        currentAudio.onended = () => stopSpeech();
        await currentAudio.play();

        btn.innerHTML = "Durdur";
      } catch(e){
        console.error(e);
        alert("Ses hatasƒ±");
        stopSpeech();
      }
    };

    // ---------- INIT ----------
    init();
  </script>
</body>
</html>
