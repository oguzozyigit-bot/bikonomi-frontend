<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>CAYNANA.AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* TRENDYOL TURUNCUSU TEMASI */
    :root { --primary: #F27A1A; --text-dark: #333; --bg: #FAFAFA; }
    
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text-dark); display: flex; flex-direction: column; min-height: 100vh; }
    
    .content-wrap { flex: 1; padding-bottom: 40px; }
    
    /* Header */
    .header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: #fff; border-bottom: 1px solid #eee; }
    .brand { font-size: 22px; font-weight: 900; color: var(--primary); letter-spacing: -0.5px; }
    .version { font-size: 10px; color: #999; font-weight: 600; }

    /* Hero */
    .hero { text-align: center; padding: 30px 20px 20px; }
    .hero h1 { font-size: 28px; margin: 0; color: #222; line-height: 1.2; }
    .hero h1 span { color: var(--primary); }
    
    /* Arama Kutusu */
    .search-container { padding: 0 20px; position: relative; z-index: 10; }
    .search-box { display: flex; background: #fff; border: 2px solid var(--primary); border-radius: 12px; padding: 5px; box-shadow: 0 8px 20px rgba(242, 122, 26, 0.15); }
    .search-box input { flex: 1; border: none; outline: none; padding: 12px; font-size: 16px; border-radius: 8px; }
    .action-btn { width: 44px; height: 44px; border: none; background: transparent; color: #666; font-size: 18px; cursor: pointer; border-radius: 8px; }
    .action-btn:hover { background: #f0f0f0; color: var(--primary); }
    .go-btn { background: var(--primary); color: white; width: 50px; border-radius: 8px; }
    
    /* Tek Ürün Kartı */
    .product-card { 
        background: #fff; margin: 20px; border-radius: 16px; overflow: hidden; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: none; border: 1px solid #eee; 
    }
    
    /* Ürün Görseli & Fiyat Alanı */
    .product-top { position: relative; padding: 20px; text-align: center; background: #fff; border-bottom: 1px solid #f0f0f0; }
    .product-img { max-height: 250px; max-width: 100%; object-fit: contain; }
    .price-tag { 
        position: absolute; bottom: 10px; right: 10px; 
        background: var(--primary); color: white; 
        padding: 6px 12px; border-radius: 8px; font-weight: 800; font-size: 18px; 
        box-shadow: 0 4px 10px rgba(242, 122, 26, 0.3);
    }

    /* İçerik */
    .product-body { padding: 20px; }
    .product-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; line-height: 1.4; color: #000; }
    
    .rating-badge { display: inline-flex; align-items: center; gap: 5px; background: #FFF3E0; color: #F27A1A; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; margin-bottom: 15px; }

    /* Caynana Yorumu */
    .caynana-box { background: #F8F9FA; padding: 15px; border-radius: 12px; border-left: 4px solid var(--primary); }
    .caynana-head { font-weight: 700; color: #444; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
    .caynana-text { font-size: 14px; line-height: 1.6; color: #555; white-space: pre-line; }

    /* Butonlar */
    .btn-group { margin-top: 20px; display: flex; gap: 10px; }
    .btn-buy { flex: 2; background: var(--primary); color: white; padding: 14px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(242, 122, 26, 0.25); }
    .btn-listen { flex: 1; background: #333; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; padding: 5px;}

    /* Loader */
    .loader { text-align: center; margin-top: 40px; display: none; }
    .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s infinite linear; margin: 0 auto 10px; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* Footer */
    footer { padding: 20px; text-align: center; color: #999; font-size: 11px; margin-top: auto; border-top: 1px solid #eee; background: #fff; }

    /* Resim Önizleme */
    #imgPreviewWrap { text-align: center; margin: 10px 20px; display: none; }
    #previewImg { height: 80px; border-radius: 8px; border: 1px solid #ddd; }
  </style>
</head>
<body>

<div class="content-wrap">
  <div class="header">
    <div class="brand">CAYNANA</div>
    <div class="version">v4.0</div>
  </div>

  <div class="hero">
    <h1>Ne alacaksan <br><span>Bana Sor.</span></h1>
  </div>

  <div class="search-container">
    <div class="search-box">
      <input type="text" id="q" placeholder="Ürün adı yaz..." onkeypress="handleEnter(event)">
      <button class="action-btn" onclick="startVoice()"><i class="fas fa-microphone"></i></button>
      <button class="action-btn" onclick="document.getElementById('fileInput').click()"><i class="fas fa-camera"></i></button>
      <button class="action-btn go-btn" onclick="analyze()"><i class="fas fa-arrow-right"></i></button>
    </div>
  </div>
  <input type="file" id="fileInput" hidden accept="image/*" onchange="previewImage()">

  <div id="imgPreviewWrap">
    <img id="previewImg" src="">
    <div style="font-size:11px; color:red; margin-top:5px;" onclick="clearImage()">Resmi Sil</div>
  </div>

  <div id="loader" class="loader">
    <div class="spinner"></div>
    <div style="color:#888; font-size:13px;">Trendyol fiyatları çekiliyor...</div>
  </div>

  <div id="productCard" class="product-card">
    <div class="product-top">
      <img id="pImg" class="product-img" src="" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1170/1170577.png'">
      <div id="pPrice" class="price-tag"></div>
    </div>
    
    <div class="product-body">
      <div id="pRating" class="rating-badge"></div>
      <div id="pTitle" class="product-title"></div>

      <div class="caynana-box">
        <div class="caynana-head">
          <span><i class="fas fa-robot"></i> Caynana Analizi</span>
        </div>
        <div id="pText" class="caynana-text"></div>
      </div>

      <div class="btn-group">
        <a id="pLink" href="#" target="_blank" class="btn-buy">
          Ürüne Git <i class="fas fa-external-link-alt"></i>
        </a>
        <button id="speakBtn" class="btn-listen" onclick="toggleSpeak()">
          <i class="fas fa-play"></i>
          <span>Dinle</span>
        </button>
      </div>
    </div>
  </div>

</div>

<footer>
  @2026 Caynana AI - Trendyol Ürün Analiz Asistanı
</footer>

<script>
  let sessionImg = "";
  let audio = null;
  let audioText = "";

  function handleEnter(e) { if(e.key === 'Enter') analyze(); }

  function previewImage() {
    const file = document.getElementById('fileInput').files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      sessionImg = e.target.result;
      document.getElementById('previewImg').src = sessionImg;
      document.getElementById('imgPreviewWrap').style.display = 'block';
    }
    reader.readAsDataURL(file);
  }

  function clearImage() {
    sessionImg = "";
    document.getElementById('fileInput').value = "";
    document.getElementById('imgPreviewWrap').style.display = 'none';
  }

  async function analyze() {
    const q = document.getElementById('q').value;
    if(!q && !sessionImg) return alert("Hadi evladım, bir şey yaz.");

    document.getElementById('productCard').style.display = 'none';
    document.getElementById('loader').style.display = 'block';
    
    if(audio) { audio.pause(); audio = null; }

    try {
      const res = await fetch('/api/analyze', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ q: q, img: sessionImg })
      });
      const data = await res.json();
      
      if(data.error) throw new Error(data.error);

      // Verileri Doldur
      const realData = data.real_data || {};
      
      // Başlık: Eğer gerçek veri varsa onu kullan, yoksa AI başlığını kullan
      document.getElementById('pTitle').innerText = realData.title || data.headline;
      
      // Resim
      if(realData.image) document.getElementById('pImg').src = realData.image;
      else if(data.product_img) document.getElementById('pImg').src = data.product_img;
      
      // Fiyat
      if(realData.price) {
          document.getElementById('pPrice').innerText = realData.price;
          document.getElementById('pPrice').style.display = 'block';
      } else {
          document.getElementById('pPrice').style.display = 'none';
      }
      
      // Rating (Yorum Sayısı)
      if(realData.rating) {
        document.getElementById('pRating').innerText = `⭐ ${realData.rating} (${realData.reviews} Değerlendirme)`;
        document.getElementById('pRating').style.display = 'inline-flex';
      } else {
        document.getElementById('pRating').style.display = 'none';
      }

      // Link
      if(realData.link) {
          document.getElementById('pLink').href = realData.link;
          document.getElementById('pLink').innerHTML = 'Ürüne Git <i class="fas fa-external-link-alt"></i>';
      } else {
          document.getElementById('pLink').href = "#";
          document.getElementById('pLink').innerText = "Link Bulunamadı";
      }

      // Metin
      document.getElementById('pText').innerText = data.text;
      audioText = data.speech_text;

      document.getElementById('loader').style.display = 'none';
      document.getElementById('productCard').style.display = 'block';

    } catch(err) {
      alert("Hata: " + err.message);
      document.getElementById('loader').style.display = 'none';
    }
  }

  async function toggleSpeak() {
    const btn = document.getElementById('speakBtn');
    if(audio) {
      audio.pause(); audio = null;
      btn.innerHTML = '<i class="fas fa-play"></i><span>Dinle</span>';
      return;
    }
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>...</span>';
    
    try {
      const res = await fetch('/api/speak', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text: audioText})
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      audio = new Audio(url);
      audio.onended = () => { 
          audio = null; 
          btn.innerHTML = '<i class="fas fa-play"></i><span>Dinle</span>';
      };
      audio.play();
      btn.innerHTML = '<i class="fas fa-stop"></i><span>Dur</span>';
    } catch(e) {
      alert("Ses yok.");
      btn.innerHTML = '<i class="fas fa-play"></i><span>Dinle</span>';
    }
  }

  function startVoice() {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'tr-TR';
    document.getElementById('q').placeholder = "Dinliyorum...";
    recognition.onresult = (event) => {
        document.getElementById('q').value = event.results[0][0].transcript;
        analyze();
    };
    recognition.start();
  }
</script>
</body>
</html>
