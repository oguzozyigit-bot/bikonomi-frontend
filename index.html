document.addEventListener("DOMContentLoaded", async () => {

  // ---------------------------
  // 1) AUTH (Ã–NCE)
  // ---------------------------
  if (typeof initAuth === "function") initAuth();

  // Login buttons
  $("googleLoginBtn")?.addEventListener("click", () => handleLogin("google"));
  $("appleLoginBtn")?.addEventListener("click", () => handleLogin("apple"));

  // ---------------------------
  // 2) YP
  // ---------------------------
  try { applyDailyYP(); } catch(e){}

  // ---------------------------
  // 3) Partials & Notif
  // ---------------------------
  try { await initPartials(); } catch(e){}
  try { initNotif({ baseUrl: BASE_DOMAIN }); } catch(e){}

  // ---------------------------
  // 4) Profile
  // ---------------------------
  $("profileBtn")?.addEventListener("click", () => {
    location.href = "pages/profil.html";
  });

  // ---------------------------
  // 5) Menu
  // ---------------------------
  $("hambBtn")?.addEventListener("click", () => toggleMenu());
  $("menuOverlay")?.addEventListener("click", (e) => {
    if (e.target?.id === "menuOverlay") toggleMenu(false);
  });

  // ---------------------------
  // 6) Notifications
  // ---------------------------
  $("notifBtn")?.addEventListener("click", () => {
    toggleNotif();
    refreshNotifications();
  });

  document.addEventListener("click", (e) => {
    const dd = $("notifDropdown");
    const btn = $("notifBtn");
    if (!dd || !btn) return;
    if (dd.classList.contains("show") && !dd.contains(e.target) && !btn.contains(e.target)) {
      dd.classList.remove("show");
    }
  });

  // ---------------------------
  // 7) Terms
  // ---------------------------
  $("termsAcceptBtn")?.addEventListener("click", acceptTermsAndEnter);

  // ---------------------------
  // 8) Chat send
  // ---------------------------
  $("sendBtn")?.addEventListener("click", () => doSend());
  $("msgInput")?.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      doSend();
    }
  });

  // ---------------------------
  // 9) New chat
  // ---------------------------
  $("newChatBtn")?.addEventListener("click", () => newChat());

  // ---------------------------
  // 10) Menu actions (icons)
  // ---------------------------
  document.querySelectorAll(".menu-action").forEach(el => {
    el.addEventListener("click", () => {
      handleMenuAction(el.getAttribute("data-action"));
    });
  });

  // ---------------------------
  // 11) Logout / Delete account
  // ---------------------------
  $("logoutBtn")?.addEventListener("click", () => logout());
  $("deleteAccountBtn")?.addEventListener("click", deleteAccountTriple);

  // ---------------------------
  // 12) Fal hooks
  // ---------------------------
  window.openFal = openFalPanel;
  window.closeFal = closeFalPanel;
  window.handleFalFile = handleFalPhoto;

  // ---------------------------
  // 13) Session check
  // ---------------------------
  const user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");

  renderChatList();

  const chats = loadChats();
  if (chats.length && !currentChatId) {
    currentChatId = chats.sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0))[0]?.id || null;
  }

  if (user && user.isSessionActive && user.email) {
    $("loginOverlay")?.classList.remove("active");
    if (!user.terms_accepted_at) {
      $("termsOverlay")?.classList.add("active");
    } else {
      enterApp();
    }
  }

  if (!loadChats().length) newChat();

  refreshNotifications();
});
