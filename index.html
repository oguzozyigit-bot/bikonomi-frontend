<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Caynana.AI</title>

<style>
/* --- TEMEL AYARLAR --- */
:root{
  --bg: #050505;
  --amber: #ffb300;
  --amber-glow: #ff9100;
  --text: #e0e0e0;
  --drawer-bg: #141414;
}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
body{
  margin: 0; background: #000; display: flex; justify-content: center; align-items: center;
  height: 100vh; overflow: hidden; color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}
.phone{
  width: 100%; max-width: 420px; height: 100%; max-height: 900px; background: var(--bg);
  display: flex; flex-direction: column; position: relative; overflow: hidden;
}
@media(min-width: 500px){
  .phone{ border-radius: 40px; box-shadow: 0 0 0 10px #111, 0 30px 80px rgba(0,0,0,0.8); height: 95vh; }
}

/* --- TOPBAR & Gƒ∞ZLƒ∞Lƒ∞K KAPISI --- */
.topbar {
  position: absolute; top: 0; left: 0; width: 100%; height: 60px;
  display: flex; align-items: center; justify-content: space-between; padding: 0 14px; z-index: 60;
  background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
}
.menuBtn { background: none; border: none; font-size: 24px; color: #666; cursor: pointer; padding: 6px; }

/* TAKƒ∞P BUTONU (Privacy Switch) */
.followBtn {
  background: rgba(255, 179, 0, 0.1); border: 1px solid rgba(255, 179, 0, 0.3);
  color: var(--amber); border-radius: 20px; padding: 6px 14px; font-size: 12px; font-weight: 600;
  cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 6px;
}
.followBtn.active {
  background: var(--amber); color: #000; box-shadow: 0 0 15px var(--amber-glow); border-color: var(--amber);
}
.followBtn::before { content: "üëÅ"; }

/* --- HEADER & G√ñZLER (Relational Face) --- */
.header{
  height: 240px; display: flex; justify-content: center; align-items: center;
  /* Ba≈ülangƒ±√ßta gizli (Perde Kapalƒ±) */
  opacity: 0; transform: scale(0.95); filter: blur(10px);
  transition: all 0.8s cubic-bezier(0.22, 1, 0.36, 1);
  background: radial-gradient(circle at center, rgba(255,179,0,0.05) 0%, #000 70%);
  position: relative; z-index: 10; flex-shrink: 0; margin-top: 40px;
}
/* Takip Modu A√ßƒ±lƒ±nca */
.header.visible { opacity: 1; transform: scale(1); filter: blur(0); }

.eyes-container{ display:flex; gap: 24px; transform: scale(0.92); transition: transform 0.3s; }
.eye-wrapper{ width: 140px; height: 100px; position: relative; display:flex; justify-content:center; align-items:center; }

/* KA≈ûLAR */
.brow{
  position:absolute; top: -5px; left: 50%; transform: translateX(-50%);
  width: 120px; height: 24px; z-index: 30;
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.brow::before{
  content:""; position:absolute; inset:0; background: #111; border-radius: 50%;
  clip-path: polygon(0% 60%, 15% 40%, 50% 30%, 85% 40%, 100% 60%, 100% 100%, 0% 100%);
  filter: blur(1px);
}

/* G√ñZ √áER√áEVESƒ∞ (Neon) */
.eye-frame{
  position:absolute; top: 25px; left: 50%; transform: translateX(-50%);
  width: 140px; height: 75px;
  border-radius: 60% 60% 50% 50% / 70% 70% 50% 50%;
  border: 2px solid rgba(255,255,255,0.8);
  background: rgba(0,0,0,0.4); z-index: 10;
  box-shadow: 0 0 15px rgba(255,179,0,0.4), inset 0 0 10px #000;
  transition: all 0.3s;
}

/* G√ñZ BEBEƒûƒ∞ */
.iris-group {
  position: absolute; top: 62px; left: 50%; transform: translate(-50%, -50%);
  width: 40px; height: 40px; z-index: 15; transition: transform 0.1s;
}
.iris {
  width: 100%; height: 100%; border-radius: 50%;
  background: radial-gradient(circle, #ffb300 0%, #5a3a00 70%);
  border: 1px solid rgba(255,255,255,0.3);
  box-shadow: 0 0 10px rgba(255,179,0,0.6);
}
.pupil-black {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
  width: 18px; height: 18px; background: #000; border-radius: 50%;
}
.reflection {
  position: absolute; top: 30%; left: 30%; width: 6px; height: 6px; background: #fff; border-radius: 50%; filter: blur(0.5px);
}

/* G√ñZ KAPAƒûI */
.lid{
  position:absolute; top: 23px; left: 50%; transform: translateX(-50%);
  width: 150px; height: 0%; background: var(--bg); z-index: 25; border-bottom: 2px solid #111; transition: height 0.15s;
}
.lower-lid {
  position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 150px; height: 0%; background: var(--bg); z-index: 25; border-top: 2px solid #111; transition: height 0.3s;
}

/* --- STATE ANIMASYONLARI --- */

/* 1. SPEAKING (Konu≈üma Modu - A Se√ßeneƒüi) */
/* G√∂zler ritmik olarak parlar ve hafif b√ºy√ºr (Pulse) */
@keyframes speakPulse {
  0% { transform: scale(1); filter: brightness(1); }
  50% { transform: scale(1.05); filter: brightness(1.3); box-shadow: 0 0 25px var(--amber); }
  100% { transform: scale(1); filter: brightness(1); }
}
.speaking .eye-frame { animation: speakPulse 0.4s infinite alternate; border-color: #fff; }
.speaking .iris { animation: speakPulse 0.4s infinite alternate-reverse; }

/* 2. LISTENING (Dinleme Modu) */
.listening .eye-frame { border-color: var(--amber); box-shadow: 0 0 30px var(--amber-glow); }
.listening .iris-group { transform: translate(-50%, -50%) scale(1.2); } /* G√∂z bebekleri b√ºy√ºr */

/* 3. READING (Okuma Modu) */
.reading .iris-group { transform: translate(-50%, 18px) !important; }
.reading .lid { height: 35% !important; }

/* 4. DUYGULAR */
.angry .brow { transform: translateX(-50%) translateY(12px) rotate(15deg); }
.angry .eye-frame { border-color: #ff4444; }
.happy .brow { transform: translateX(-50%) translateY(-8px); }
.happy .lower-lid { height: 40%; border-radius: 50%; }
.sad .brow { transform: translateX(-50%) translateY(-5px) rotate(-10deg); }
.shock .eye-frame { transform: translateX(-50%) scale(1.15); }

/* --- CHAT ALANI --- */
.chat-area{ flex: 1; padding: 20px; display:flex; flex-direction:column; gap: 15px; overflow-y: auto; z-index: 20; }
.msg{ max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; color: #fff; position:relative; }
.msg.caynana{ align-self: flex-start; background: #1a1a1a; border-left: 3px solid var(--amber); min-height: 40px; }
.msg.user{ align-self: flex-end; background: #333; animation: popIn 0.3s ease; }
@keyframes popIn{ from{transform: translateY(10px); opacity: 0;} to{transform: translateY(0); opacity: 1;} }

/* Daktilo Kurs√∂r√º */
.cursor::after { content: '|'; animation: blinkCursor 0.8s infinite; }
@keyframes blinkCursor { 50% { opacity: 0; } }

/* --- INPUT --- */
.input-dock{ padding: 15px 20px 30px; background: #000; display:flex; align-items:center; gap:12px; z-index: 50; }
.icon-btn { background: #111; border: none; width: 44px; height: 44px; border-radius: 50%; color: #666; font-size: 20px; cursor: pointer; display:flex; justify-content:center; align-items:center; }
.icon-btn.mic-active { color: #ff4444; animation: pulseMic 1s infinite; background: rgba(255,0,0,0.1); }
@keyframes pulseMic { 0%{transform:scale(1);} 50%{transform:scale(1.1);} 100%{transform:scale(1);} }

input{ width:100%; background:#111; border:1px solid #333; border-radius:25px; padding:14px 20px; color:#fff; font-size:16px; outline:none; }
input:focus{ border-color: var(--amber); }

/* Hidden Video for Camera Logic */
#camVideo { position:absolute; opacity:0; pointer-events:none; }
</style>
</head>
<body>

<div class="phone" id="phone">
  
  <header class="topbar">
    <button class="menuBtn">‚ò∞</button>
    <button id="followBtn" class="followBtn">Takip Et</button>
  </header>

  <div class="header" id="faceHeader">
    <div class="eyes-container">
      <div class="eye-wrapper" id="eyeL">
        <div class="brow"></div><div class="lid"></div><div class="eye-frame"></div>
        <div class="iris-group"><div class="iris"><div class="pupil-black"><div class="reflection"></div></div></div></div>
        <div class="lower-lid"></div>
      </div>
      <div class="eye-wrapper" id="eyeR">
        <div class="brow"></div><div class="lid"></div><div class="eye-frame"></div>
        <div class="iris-group"><div class="iris"><div class="pupil-black"><div class="reflection"></div></div></div></div>
        <div class="lower-lid"></div>
      </div>
    </div>
  </div>

  <div class="chat-area" id="chatArea">
    </div>

  <div class="input-dock">
    <button class="icon-btn">üì∑</button>
    <input type="text" id="userInput" placeholder="Caynana'ya yaz..." autocomplete="off">
    <button class="icon-btn" id="micBtn">üéôÔ∏è</button>
  </div>

  <video id="camVideo" playsinline autoplay muted></video>

</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script>
/* --- 1. Sƒ∞STEM DEƒûƒ∞≈ûKENLERƒ∞ --- */
const faceHeader = document.getElementById('faceHeader');
const followBtn = document.getElementById('followBtn');
const eyes = [document.getElementById("eyeL"), document.getElementById("eyeR")];
const chatArea = document.getElementById("chatArea");
const input = document.getElementById("userInput");
const micBtn = document.getElementById("micBtn");
const pupils = document.querySelectorAll(".iris-group");

let isFollowing = false; // Gizlilik Kapƒ±sƒ± Durumu
let currentState = "IDLE"; // READING, SPEAKING, LISTENING, ANGRY...
const synth = window.speechSynthesis; // TTS Motoru

/* --- 2. Gƒ∞ZLƒ∞Lƒ∞K KAPISI (PRIVACY DOOR) --- */
followBtn.addEventListener('click', () => {
  isFollowing = !isFollowing;
  
  if (isFollowing) {
    // KAPIDA: "G√∂r√ºn√ºr Ol"
    followBtn.classList.add('active');
    followBtn.innerText = "Takibi Kapat";
    faceHeader.classList.add('visible'); // G√∂zler belirir
    startCamera(); // Kamera ba≈ülar
    addCaynanaMessage("Hah ≈ü√∂yle... A√ß ≈üu perdeyi de y√ºz√ºn√º g√∂relim evladƒ±m.");
  } else {
    // KAPIDA: "Gizlen"
    followBtn.classList.remove('active');
    followBtn.innerText = "Takip Et";
    faceHeader.classList.remove('visible'); // G√∂zler kaybolur
    stopCamera(); // Kamera durur
    setMood("normal");
  }
});

/* --- 3. STATE MACHINE (DURUM MAKƒ∞NESƒ∞) --- */
function setState(newState) {
  currentState = newState;
  
  // √ñnce temizle
  eyes.forEach(e => {
    e.classList.remove('speaking', 'listening', 'reading', 'angry', 'happy', 'sad', 'shock');
    e.querySelector('.iris-group').style.transform = '';
  });

  // Yeni durumu uygula
  if (newState !== "IDLE") {
    eyes.forEach(e => e.classList.add(newState));
  }
}

// Genel Duygu (Mood) Ayarlayƒ±cƒ±
function setMood(mood) {
  // Eƒüer konu≈üuyorsak veya okuyorsak mood override etmesin
  if(currentState === "SPEAKING" || currentState === "READING") return;
  setState(mood);
}

/* --- 4. DAKTƒ∞LO EFEKTƒ∞ (TYPEWRITER) --- */
function addCaynanaMessage(text, mood = "normal") {
  const div = document.createElement("div");
  div.className = "msg caynana cursor";
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;

  // Konu≈üma Ba≈ülasƒ±n (TTS)
  speakText(text);

  let i = 0;
  const speed = 40; // Yazma hƒ±zƒ± (ms)
  
  function type() {
    if (i < text.length) {
      div.innerText += text.charAt(i);
      i++;
      setTimeout(type, speed);
      chatArea.scrollTop = chatArea.scrollHeight;
    } else {
      div.classList.remove("cursor"); // ƒ∞mleci kaldƒ±r
    }
  }
  type();
}

/* --- 5. SESLƒ∞ ƒ∞Lƒ∞≈ûKƒ∞ (TTS - TEXT TO SPEECH) --- */
function speakText(text) {
  if (synth.speaking) { synth.cancel(); }

  const utterThis = new SpeechSynthesisUtterance(text);
  utterThis.lang = "tr-TR"; // T√ºrk√ße
  utterThis.rate = 1.0; // Hƒ±z
  utterThis.pitch = 0.9; // Biraz tok ses (Otoriter)

  utterThis.onstart = () => {
    setState("SPEAKING"); // G√∂zler parlamaya ba≈ülar
  };

  utterThis.onend = () => {
    setState("IDLE"); // Normale d√∂n
  };

  synth.speak(utterThis);
}

/* --- 6. OKUMA MODU (READING) --- */
input.addEventListener('focus', () => { 
  if(isFollowing) setState("READING"); 
});
input.addEventListener('blur', () => { 
  if(isFollowing) setState("IDLE"); 
});
input.addEventListener('input', () => {
  if(currentState === "READING") {
    // Yazarken g√∂zler hafif oynasƒ±n
    const x = (Math.random() - 0.5) * 5;
    pupils.forEach(p => p.style.transform = `translate(calc(-50% + ${x}px), 15px)`);
  }
});

/* --- 7. MESAJ G√ñNDERME Sƒ∞M√úLASYONU --- */
input.addEventListener('keypress', async (e) => {
  if (e.key === 'Enter' && input.value.trim() !== '') {
    const text = input.value;
    
    // Kullanƒ±cƒ± Mesajƒ±
    const userDiv = document.createElement("div");
    userDiv.className = "msg user";
    userDiv.innerText = text;
    chatArea.appendChild(userDiv);
    input.value = "";
    input.blur(); // Klavyeyi indir
    
    // Sim√ºle Backend Cevabƒ± (Burayƒ± Python API'ye baƒülayacaƒüƒ±z)
    setTimeout(() => {
      let reply = "";
      const lower = text.toLowerCase();
      
      if(lower.includes("para")) reply = "O parayƒ± harcarken bana mƒ± sordun? Tutumlu ol biraz!";
      else if(lower.includes("nasƒ±lsƒ±n")) reply = "ƒ∞yiyim evladƒ±m, sen nasƒ±lsƒ±n? Y√ºz√ºn solgun gibi.";
      else if(lower.includes("takip")) reply = "Ben seni her zaman izliyorum zaten, merak etme.";
      else reply = "Hƒ±mm... Anladƒ±m. Peki sonra ne oldu?";
      
      addCaynanaMessage(reply);
    }, 800);
  }
});

/* --- 8. KAMERA & MEDIA PIPE (SADECE G√ñZ TAKƒ∞Bƒ∞) --- */
let faceMesh, camera;

async function startCamera() {
  if (!faceMesh) {
    faceMesh = new FaceMesh.FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
    faceMesh.setOptions({maxNumFaces: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
    faceMesh.onResults(onResults);
    
    camera = new Camera(document.getElementById('camVideo'), {
      onFrame: async () => { await faceMesh.send({image: document.getElementById('camVideo')}); },
      width: 640, height: 480
    });
  }
  await camera.start();
}

function stopCamera() {
  if (camera) camera.stop();
}

function onResults(results) {
  if (!results.multiFaceLandmarks || !results.multiFaceLandmarks[0] || currentState === "READING" || currentState === "SPEAKING") return;
  
  const lm = results.multiFaceLandmarks[0];
  const nose = lm[1]; // Burun ucu
  
  // Tersine √ßevir (Ayna etkisi)
  const x = (0.5 - nose.x) * 2; // -1 to 1
  const y = (nose.y - 0.5) * 2; // -1 to 1
  
  // G√∂zleri hareket ettir
  pupils.forEach(p => {
    p.style.transform = `translate(calc(-50% + ${x * 15}px), calc(-50% + ${y * 10}px))`;
  });
}

// Mouse Fallback (Kamera Kapalƒ±yken)
document.addEventListener('mousemove', (e) => {
  if(isFollowing && !camera && currentState === "IDLE") {
    const x = (e.clientX - window.innerWidth/2) / 20;
    const y = (e.clientY - window.innerHeight/3) / 20;
    pupils.forEach(p => p.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`);
  }
});

</script>
</body>
</html>
