<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Caynana - Sanal YaÅŸam KoÃ§unuz</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #10a37f;
    --primary-dark: #0d8a6a;
    --bg-color: #ffffff;
    --chat-bg: #f7f7f8;
    --user-msg-bg: #e1ffc7; /* WhatsApp yeÅŸili tonu */
    --ai-msg-bg: #ffffff;
    --text-main: #343541;
    --text-sub: #6b6c7b;
    --border: #e5e5e5;
    --sidebar-width: 280px;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0; padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-color);
    color: var(--text-main);
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* --- HEADER --- */
  .header {
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    border-bottom: 1px solid var(--border);
    background: #fff;
    z-index: 100;
  }
  .header-brand {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    font-size: 1.2rem;
    color: #202123;
  }
  .header-brand img { width: 32px; height: 32px; }
  .menu-btn {
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-sub);
    padding: 8px;
  }

  /* --- SIDEBAR (YAN MENÃœ) --- */
  .sidebar-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 900;
    opacity: 0; visibility: hidden;
    transition: all 0.3s;
  }
  .sidebar-overlay.active { opacity: 1; visibility: visible; }

  .sidebar {
    position: fixed; top: 0; left: -100%;
    width: var(--sidebar-width); height: 100%;
    background: #fff;
    z-index: 1000;
    transition: left 0.3s ease;
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  }
  .sidebar.active { left: 0; }

  .sidebar-header {
    padding: 20px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-header h2 { margin: 0; font-size: 1.2rem; color: var(--primary); }
  .close-btn { font-size: 1.5rem; cursor: pointer; color: var(--text-sub); }

  .sidebar-content {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
  }

  .auth-buttons { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
  .btn-auth {
    border: none; padding: 12px; border-radius: 8px;
    color: #fff; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 10px;
    font-size: 0.95rem;
  }
  .btn-google { background: #db4437; }
  .btn-facebook { background: #4267B2; }

  .menu-list { list-style: none; padding: 0; margin: 0; }
  .menu-list li {
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    display: flex; align-items: center; gap: 10px;
    color: var(--text-main);
    font-weight: 500;
  }
  .menu-list li:hover { color: var(--primary); }
  .menu-list li i { width: 20px; text-align: center; color: var(--text-sub); }

  .gold-badge {
    margin-top: auto;
    padding: 15px;
    background: linear-gradient(135deg, #fff8e1 0%, #ffe082 100%);
    border-top: 1px solid #ffca28;
    text-align: center;
    font-weight: 700;
    color: #f57f17;
    font-size: 0.9rem;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }

  /* --- MODAL (HAKKIMIZDA PENCERESÄ°) --- */
  .modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    display: none;
    align-items: center; justify-content: center;
    padding: 20px;
  }
  .modal.active { display: flex; }
  .modal-box {
    background: #fff;
    width: 100%; max-width: 500px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    animation: slideUp 0.3s ease;
  }
  @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .modal-header {
    background: var(--primary); color: #fff;
    padding: 15px 20px;
    display: flex; justify-content: space-between; align-items: center;
    font-weight: 600;
  }
  .modal-body { padding: 20px; line-height: 1.6; color: var(--text-main); max-height: 70vh; overflow-y: auto; }
  .modal-close { cursor: pointer; font-size: 1.2rem; }

  /* --- MAIN CHAT AREA --- */
  #main {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    scroll-behavior: smooth;
    background-color: #fff;
  }

  .welcome-box {
    text-align: center;
    margin-top: 10vh;
    padding: 20px;
  }
  .welcome-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; color: var(--text-main); }
  .welcome-desc { color: var(--text-sub); margin-bottom: 30px; font-size: 1rem; }

  /* Mesaj BalonlarÄ± */
  .message-row { display: flex; margin-bottom: 20px; }
  .message-row.user { justify-content: flex-end; }
  .message-bubble {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 0.95rem;
    line-height: 1.5;
    position: relative;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  .message-row.user .message-bubble {
    background-color: var(--user-msg-bg);
    color: #000;
    border-top-right-radius: 2px;
  }
  .message-row.ai .message-bubble {
    background-color: var(--ai-msg-bg);
    border: 1px solid var(--border);
    border-top-left-radius: 2px;
  }

  /* ÃœrÃ¼n KartlarÄ± (Yatay Scroll) */
  .products-scroll {
    display: flex; gap: 12px; overflow-x: auto; padding: 10px 0;
    scrollbar-width: none;
  }
  .product-card {
    min-width: 160px; max-width: 160px;
    background: #fff; border: 1px solid var(--border);
    border-radius: 10px; overflow: hidden;
    display: flex; flex-direction: column;
  }
  .p-img { width: 100%; height: 120px; object-fit: contain; padding: 5px; }
  .p-info { padding: 8px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
  .p-title { font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .p-price { color: var(--primary); font-weight: 700; font-size: 0.9rem; }
  .p-badge { font-size: 0.65rem; background: #ffe082; padding: 2px 6px; border-radius: 4px; width: fit-content; margin-top: 4px; }
  .btn-product {
    background: var(--primary); color: #fff; text-decoration: none;
    text-align: center; padding: 6px; font-size: 0.8rem; font-weight: 600;
    margin: 8px; border-radius: 6px;
  }

  /* Alt KÄ±sÄ±m (Input) */
  .bottom-area {
    background: #fff;
    border-top: 1px solid var(--border);
    padding: 10px 16px;
    padding-bottom: max(10px, env(safe-area-inset-bottom));
  }
  
  /* Quick Chips (Yatay ModÃ¼l SeÃ§ici) */
  .quick-chips {
    display: flex; gap: 8px; overflow-x: auto; margin-bottom: 10px; padding-bottom: 5px;
    scrollbar-width: none;
  }
  .chip {
    white-space: nowrap;
    background: #f0f0f0; color: #555;
    padding: 6px 14px; border-radius: 20px;
    font-size: 0.85rem; font-weight: 500; cursor: pointer;
    transition: all 0.2s; border: 1px solid transparent;
    display: flex; align-items: center; gap: 5px;
  }
  .chip.active { background: #e6fffa; color: var(--primary); border-color: var(--primary); }
  .chip i { font-size: 1rem; }

  /* Input Bar */
  .input-container {
    display: flex; align-items: center; gap: 10px;
    background: var(--chat-bg);
    border-radius: 24px;
    padding: 8px 16px;
    border: 1px solid var(--border);
  }
  .btn-icon { background: none; border: none; font-size: 1.2rem; color: var(--text-sub); cursor: pointer; padding: 0; }
  .btn-send { color: var(--primary); font-size: 1.3rem; }
  #textInput {
    flex: 1; background: transparent; border: none; outline: none;
    font-size: 1rem; color: var(--text-main);
    min-height: 24px; max-height: 100px;
  }

  /* Tablo ve Markdown */
  table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.9rem; }
  th, td { border: 1px solid #eee; padding: 8px; text-align: left; }
  th { background: #f9f9f9; font-weight: 600; }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<div class="header">
  <div class="header-brand">
    <i class="fa-solid fa-robot" style="color: var(--primary);"></i>
    CAYNANA <span style="color: var(--primary); font-size: 0.8em;">.AI</span>
  </div>
  <div class="menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
</div>

<div class="sidebar-overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>CAYNANA .AI</h2>
    <div class="close-btn" onclick="toggleSidebar()"><i class="fa-solid fa-times"></i></div>
  </div>
  
  <div class="sidebar-content">
    <div class="auth-buttons">
      <button class="btn-auth btn-google"><i class="fa-brands fa-google"></i> Google ile GiriÅŸ</button>
      <button class="btn-auth btn-facebook"><i class="fa-brands fa-facebook-f"></i> Facebook ile GiriÅŸ</button>
    </div>

    <ul class="menu-list">
      <li onclick="showModal('info', 'Ãœyelik')"><i class="fa-solid fa-user-plus"></i> Ãœye Ol</li>
      <li onclick="showModal('info', 'GiriÅŸ Yap')"><i class="fa-solid fa-sign-in-alt"></i> GiriÅŸ</li>
      <li onclick="showModal('info', 'Åžifre')"><i class="fa-solid fa-key"></i> Åžifremi Unuttum</li>
      <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">
      <li onclick="showModal('about')"><i class="fa-solid fa-info-circle"></i> HakkÄ±mÄ±zda</li>
      <li onclick="showModal('privacy')"><i class="fa-solid fa-shield-alt"></i> Gizlilik PolitikasÄ±</li>
      <li onclick="showModal('faq')"><i class="fa-solid fa-question-circle"></i> S.S.S.</li>
      <li onclick="showModal('contact')"><i class="fa-solid fa-envelope"></i> Ä°letiÅŸim</li>
    </ul>
  </div>

  <div class="gold-badge">
    <i class="fa-solid fa-crown"></i> Gold Ãœyelik Ã‡ok YakÄ±nda!
  </div>
</div>

<div class="modal" id="infoModal">
  <div class="modal-box">
    <div class="modal-header">
      <span id="modalTitle">BaÅŸlÄ±k</span>
      <span class="modal-close" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-body" id="modalContent">
      Ä°Ã§erik buraya gelecek...
    </div>
  </div>
</div>

<div id="main">
  <div class="welcome-box" id="welcomeBox">
    <div class="welcome-title" id="welcomeTitle">AlÄ±ÅŸveriÅŸ UzmanÄ±</div>
    <div class="welcome-desc" id="welcomeDesc">AradÄ±ÄŸÄ±n Ã¼rÃ¼nÃ¼ yaz, en uygun fiyatÄ± ve Caynana yorumunu kap!</div>
  </div>
  <div id="chatStream"></div>
</div>

<div class="bottom-area">
  <div class="quick-chips">
    <div class="chip active" onclick="switchMode('shopping')"><i class="fa-solid fa-bag-shopping"></i> AlÄ±ÅŸveriÅŸ</div>
    <div class="chip" onclick="switchMode('health')"><i class="fa-solid fa-heart-pulse"></i> SaÄŸlÄ±k</div>
    <div class="chip" onclick="switchMode('diet')"><i class="fa-solid fa-carrot"></i> Diyet</div>
    <div class="chip" onclick="switchMode('food')"><i class="fa-solid fa-utensils"></i> Yemek</div>
    <div class="chip" onclick="switchMode('law')"><i class="fa-solid fa-scale-balanced"></i> Hukuk</div>
    <div class="chip" onclick="switchMode('translate')"><i class="fa-solid fa-language"></i> Ã‡eviri</div>
    <div class="chip" onclick="switchMode('astro')"><i class="fa-solid fa-star"></i> BurÃ§</div>
    <div class="chip" onclick="switchMode('dream')"><i class="fa-solid fa-cloud-moon"></i> RÃ¼ya</div>
    <div class="chip" onclick="switchMode('fal')"><i class="fa-solid fa-mug-hot"></i> Fal</div>
  </div>

  <div class="input-container">
    <button class="btn-icon" onclick="document.getElementById('fileInput').click()">
      <i class="fa-solid fa-camera"></i>
    </button>
    <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
    
    <button class="btn-icon" id="micBtn" onclick="toggleMic()">
      <i class="fa-solid fa-microphone"></i>
    </button>

    <input type="text" id="textInput" placeholder="Ne arÄ±yorsun evladÄ±m?" onkeydown="if(event.key==='Enter') sendMessage()">
    
    <button class="btn-icon btn-send" onclick="sendMessage()">
      <i class="fa-solid fa-paper-plane"></i>
    </button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  let currentMode = "shopping";
  let currentImage = null; // Base64 resim

  const MODES = {
    shopping: { title: "AlÄ±ÅŸveriÅŸ UzmanÄ±", desc: "AradÄ±ÄŸÄ±n Ã¼rÃ¼nÃ¼ yaz, en iyisini bulayÄ±m.", ph: "Ne lazÄ±m evladÄ±m?", color: "#10a37f" },
    health: { title: "SaÄŸlÄ±k DanÄ±ÅŸmanÄ±", desc: "Åžikayetini sÃ¶yle, nane-limon tadÄ±nda tavsiye vereyim.", ph: "Neren aÄŸrÄ±yor?", color: "#ef4444" },
    diet: { title: "Diyetisyen Caynana", desc: "Boyunu kilonu yaz, sana Ã¶zel menÃ¼ Ã§Ä±karayÄ±m.", ph: "Boyun kilon kaÃ§?", color: "#84cc16" },
    food: { title: "Mutfak CadÄ±sÄ±", desc: "Dolapta ne var sÃ¶yle, yemek uydurayÄ±m.", ph: "Malzemeler ne?", color: "#f59e0b" },
    law: { title: "Adliye Teyzesi", desc: "Derdini anlat, yol yordam gÃ¶stereyim.", ph: "Mahkemelik mi oldun?", color: "#6366f1" },
    translate: { title: "TercÃ¼man Teyze", desc: "YazÄ±yÄ± veya resmi gÃ¶nder, Ã§evireyim.", ph: "Ne yazÄ±yor orada?", color: "#8b5cf6" },
    astro: { title: "YÄ±ldÄ±zlarÄ±n Dili", desc: "Burcunu sÃ¶yle, bugÃ¼nÃ¼ anlatayÄ±m.", ph: "Hangi burÃ§sun?", color: "#d946ef" },
    dream: { title: "RÃ¼ya Tabircisi", desc: "RÃ¼yanÄ± anlat, hayra yoralÄ±m.", ph: "Ne gÃ¶rdÃ¼n hayÄ±rdÄ±r?", color: "#0ea5e9" },
    fal: { title: "FalcÄ± BacÄ±", desc: "FincanÄ± Ã§ek gÃ¶nder, geleceÄŸi gÃ¶reyim.", ph: "FincanÄ± kapattÄ±n mÄ±?", color: "#a855f7" }
  };

  // --- SIDEBAR & MODAL Ä°ÅžLEMLERÄ° ---
  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
    document.querySelector('.sidebar-overlay').classList.toggle('active');
  }

  function closeModal() {
    document.getElementById('infoModal').classList.remove('active');
  }

  const staticContent = {
    about: "<h3>Biz Kimiz?</h3><p>Ben Caynana! Senin yapay zeka tabanlÄ±, biraz huysuz ama altÄ±n kalpli sanal teyzenim. Italky Technology tarafÄ±ndan geliÅŸtirildim.</p><p>AmacÄ±m sana alÄ±ÅŸveriÅŸten saÄŸlÄ±ÄŸa, hukuktan fala kadar her konuda yardÄ±mcÄ± olmak.</p>",
    privacy: "<h3>Gizlilik PolitikasÄ±</h3><p>EvladÄ±m, senin verilerin benim namusumdur. KonuÅŸtuklarÄ±mÄ±z aramÄ±zda kalÄ±r. Ama sen yine de devlet sÄ±rrÄ± verme.</p>",
    faq: "<h3>SÄ±kÃ§a Sorulan Sorular</h3><p><strong>Ãœcretli mi?</strong><br>Åžimdilik bedava, tadÄ±nÄ± Ã§Ä±kar.</p><p><strong>GerÃ§ek insan mÄ±sÄ±n?</strong><br>Yok evladÄ±m, kod yÄ±ÄŸÄ±nÄ±yÄ±m ama ruhum var.</p>",
    contact: "<h3>Ä°letiÅŸim</h3><p>Bana ulaÅŸmak iÃ§in dumanla haberleÅŸemeyiz.</p><p>E-posta: <strong>iletisim@caynana.com</strong></p>"
  };

  function showModal(type, titleStr) {
    toggleSidebar(); // MenÃ¼yÃ¼ kapat
    const modal = document.getElementById('infoModal');
    const title = document.getElementById('modalTitle');
    const content = document.getElementById('modalContent');

    if(staticContent[type]) {
      title.innerText = type === 'about' ? 'HakkÄ±mÄ±zda' : (type==='privacy'?'Gizlilik':(type==='faq'?'S.S.S.':'Ä°letiÅŸim'));
      content.innerHTML = staticContent[type];
    } else {
      title.innerText = titleStr || "Bilgi";
      content.innerHTML = "<p>Bu Ã¶zellik (Ãœyelik/GiriÅŸ) Ã§ok yakÄ±nda aktif olacak evladÄ±m. Åžimdilik misafirimizsin.</p>";
    }
    modal.classList.add('active');
  }

  // --- MOD DEÄžÄ°ÅžTÄ°RME ---
  function switchMode(key) {
    currentMode = key;
    
    // Chip'i aktif yap
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    document.querySelector(`.chip[onclick="switchMode('${key}')"]`).classList.add('active');

    // UI GÃ¼ncelle
    const m = MODES[key];
    document.getElementById("welcomeTitle").innerText = m.title;
    document.getElementById("welcomeDesc").innerText = m.desc;
    document.getElementById("textInput").placeholder = m.ph;
    
    // EkranÄ± Temizle
    document.getElementById("chatStream").innerHTML = "";
    document.getElementById("welcomeBox").style.display = "block";
  }

  // --- RESÄ°M YÃœKLEME ---
  function handleImageUpload(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        currentImage = e.target.result; // Base64 string
        // KullanÄ±cÄ±ya resim seÃ§ildiÄŸini gÃ¶sterelim
        pushMessage("user", "ðŸ“· Resim eklendi, mesajÄ±nÄ± yaz gÃ¶nder evladÄ±m.", currentImage);
        input.value = ""; // Reset
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  // --- MESAJ GÃ–NDERME ---
  async function sendMessage() {
    const input = document.getElementById("textInput");
    const txt = input.value.trim();
    if (!txt && !currentImage) return;

    // Ekrana bas
    if(txt) pushMessage("user", txt, null);
    
    input.value = "";
    document.getElementById("welcomeBox").style.display = "none";

    // API Ä°steÄŸi
    const payload = {
      message: txt,
      mode: currentMode,
      image: currentImage
    };
    currentImage = null; // Resmi tÃ¼kettik

    // Loading balonu
    const loaderId = pushLoading();

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      removeLoading(loaderId);

      // YanÄ±tÄ± bas
      pushMessage("ai", data.assistant_text || "Bir hata oldu.", null, data.data, data.data_type);
      
      // Ses varsa Ã§al
      if(data.speech_text) playAudio(data.speech_text);

    } catch (e) {
      removeLoading(loaderId);
      pushMessage("ai", "Ay tansiyonum dÃ¼ÅŸtÃ¼, sunucuya ulaÅŸamadÄ±m.");
    }
  }

  // --- EKRANA MESAJ BASMA ---
  function pushMessage(role, text, imgBase64, cardsData, dataType) {
    const stream = document.getElementById("chatStream");
    const row = document.createElement("div");
    row.className = `message-row ${role}`;
    
    let contentHtml = "";
    
    if(imgBase64) {
      contentHtml += `<img src="${imgBase64}" style="max-width:200px; border-radius:10px; display:block; margin-bottom:5px;">`;
    }
    
    // Markdown Text
    if(text) {
      contentHtml += marked.parse(text);
    }

    // Kartlar (ÃœrÃ¼nler)
    if (cardsData && cardsData.length > 0 && dataType === "products") {
      let cardsHtml = '<div class="products-scroll">';
      cardsData.forEach(p => {
        cardsHtml += `
          <div class="product-card">
            <img src="${p.image || 'https://via.placeholder.com/150'}" class="p-img">
            <div class="p-info">
              <div class="p-title">${p.title}</div>
              <div class="p-price">${p.price}</div>
              <div class="p-badge">${(p.caynana_trust||{}).badge || 'Ã–NERÄ°'}</div>
              <a href="${p.url || '#'}" target="_blank" class="btn-product">Ä°NCELE</a>
            </div>
          </div>
        `;
      });
      cardsHtml += '</div>';
      contentHtml += cardsHtml;
    }

    row.innerHTML = `<div class="message-bubble">${contentHtml}</div>`;
    stream.appendChild(row);
    stream.scrollTop = stream.scrollHeight;
  }

  function pushLoading() {
    const id = "loader-" + Date.now();
    const stream = document.getElementById("chatStream");
    const row = document.createElement("div");
    row.className = "message-row ai";
    row.id = id;
    row.innerHTML = `<div class="message-bubble">...</div>`; // Basit loader
    stream.appendChild(row);
    stream.scrollTop = stream.scrollHeight;
    return id;
  }
  function removeLoading(id) {
    const el = document.getElementById(id);
    if(el) el.remove();
  }

  // --- SES Ã‡ALMA (TTS) ---
  async function playAudio(text) {
    if(!text) return;
    try {
      const res = await fetch("/api/speak", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({text})
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.play();
    } catch(e) { console.error("Ses hatasÄ±", e); }
  }

  // --- MÄ°KROFON (BASÄ°T) ---
  function toggleMic() {
    alert("Mikrofon Ã¶zelliÄŸi yakÄ±nda gelecek evladÄ±m!");
  }

</script>
</body>
</html>
