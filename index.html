<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>CAYNANA.AI</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root{ 
    --primary: #10B981; 
    --primary-dark: #059669;
    --bg: #F9FAFB; 
    --white: #ffffff; 
    --text: #1F2937; 
    --muted: #6B7280; 
    --border: #E5E7EB;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none;}
  body{margin:0; font-family:'Inter', sans-serif; background:var(--bg); height:100dvh; display:flex; justify-content:center; overflow:hidden;}
  
  #app{width:100%; max-width:600px; height:100%; background:var(--white); position:relative; display:flex; flex-direction:column; box-shadow: 0 0 40px rgba(0,0,0,0.05);}
  
  /* --- HEADER (KURUMSAL) --- */
  #topbar{
    height:64px; display:flex; align-items:center; justify-content:space-between; 
    padding:0 20px; border-bottom:1px solid var(--border);
    background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); z-index: 20;
  }
  .brand{ font-weight:800; color:var(--text); font-size:22px; display: flex; align-items: center; gap: 8px; letter-spacing: -0.5px; } 
  .brand i { color: var(--primary); font-size: 20px; } 
  .brand span{color:var(--primary);}
  .menu-btn { font-size: 20px; color: var(--text); cursor: pointer; padding: 8px; transition: 0.2s; }
  .menu-btn:active { transform: scale(0.9); }
  
  /* --- SIDE MENU --- */
  #sideMenu {
    position: absolute; top:0; right:-100%; width: 280px; height: 100%;
    background: #fff; box-shadow: -10px 0 30px rgba(0,0,0,0.1);
    z-index: 100; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 0; display: flex; flex-direction: column;
  }
  #sideMenu.open { right: 0; }
  .menu-header { padding: 24px; border-bottom: 1px solid var(--border); display:flex; justify-content:space-between; align-items:center;}
  .close-btn { font-size: 24px; color: var(--muted); cursor: pointer; }
  .menu-content { padding: 20px; flex: 1; overflow-y: auto; }
  .menu-item { display: flex; align-items: center; gap: 12px; padding: 14px 0; color: var(--text); font-weight: 600; font-size: 15px; cursor: pointer; transition: 0.2s; }
  .menu-item:hover { color: var(--primary); transform: translateX(5px); }
  .menu-item i { width: 24px; text-align: center; color: var(--muted); }
  .menu-item:hover i { color: var(--primary); }
  
  #overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.3); z-index: 90; display: none; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(2px); }
  #overlay.active { display: block; opacity: 1; }

  /* --- CHAT ALANI --- */
  #main{flex:1; overflow-y:auto; padding:20px; padding-bottom:180px; scroll-behavior: smooth;}
  
  .welcome-box { text-align: center; margin-top: 40px; padding: 20px; animation: fadeIn 0.5s ease; }
  .welcome-icon { font-size: 40px; color: var(--primary); margin-bottom: 15px; background: #ECFDF5; width: 80px; height: 80px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }
  .welcome-title { font-size: 20px; font-weight: 800; color: var(--text); margin-bottom: 8px; }
  .welcome-desc { font-size: 14px; color: var(--muted); line-height: 1.6; max-width: 80%; margin: 0 auto; }
  
  .msg{display:flex; margin-bottom:16px; animation: slideIn 0.3s ease;}
  @keyframes slideIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
  .msg.user{justify-content:flex-end;} .msg.ai{justify-content:flex-start;}
  
  .bubble{ max-width:85%; padding:12px 16px; border-radius:18px; font-size:15px; line-height:1.5; box-shadow: 0 2px 4px rgba(0,0,0,0.02); position: relative; }
  .msg.user .bubble{background:var(--primary); color:#fff; border-bottom-right-radius:4px;}
  .msg.ai .bubble{background:#F3F4F6; color:var(--text); border-bottom-left-radius:4px;}
  .bubble img.preview { max-width: 100%; border-radius: 12px; margin-bottom: 8px; }

  /* CARDS & TABLES */
  .cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
  .card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; flex-direction:column; transition: 0.2s; }
  .card:active { transform: scale(0.98); }
  .pimg{ width:100%; height:120px; object-fit:contain; margin-bottom:8px; }
  .title{ font-size:13px; font-weight:600; height:36px; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; margin-bottom: 4px; }
  .price{ font-size:14px; font-weight:800; color:var(--primary); }
  .btnLink{ background:var(--primary); color:#fff; padding:8px; border-radius:8px; text-align:center; font-size:11px; font-weight:700; text-decoration:none; margin-top:auto; display:block; }
  
  /* --- BOTTOM AREA (GÃœNCELLENDÄ°) --- */
  #bottom{ position:absolute; bottom:0; left:0; right:0; background:#fff; padding:0; z-index: 50; border-top: 1px solid var(--border); }
  
  /* RENKLÄ° MODÃœL SEÃ‡Ä°CÄ° */
  #dock { display: flex; gap: 10px; overflow-x: auto; padding: 12px 16px; background: #fff; scrollbar-width: none; }
  #dock::-webkit-scrollbar { display: none; }
  .chip { 
    display: flex; align-items: center; gap: 6px; 
    padding: 8px 14px; border-radius: 20px; 
    font-size: 13px; font-weight: 600; cursor: pointer; 
    white-space: nowrap; transition: 0.2s; border: 1px solid var(--border); color: var(--muted);
    background: #fff;
  }
  .chip i { font-size: 14px; }
  
  /* Aktif Mod Renkleri */
  .chip.active { color: #fff; border-color: transparent; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  .chip.active.shopping { background: #10B981; }
  .chip.active.chat { background: #6366F1; }
  .chip.active.health { background: #EF4444; }
  .chip.active.diet { background: #84CC16; }
  .chip.active.law { background: #3B82F6; }
  .chip.active.fal { background: #8B5CF6; }
  .chip.active.food { background: #F59E0B; }
  .chip.active.dream { background: #0EA5E9; }
  .chip.active.astro { background: #D946EF; }
  .chip.active.translate { background: #64748B; }

  /* INPUT AREA */
  #inputArea { padding: 10px 16px; display:flex; gap:10px; align-items: center; background: #fff; }
  .actionBtn { width: 40px; height: 40px; border-radius: 50%; background: #F3F4F6; color: var(--muted); border: none; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
  .actionBtn:active { transform: scale(0.9); }
  .mic-active { background: #FEE2E2; color: #EF4444; animation: pulse 1s infinite; }
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)}70%{box-shadow:0 0 0 10px rgba(239,68,68,0)}}
  
  #text { flex:1; padding:12px 16px; border:1px solid var(--border); border-radius:24px; font-size:15px; outline:none; transition: 0.2s; }
  #text:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
  
  #sendBtn { width: 44px; height: 44px; border-radius: 50%; background: var(--primary); color: #fff; border: none; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); transition: 0.2s; }
  #sendBtn:active { transform: scale(0.9); }

  /* FOOTER */
  #footer { font-size: 10px; text-align: center; padding: 8px; color: var(--muted); font-weight: 600; background: #FAFAFA; border-top: 1px solid rgba(0,0,0,0.03); letter-spacing: 0.5px; }
  
  .audio-btn { margin-top: 8px; padding: 8px 14px; background: #F3F4F6; color: var(--text); border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; border: 1px solid var(--border); }
  .audio-btn.playing { background: #FEF2F2; color: #EF4444; border-color: #EF4444; }
  
  /* MODAL */
  .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
  .modal.active { display: flex; animation: fadeIn 0.2s; }
  .modal-box { background: #fff; width: 100%; max-width: 350px; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); transform: translateY(20px); animation: slideUp 0.3s forwards; }
  .modal-header { padding: 20px; background: var(--primary); color: #fff; display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
  .modal-body { padding: 25px; text-align: center; color: var(--text); line-height: 1.5; font-size: 14px; }
  @keyframes slideUp { to { transform: translateY(0); } }
</style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <div class="brand" onclick="location.reload()">
      <i class="fa-solid fa-sparkles"></i> CAYNANA<span>.AI</span>
    </div>
    <div class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars-staggered"></i></div>
  </div>

  <div id="overlay" onclick="toggleMenu()"></div>
  
  <div id="sideMenu">
    <div class="menu-header">
        <div class="brand" style="font-size:18px;"><i class="fa-solid fa-sparkles"></i> CAYNANA</div>
        <div class="close-btn" onclick="toggleMenu()">&times;</div>
    </div>
    <div class="menu-content">
        <div class="menu-item" onclick="showModal('soon', 'Ãœyelik')"><i class="fa-regular fa-user"></i> Ãœye Ol / GiriÅŸ</div>
        <div class="menu-item" onclick="showModal('about')"><i class="fa-solid fa-circle-info"></i> HakkÄ±mÄ±zda</div>
        <div class="menu-item" onclick="showModal('privacy')"><i class="fa-solid fa-shield-halved"></i> Gizlilik</div>
        <div class="menu-item" onclick="showModal('contact')"><i class="fa-regular fa-envelope"></i> Ä°letiÅŸim</div>
    </div>
    <div style="padding: 20px; text-align: center; font-size: 11px; color: #999;">v2.0 Beta</div>
  </div>

  <div class="modal" id="infoModal">
    <div class="modal-box">
      <div class="modal-header">
        <span id="modalTitle">BaÅŸlÄ±k</span>
        <span onclick="closeModal()" style="cursor:pointer">&times;</span>
      </div>
      <div class="modal-body" id="modalContent">...</div>
    </div>
  </div>

  <div id="main">
    <div class="welcome-box">
        <div class="welcome-icon"><i class="fa-solid fa-bag-shopping"></i></div>
        <div class="welcome-title" id="welcomeTitle">AlÄ±ÅŸveriÅŸ UzmanÄ±</div>
        <div class="welcome-desc" id="welcomeDesc">En uygun fiyatÄ±, en gÃ¼venilir satÄ±cÄ±yÄ± bulurum. Ne arÄ±yorsun evladÄ±m?</div>
    </div>
  </div>

  <div id="bottom">
    <div id="dock"></div> <div id="inputArea">
      <button class="actionBtn" onclick="openCamera()"><i class="fa-solid fa-camera"></i></button>
      <button class="actionBtn" id="micBtn" onclick="startMic()"><i class="fa-solid fa-microphone"></i></button>
      <input id="text" placeholder="Ne arÄ±yorsun evladÄ±m?" autocomplete="off" onkeypress="if(event.key==='Enter') send()">
      <button id="sendBtn" onclick="send()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
    
    <div id="footer">@CAYNANA BY ITALKY TECHNOLOGY</div>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" style="display:none" capture="environment">

<script>
  const API_URL = "https://bikonomi-api-2.onrender.com/api/chat";
  const SPEAK_URL = "https://bikonomi-api-2.onrender.com/api/speak";
  
  let sessionId = "sess_" + Math.random().toString(36).substr(2, 9);
  let currentAudio = null;
  let pendingImage = null;
  let currentMode = "shopping";

  // MOD LÄ°STESÄ° (Ä°konlar ve Renk KodlarÄ± CSS'te)
  const MODES = {
    chat: { label: "Sohbet", icon: "fa-comments", title: "Dert OrtaÄŸÄ±", desc: "CanÄ±n mÄ± sÄ±kkÄ±n? Gel iki lafÄ±n belini kÄ±ralÄ±m.", ph: "Naber Caynana?" },
    shopping: { label: "AlÄ±ÅŸveriÅŸ", icon: "fa-bag-shopping", title: "AlÄ±ÅŸveriÅŸ UzmanÄ±", desc: "En uygun fiyatÄ± ve en iyi yorumu bulurum.", ph: "Ne lazÄ±m evladÄ±m?" },
    health: { label: "SaÄŸlÄ±k", icon: "fa-heart-pulse", title: "SaÄŸlÄ±k KÃ¶ÅŸesi", desc: "Åžikayetini sÃ¶yle, nane-limon tadÄ±nda tavsiye vereyim.", ph: "Neren aÄŸrÄ±yor?" },
    diet: { label: "Diyet", icon: "fa-carrot", title: "Diyetisyen", desc: "Boyunu kilonu yaz, sana Ã¶zel menÃ¼ Ã§Ä±karayÄ±m.", ph: "Boy kilo kaÃ§?" },
    food: { label: "Yemek", icon: "fa-utensils", title: "Mutfak CadÄ±sÄ±", desc: "Dolapta ne var sÃ¶yle, yemek uydurayÄ±m.", ph: "Malzeme ne?" },
    law: { label: "Hukuk", icon: "fa-scale-balanced", title: "Adliye Teyzesi", desc: "Derdini anlat, yol yordam gÃ¶stereyim.", ph: "Mahkemelik mi oldun?" },
    translate: { label: "Ã‡eviri", icon: "fa-language", title: "TercÃ¼man", desc: "YazÄ±yÄ± veya resmi gÃ¶nder, Ã§evireyim.", ph: "Ne yazÄ±yor orada?" },
    astro: { label: "BurÃ§", icon: "fa-star", title: "YÄ±ldÄ±zlar", desc: "Burcunu sÃ¶yle, bugÃ¼nÃ¼ yorumlayayÄ±m.", ph: "Hangi burÃ§sun?" },
    dream: { label: "RÃ¼ya", icon: "fa-cloud-moon", title: "RÃ¼ya Tabiri", desc: "RÃ¼yanÄ± anlat, hayra yoralÄ±m.", ph: "Ne gÃ¶rdÃ¼n?" },
    fal: { label: "Fal", icon: "fa-mug-hot", title: "FalcÄ± BacÄ±", desc: "FincanÄ± Ã§ek gÃ¶nder, geleceÄŸi gÃ¶reyim.", ph: "Fincan hazÄ±r mÄ±?" }
  };

  // --- RENKLÄ° Ã‡Ä°P MENÃœSÃœ ---
  function renderDock(){
    const dock = document.getElementById("dock");
    dock.innerHTML = "";
    Object.keys(MODES).forEach(key => {
        const m = MODES[key];
        const chip = document.createElement("div");
        // CSS class'Ä±nÄ± dinamik veriyoruz (Ã¶rn: chip active shopping)
        chip.className = `chip ${key} ${key === currentMode ? 'active' : ''}`;
        chip.onclick = () => switchMode(key);
        chip.innerHTML = `<i class="fa-solid ${m.icon}"></i> ${m.label}`;
        dock.appendChild(chip);
    });
  }

  function switchMode(key){
    currentMode = key;
    renderDock();
    
    // UI GÃ¼ncelle
    const m = MODES[key];
    document.getElementById("text").placeholder = m.ph;
    document.querySelector(".welcome-icon").innerHTML = `<i class="fa-solid ${m.icon}"></i>`;
    document.querySelector(".welcome-title").innerText = m.title;
    document.querySelector(".welcome-desc").innerText = m.desc;
    
    // Welcome box gÃ¶ster, chat'i temizle
    document.getElementById("main").innerHTML = `
        <div class="welcome-box">
            <div class="welcome-icon"><i class="fa-solid ${m.icon}"></i></div>
            <div class="welcome-title">${m.title}</div>
            <div class="welcome-desc">${m.desc}</div>
        </div>
    `;
  }

  // --- RESÄ°M YÃœKLEME (AKILLI MESAJ) ---
  const fileEl = document.getElementById("fileInput");
  function openCamera(){ fileEl.value = ""; fileEl.click(); }
  
  fileEl.addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{ 
        pendingImage = reader.result; 
        
        // MODA GÃ–RE AKILLI MESAJ
        let autoMsg = "ðŸ“· Bu ne?";
        if(currentMode === "shopping") autoMsg = "Bu Ã¼rÃ¼nÃ¼ bul";
        else if(currentMode === "fal") autoMsg = "FincanÄ± yorumla";
        else if(currentMode === "translate") autoMsg = "Bunu Ã§evir";
        else if(currentMode === "diet") autoMsg = "Bu kaÃ§ kalori?";
        
        document.getElementById("text").value = autoMsg; 
        send();
    };
    reader.readAsDataURL(file);
  });

  // --- MESAJLAÅžMA ---
  async function send(){
    const txtEl = document.getElementById("text");
    let val = txtEl.value.trim();
    if(!val && !pendingImage) return;
    
    addBubble("user", val, false, null, pendingImage);
    txtEl.value = "";
    document.querySelector(".welcome-box")?.remove(); // Ä°lk mesajda welcome silinir
    
    const loader = addBubble("ai", "<i class='fa-solid fa-circle-notch fa-spin'></i>", true);
    const payload = { message: val, session_id: sessionId, image: pendingImage, mode: currentMode };
    pendingImage = null;

    try{
      const res = await fetch(API_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload) });
      const data = await res.json();
      loader.remove();
      addBubble("ai", data.assistant_text, false, data.speech_text);
      if(data.data && data.data.length) renderCards(data.data);
    }catch(e){ loader.innerHTML = "BaÄŸlantÄ± koptu evladÄ±m."; }
  }

  function addBubble(role, text, isLoader=false, speech=null, imgData=null){
    const div = document.createElement("div");
    div.className = "msg " + role;
    let content = "";
    if(imgData) content += `<img src="${imgData}" class="preview">`;
    // Markdown
    let htmlContent = (role === "ai" && !isLoader) ? marked.parse(text) : text;
    div.innerHTML = `<div class="bubble">${content + htmlContent}</div>`;
    document.getElementById("main").appendChild(div);
    setTimeout(() => { div.scrollIntoView({behavior:"smooth", block:"start"}); }, 100);
    
    if(speech && role === "ai" && !isLoader){
        const btn = document.createElement("div");
        btn.className = "audio-btn";
        btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Dinle`;
        btn.onclick = () => playAudio(speech, btn);
        div.querySelector(".bubble").appendChild(btn);
    }
    return div;
  }

  // --- DÄ°ÄžER FONKSÄ°YONLAR ---
  function toggleMenu(){
    const menu = document.getElementById("sideMenu");
    const overlay = document.getElementById("overlay");
    if(menu.classList.contains("open")){ menu.classList.remove("open"); overlay.classList.remove("active"); }
    else { menu.classList.add("open"); overlay.classList.add("active"); }
  }
  
  function closeModal() { document.getElementById('infoModal').classList.remove('active'); }
  
  const staticContent = {
    about: "Biz Italky Teknoloji A.Åž. olarak yerli yapay zeka geliÅŸtiriyoruz.",
    contact: "Bize ulaÅŸÄ±n: destek@caynana.com",
    soon: "Bu Ã¶zellik Ã§ok yakÄ±nda aktif olacak evladÄ±m."
  };
  function showModal(type, title){
    toggleMenu();
    document.getElementById('modalTitle').innerText = title || "Bilgi";
    document.getElementById('modalContent').innerHTML = staticContent[type] || "Ä°Ã§erik yok.";
    document.getElementById('infoModal').classList.add('active');
  }

  function startMic(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) { alert("TarayÄ±cÄ±n mikrofonu desteklemiyor."); return; }
    const rec = new SR(); rec.lang = "tr-TR";
    const btn = document.getElementById("micBtn");
    btn.classList.add("mic-active");
    rec.onresult = (e) => { document.getElementById("text").value = e.results[0][0].transcript; btn.classList.remove("mic-active"); send(); };
    rec.onend = () => btn.classList.remove("mic-active");
    rec.start();
  }

  async function playAudio(text, btn){
    if(currentAudio) { currentAudio.pause(); currentAudio = null; btn.classList.remove("playing"); btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Dinle`; return; }
    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
    try{
        const res = await fetch(SPEAK_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({text}) });
        const blob = await res.blob();
        currentAudio = new Audio(URL.createObjectURL(blob));
        currentAudio.onended = () => { btn.classList.remove("playing"); btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Dinle`; currentAudio = null; };
        await currentAudio.play();
        btn.classList.add("playing");
        btn.innerHTML = `<i class="fa-solid fa-stop"></i> Durdur`;
    }catch(e){ btn.innerHTML = "Hata"; }
  }

  // BaÅŸlat
  renderDock();
</script>
</body>
</html>
