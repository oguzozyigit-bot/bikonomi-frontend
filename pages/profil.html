<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Profil AyarlarÄ±</title>

<style>
  :root { --bg:#0e0e0e; --text:#ececec; --gold:#ffb300; --pist:#bef264; --card:#1a1a1a; --border:#2a2a2a; --soft:#8c8c8c; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; scrollbar-width:none; -ms-overflow-style:none; }
  *::-webkit-scrollbar{ display:none; width:0; height:0; }

  body{ margin:0; background:#000; color:var(--text);
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
        display:flex; justify-content:center; height:100vh; overflow:hidden; }

  .frame{ width:100%; max-width:480px; height:100%; background:var(--bg); display:flex; flex-direction:column; }
  @media (min-width:500px){ .frame{ height:95vh; margin-top:2.5vh; border-radius:24px; border:1px solid #333; box-shadow:0 0 50px rgba(255,255,255,.05);} }

  .header{
    padding:16px 16px 14px; border-bottom:1px solid var(--border); background:rgba(20,20,20,.95);
    display:flex; align-items:center; gap:12px;
  }
  .back-btn{
    width:38px; height:38px; border-radius:12px; border:1px solid #333;
    background:#121212; color:#fff; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center;
  }
  .title-wrap{ flex:1; text-align:center; margin-right:38px; }
  .title-wrap h2{ margin:0; font-size:16px; font-weight:800; }
  .title-wrap p{ margin:4px 0 0; font-size:12px; color:var(--soft); }

  .content{ flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:16px; }

  .card{
    background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;
  }
  .pill{
    display:inline-flex; gap:6px; align-items:center; font-size:11px; font-weight:800;
    background:var(--pist); color:#111; padding:4px 10px; border-radius:999px;
  }
  .muted{ color:#9a9a9a; font-size:12px; line-height:1.35; margin-top:8px; }
  .section-title{
    font-size:11px; color:var(--pist); font-weight:800; letter-spacing:1px; text-transform:uppercase;
    border-bottom:1px solid #232323; padding-bottom:8px; margin-bottom:10px;
  }
  .form-group{ display:flex; flex-direction:column; gap:8px; margin-bottom:6px; }
  label{ font-size:12px; color:#aaa; font-weight:600; margin-left:4px; }

  input, select{
    width:100%; background:#1a1a1a; border:1px solid #444; color:#fff;
    padding:14px; border-radius:12px; font-size:14px; outline:none; font-family:inherit;
    transition:.2s;
  }
  input:focus, select:focus{ border-color:var(--gold); background:#222; }

  .row{ display:flex; gap:12px; }
  .row > div{ flex:1; min-width:0; }

  .date-row{ display:flex; gap:8px; }
  .date-row select{ flex:1; padding:14px 6px; text-align:center; appearance:none; }

  .id-copy-box{
    display:flex; align-items:center; gap:10px; background:#111;
    padding:12px; border-radius:10px; border:1px dashed #444;
  }
  .id-text{ flex:1; font-family:monospace; color:var(--gold); font-size:12px; word-break:break-all; }
  .copy-btn{ background:none; border:none; cursor:pointer; font-size:18px; color:#777; }

  .conditional{ display:none; border-left:2px solid var(--gold); padding-left:14px; margin-left:4px; }
  .conditional.show{ display:block; animation:fadeIn .25s ease; }
  @keyframes fadeIn{ from{ opacity:0; transform:translateY(-6px);} to{opacity:1; transform:translateY(0);} }

  .children-wrap{ display:flex; flex-direction:column; gap:10px; }
  .child-card{
    background:#121212; border:1px solid #262626; border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:10px;
  }
  .mini{ font-size:11px; color:#8a8a8a; margin-left:4px; }

  .save-btn{
    background:var(--gold); color:#000; border:none; padding:16px; border-radius:14px;
    font-weight:900; font-size:15px; cursor:pointer; width:100%;
    box-shadow:0 8px 20px rgba(255,179,0,.15);
  }

  .footer{
    padding:12px 10px; text-align:center; border-top:1px solid #222; background:#000;
  }
  .footer .brand{ font-size:12px; color:#aaa; font-weight:700; letter-spacing:.3px; }
  .footer .slogan{ font-size:11px; color:#777; margin-top:4px; }

  /* Desktopâ€™ta kÃ¶ÅŸeye kaymasÄ±n, tam ortalansÄ±n */
  html, body { height:100%; }
  body{
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .frame{
    margin:0 auto;
  }

  /* âœ… Footer siyah bar gibi durmasÄ±n: premium fade */
  .footer{
    border-top:0 !important;
    background: linear-gradient(180deg, rgba(14,14,14,0), rgba(14,14,14,.75)) !important;
    padding:10px 10px 8px !important;
  }
  .footer .brand{
    color: rgba(255,255,255,.62) !important; /* kÄ±rÄ±k beyaz */
    font-size:11px !important;
  }
  .footer .slogan{ display:none !important; }
</style>
</head>

<body>
<div class="frame">
  <div class="header">
    <button class="back-btn" onclick="goBack()" title="Geri">â†</button>
    <div class="title-wrap">
      <h2>Profil AyarlarÄ±</h2>
      <p>Hepsi opsiyonel. Doldurursan Kaynana asistanÄ±n olur.</p>
    </div>
  </div>

  <div class="content">

    <div class="card">
      <div class="pill">ğŸ§¿ Kaynana Asistan</div>
      <div class="muted">
        EvladÄ±m, bu alanlarÄ± doldurursan gÃ¼nÃ¼ gelince <b>bildirimle hatÄ±rlatÄ±rÄ±m</b>:
        â€œBugÃ¼n eÅŸinin doÄŸum gÃ¼nÃ¼â€ gibiâ€¦<br><br>
        <b>HiÃ§biri zorunlu deÄŸil.</b> Doldurursan gÃ¼nlÃ¼k burÃ§ bildiriminden faydalanmak gibi dÃ¼ÅŸÃ¼n.
        <div style="margin-top:8px;">Ä°nan bana, bunlar hayat kurtarÄ±r ğŸ˜„</div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">Kimlik</div>

      <div class="form-group">
        <label>ID NumarasÄ± (DeÄŸiÅŸmez)</label>
        <div class="id-copy-box">
          <span id="formID" class="id-text">...</span>
          <button class="copy-btn" onclick="copyID()" title="Kopyala">ğŸ“‹</button>
        </div>
        <div class="mini" id="emailDisplay">Email: â€”</div>

        <div class="form-group" style="margin-top:10px;">
          <label>Ad Soyad (Googleâ€™dan gelir)</label>
          <input type="text" id="formFullname" placeholder="â€”" readonly disabled>
        </div>

        <div class="form-group" style="margin-top:10px;">
          <label>Profil FotoÄŸrafÄ±</label>
          <div style="display:flex; align-items:center; gap:12px;">
            <img id="avatarImg" src="" alt="avatar"
                 style="width:54px;height:54px;border-radius:999px;border:1px solid #333;object-fit:cover;display:none;">
            <div class="mini" id="avatarHint">Google profil foto varsa burada gÃ¶rÃ¼nÃ¼r.</div>
          </div>
        </div>

      </div>
    </div>

    <div class="card">
      <div class="section-title">Temel Bilgiler</div>

      <div class="form-group">
        <label>Caynana sana nasÄ±l hitap etsin?</label>
        <input type="text" id="formHitap" placeholder="Ã–rn: KÄ±zÄ±m, Gelinim, DamadÄ±m">
      </div>

      <div class="form-group">
        <label>Caynana'ya bir isim ver</label>
        <input type="text" id="formBotName" placeholder="Ã–rn: Sultan HanÄ±m, Åerife Teyze">
      </div>

      <div class="row">
        <div class="form-group">
          <label>Cinsiyet</label>
          <select id="formGender" onchange="toggleGenderFields()">
            <option value="">SeÃ§</option>
            <option value="KadÄ±n">KadÄ±n</option>
            <option value="Erkek">Erkek</option>
          </select>
        </div>
        <div class="form-group">
          <label>Medeni Durum</label>
          <select id="formStatus" onchange="toggleMarriedFields()">
            <option value="">SeÃ§</option>
            <option value="Bekar">Bekar</option>
            <option value="Evli">Evli</option>
          </select>
        </div>
      </div>

      <!-- âœ… YaÅŸadÄ±ÄŸÄ± Ä°l + DoÄŸduÄŸu Ä°l (81 il dropdown) -->
      <div class="row">
        <div class="form-group">
          <label>YaÅŸadÄ±ÄŸÄ± Ä°l</label>
          <select id="formCity">
            <option value="">SeÃ§</option>
          </select>
        </div>
        <div class="form-group">
          <label>DoÄŸduÄŸu Ä°l</label>
          <select id="formBirthCity">
            <option value="">SeÃ§</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label>TuttuÄŸu TakÄ±m</label>
          <input type="text" id="formTeam" placeholder="Ã–rn: BeÅŸiktaÅŸ">
        </div>
      </div>

      <div class="form-group">
        <label>DoÄŸum Tarihi (GÃ¼n / Ay / YÄ±l)</label>
        <div class="date-row">
          <select id="daySelect"><option value="">G</option></select>
          <select id="monthSelect">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
          <select id="yearSelect"><option value="">YÄ±l</option></select>
        </div>
        <div class="mini">Ä°stersen boÅŸ bÄ±rak. Ama girersen burÃ§/diyet gibi ÅŸeyler daha isabetli olur.</div>
      </div>
    </div>

    <!-- REGL TAKÄ°BÄ° -->
    <div class="card conditional" id="periodFields">
      <div class="section-title">Regl Takibi (opsiyonel)</div>
      <div class="mini">3 gÃ¼n kala sorarÄ±m. â€œHayÄ±râ€ dersen ertesi gÃ¼n yine sorarÄ±m. â€œ10 gÃ¼nâ€ olursaâ€¦ Kaynana konuÅŸur ğŸ˜„</div>

      <div class="form-group" style="margin-top:10px;">
        <label>Takip aÃ§Ä±k mÄ±?</label>
        <select id="periodEnabled">
          <option value="false">KapalÄ±</option>
          <option value="true">AÃ§Ä±k</option>
        </select>
      </div>

      <div class="form-group">
        <label>Son adet baÅŸlangÄ±Ã§ tarihi</label>
        <input type="date" id="lastPeriodStart">
      </div>

      <div class="row">
        <div class="form-group">
          <label>Ortalama dÃ¶ngÃ¼ (gÃ¼n)</label>
          <input type="number" id="cycleLength" value="28" min="21" max="35">
        </div>
        <div class="form-group">
          <label>Ortalama adet sÃ¼resi (gÃ¼n)</label>
          <input type="number" id="periodLength" value="5" min="3" max="8">
        </div>
      </div>

      <div class="mini">
        Not: Bu takip sadece hatÄ±rlatma iÃ§indir. SaÄŸlÄ±kla ilgili ciddi gecikmelerde bir uzmana danÄ±ÅŸmak iyi olur.
      </div>
    </div>

    <!-- EVLÄ° ALANLARI -->
    <div class="card conditional" id="marriedFields">
      <div class="section-title">Ã–zel GÃ¼nler (hayat kurtarÄ±r)</div>

      <div class="form-group">
        <label>EÅŸinin AdÄ±</label>
        <input type="text" id="formSpouse" placeholder="Yenge/EniÅŸte adÄ±">
      </div>

      <div class="form-group">
        <label>EÅŸinin DoÄŸum GÃ¼nÃ¼ (GÃ¼n / Ay)</label>
        <div class="date-row">
          <select id="spouseBDay"><option value="">G</option></select>
          <select id="spouseBMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Evlilik GÃ¼nÃ¼ (GÃ¼n / Ay)</label>
        <div class="date-row">
          <select id="wDay"><option value="">G</option></select>
          <select id="wMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>NiÅŸan GÃ¼nÃ¼ (GÃ¼n / Ay)</label>
        <div class="date-row">
          <select id="eDay"><option value="">G</option></select>
          <select id="eMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Ä°lk TanÄ±ÅŸma GÃ¼nÃ¼ (GÃ¼n / Ay)</label>
        <div class="date-row">
          <select id="mDay"><option value="">G</option></select>
          <select id="mMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
        </div>
      </div>

      <div class="mini">BunlarÄ± girersen Kaynana gÃ¼nÃ¼ gelince â€œunutma!â€ diye dÃ¼rter.</div>
    </div>

    <!-- Ã‡OCUKLAR -->
    <div class="card">
      <div class="section-title">Ã‡ocuklar (opsiyonel)</div>

      <div class="form-group">
        <label>Ã‡ocuk SayÄ±sÄ±</label>
        <select id="formChildCount" onchange="toggleChildFields()">
          <option value="0">Yok</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5+</option>
        </select>
      </div>

      <div class="conditional" id="childFields">
        <div class="children-wrap" id="childrenContainer"></div>
        <div class="mini" style="margin-top:8px;">Ã‡ocuÄŸun adÄ±nÄ± ve doÄŸum gÃ¼nÃ¼nÃ¼ girersen, gÃ¼nÃ¼ gelince hatÄ±rlatÄ±rÄ±m.</div>
      </div>
    </div>

    <button class="save-btn" onclick="saveProfile()">ğŸ’¾ KAYDET VE BAÅLA</button>

  </div>

  <div class="footer">
    <div class="brand">@CaynanaAI By Ozyigit's 2026</div>
    <div class="slogan">Yapay ZekÃ¢nÄ±n Geleneksel AklÄ±</div>
  </div>
</div>

<!-- âœ… KÄ±rÄ±k "container.innerHTML..." Ã§Ã¶p bloÄŸu tamamen kaldÄ±rÄ±ldÄ± -->

<script type="module">
  import { BASE_DOMAIN, STORAGE_KEY } from '../js/config.js';

  const PROFILE_KEY = "caynana_profile_v2";
  const PROFILE_BONUS_KEY = "caynana_profile_bonus_v1"; // +5 sadece bir kez
  const GENERATED_IDS_KEY = "caynana_generated_ids_v1"; // Ã¼retilen idâ€™ler (Ã§akÄ±ÅŸma olmasÄ±n)

  // --------- helpers ----------
  const pad2 = (n) => String(n).padStart(2, "0");

  const TR_CITIES_81 = [
    "Adana","AdÄ±yaman","Afyonkarahisar","AÄŸrÄ±","Amasya","Ankara","Antalya","Artvin","AydÄ±n","BalÄ±kesir",
    "Bilecik","BingÃ¶l","Bitlis","Bolu","Burdur","Bursa","Ã‡anakkale","Ã‡ankÄ±rÄ±","Ã‡orum","Denizli",
    "DiyarbakÄ±r","Edirne","ElazÄ±ÄŸ","Erzincan","Erzurum","EskiÅŸehir","Gaziantep","Giresun","GÃ¼mÃ¼ÅŸhane","Hakkari",
    "Hatay","Isparta","Mersin","Ä°stanbul","Ä°zmir","Kars","Kastamonu","Kayseri","KÄ±rklareli","KÄ±rÅŸehir",
    "Kocaeli","Konya","KÃ¼tahya","Malatya","Manisa","KahramanmaraÅŸ","Mardin","MuÄŸla","MuÅŸ","NevÅŸehir",
    "NiÄŸde","Ordu","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","TekirdaÄŸ","Tokat",
    "Trabzon","Tunceli","ÅanlÄ±urfa","UÅŸak","Van","Yozgat","Zonguldak","Aksaray","Bayburt","Karaman",
    "KÄ±rÄ±kkale","Batman","ÅÄ±rnak","BartÄ±n","Ardahan","IÄŸdÄ±r","Yalova","KarabÃ¼k","Kilis","Osmaniye","DÃ¼zce"
  ];

  function fillCitySelects(){
    const s1 = document.getElementById("formCity");
    const s2 = document.getElementById("formBirthCity");
    if(!s1 || !s2) return;

    if(s1.dataset.filled === "1" && s2.dataset.filled === "1") return;

    const makeOpts = () => TR_CITIES_81.map(c => `<option value="${c}">${c}</option>`).join("");

    s1.insertAdjacentHTML("beforeend", makeOpts());
    s2.insertAdjacentHTML("beforeend", makeOpts());

    s1.dataset.filled = "1";
    s2.dataset.filled = "1";
  }

  function daysInMonth(year, month){ // month: 1-12
    if(!year || !month) return 31;
    const y = parseInt(year,10);
    const m = parseInt(month,10);
    if(!y || !m) return 31;
    return new Date(y, m, 0).getDate();
  }

  function fillDayOptions(selectId, maxDays=31){
    const s = document.getElementById(selectId);
    if(!s) return;

    const cur = s.value || "";
    s.innerHTML = `<option value="">G</option>`;
    for(let i=1;i<=maxDays;i++){
      s.innerHTML += `<option value="${pad2(i)}">${i}</option>`;
    }
    if(cur){
      const n = parseInt(cur,10) || 0;
      if(n >= 1 && n <= maxDays) s.value = pad2(n);
    }
  }

  function fillYearOptions(selectId, start=1950){
    const s = document.getElementById(selectId);
    if(!s) return;
    if(s.dataset.filled === "1") return;
    const nowY = new Date().getFullYear();
    for(let y=nowY; y>=start; y--){
      s.innerHTML += `<option value="${y}">${y}</option>`;
    }
    s.dataset.filled = "1";
  }

  function refreshBirthDayOptions(){
    const y = document.getElementById("yearSelect")?.value || "";
    const m = document.getElementById("monthSelect")?.value || "";
    const max = daysInMonth(y, m);
    fillDayOptions("daySelect", max);
  }

  function isValidDM(d, m){
    const dd = parseInt(d,10);
    const mm = parseInt(m,10);
    if(!dd || !mm) return false;
    if(mm < 1 || mm > 12) return false;
    const max = new Date(2024, mm, 0).getDate(); // 2024: leap year
    return dd >= 1 && dd <= max;
  }

  function isValidBirthDate(d, m, y){
    const dd = parseInt(d,10), mm = parseInt(m,10), yy = parseInt(y,10);
    if(!dd || !mm || !yy) return false;
    if(mm < 1 || mm > 12) return false;
    const max = new Date(yy, mm, 0).getDate();
    return dd >= 1 && dd <= max;
  }

  function getDM(dayId, monthId){
    const d = document.getElementById(dayId)?.value || "";
    const m = document.getElementById(monthId)?.value || "";
    if((d && !m) || (!d && m)) return { ok:false, value:"" };
    return { ok:true, value: (d && m) ? `${d}.${m}` : "" };
  }

  function setDM(dayId, monthId, val){
    if(!val) return;
    const p = String(val).split(".");
    if(p.length===2){
      const d = document.getElementById(dayId);
      const m = document.getElementById(monthId);
      if(d) d.value = p[0];
      if(m) m.value = p[1];
    }
  }

  function getBirthDate(){
    const d = document.getElementById('daySelect')?.value || "";
    const m = document.getElementById('monthSelect')?.value || "";
    const y = document.getElementById('yearSelect')?.value || "";

    const any = !!(d || m || y);
    const full = !!(d && m && y);
    if(any && !full) return { ok:false, value:"" };
    if(full && !isValidBirthDate(d,m,y)) return { ok:false, value:"" };
    return { ok:true, value: full ? `${d}.${m}.${y}` : "" };
  }

  function setBirthDate(val){
    if(!val) return;
    const p = String(val).split(".");
    if(p.length===3){
      const d = document.getElementById('daySelect');
      const m = document.getElementById('monthSelect');
      const y = document.getElementById('yearSelect');
      if(d) d.value = p[0];
      if(m) m.value = p[1];
      if(y) y.value = p[2];
      refreshBirthDayOptions();
    }
  }

  // âœ… ID normalize (bu sayfa kendi iÃ§inde emniyetli olsun)
  function norm(v){ return String(v || "").trim(); }

  function randInt(min, max){
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function pickLetter(except){
    const A = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let ch = "";
    for(let t=0;t<50;t++){
      ch = A[randInt(0, A.length-1)];
      if(ch !== except) return ch;
    }
    return ch || "X";
  }

  // âœ… ardÄ±ÅŸÄ±k yok + aynÄ± tekrar yok (yan yana)
  function buildNonSequentialDigits(len=8){
    const digits = [];
    for(let i=0;i<len;i++){
      let d = randInt(0,9);
      for(let t=0;t<100;t++){
        const prev = digits[i-1];
        const prev2 = digits[i-2];

        const ok1 = (prev === undefined) ? true : (d !== prev && Math.abs(d - prev) !== 1);
        const ok2 = (prev2 === undefined) ? true : (d !== prev2);

        if(ok1 && ok2) break;
        d = randInt(0,9);
      }
      digits.push(d);
    }
    return digits.join("");
  }

  function getGeneratedIds(){
    try{
      const a = JSON.parse(localStorage.getItem(GENERATED_IDS_KEY) || "[]");
      return Array.isArray(a) ? a : [];
    }catch(e){ return []; }
  }

  function saveGeneratedId(id){
    const ids = getGeneratedIds();
    if(!ids.includes(id)) ids.push(id);
    try{ localStorage.setItem(GENERATED_IDS_KEY, JSON.stringify(ids)); }catch(e){}
  }

  function generateStableRandomId(){
    const used = new Set(getGeneratedIds());

    for(let tries=0; tries<200; tries++){
      const a = pickLetter("");
      const b = pickLetter(a);
      const nums = buildNonSequentialDigits(8);
      const id = `${a}${b}${nums}`;
      if(!used.has(id)){
        saveGeneratedId(id);
        return id;
      }
    }
    const fallback = `XZ${buildNonSequentialDigits(8)}`;
    saveGeneratedId(fallback);
    return fallback;
  }

  function ensureIdentity(user){
    if(!user || typeof user !== "object") user = {};

    user.id = norm(user.id);
    user.email = norm(user.email);
    user.user_id = norm(user.user_id);

    // âœ… ID gmail'den alÄ±nmaz. Yoksa random Ã¼ret.
    if(!user.id){
      user.id = generateStableRandomId();
    }

    if(!user.user_id) user.user_id = user.email || user.id;
    if(!user.id) user.id = user.user_id;

    return user;
  }

  function getUser(){
    let user = {};
    try { user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch {}
    user = ensureIdentity(user);

    // kimlik yoksa bu sayfaya gelmesin
    if(!user.id){
      alert("GiriÅŸ yapmamÄ±ÅŸsÄ±n!");
      window.location.href = "../index.html";
      return null;
    }

    // normalize edilmiÅŸ hali geri yaz
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(user)); } catch {}
    return user;
  }

  // âœ… Clipboard: mobil fallback
  async function safeCopy(text){
    const t = String(text || "");
    if(!t) return false;
    try{
      await navigator.clipboard.writeText(t);
      return true;
    }catch(e){
      try{
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        return true;
      }catch(e2){
        return false;
      }
    }
  }

  // --------- toggles ----------
  window.toggleMarriedFields = function(){
    const val = document.getElementById('formStatus')?.value || "";
    document.getElementById('marriedFields')?.classList.toggle('show', val === 'Evli');
  };

  window.toggleChildFields = function(){
    const val = parseInt(document.getElementById('formChildCount')?.value,10) || 0;
    const div = document.getElementById('childFields');
    const container = document.getElementById('childrenContainer');

    if(!div || !container) return;

    if(val <= 0){
      div.classList.remove('show');
      container.innerHTML = "";
      return;
    }
    div.classList.add('show');

    const count = Math.min(val, 5);
    container.innerHTML = "";
    for(let i=1;i<=count;i++){
      const box = document.createElement('div');
      box.className = "child-card";

      box.innerHTML = `
        <div class="mini">Ã‡ocuk ${i}</div>

        <div class="form-group" style="margin:0;">
          <label>Ad</label>
          <input type="text" id="child_name_${i}" placeholder="Ã–rn: Ali">
        </div>

        <div class="form-group" style="margin:0;">
          <label>DoÄŸum GÃ¼nÃ¼ (GÃ¼n / Ay)</label>
          <div class="date-row">
            <select id="child_day_${i}"><option value="">G</option></select>
            <select id="child_month_${i}">
              <option value="">Ay</option>
              <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
              <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
              <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
              <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
            </select>
          </div>
        </div>
      `;
      container.appendChild(box);

      // Ã§ocuk gÃ¼nleri max 31; validasyon save'de yapÄ±lÄ±yor
      fillDayOptions(`child_day_${i}`, 31);
    }
  };

  window.toggleGenderFields = function(){
    const g = document.getElementById('formGender')?.value || "";
    const period = document.getElementById('periodFields');
    period?.classList.toggle('show', g === 'KadÄ±n');
  };

  // --------- navigation ----------
  window.goBack = function(){
    window.location.href = "../index.html";
  };

  // âœ… copyID artÄ±k emniyetli
  window.copyID = async function(){
    const t = document.getElementById('formID')?.innerText || "";
    const ok = await safeCopy(t);
    alert(ok ? "ID KopyalandÄ±" : ("KopyalanamadÄ±. ID: " + t));
  };

  // --------- fill form ----------
  function fillFormFields(meta){
    if(!meta || typeof meta !== "object") return;

    if(meta.hitap) document.getElementById('formHitap').value = meta.hitap;
    if(meta.bot_name) document.getElementById('formBotName').value = meta.bot_name;

    if(meta.gender){
      document.getElementById('formGender').value = meta.gender;
      toggleGenderFields();
    }
    if(meta.marital_status){
      document.getElementById('formStatus').value = meta.marital_status;
      toggleMarriedFields();
    }

    if(meta.region) document.getElementById('formCity').value = meta.region;
    if(meta.birth_city) document.getElementById('formBirthCity').value = meta.birth_city;
    if(meta.team) document.getElementById('formTeam').value = meta.team;

    if(meta.birth_date) setBirthDate(meta.birth_date);

    // evli alanlar
    if(meta.spouse_name) document.getElementById('formSpouse').value = meta.spouse_name;
    setDM("spouseBDay","spouseBMonth", meta.spouse_bday_dm);
    setDM("wDay","wMonth", meta.wedding_dm);
    setDM("eDay","eMonth", meta.engagement_dm);
    setDM("mDay","mMonth", meta.met_dm);

    // Ã§ocuklar
    if(meta.child_count !== undefined && meta.child_count !== null){
      document.getElementById('formChildCount').value = String(meta.child_count);
      toggleChildFields();

      const kids = Array.isArray(meta.children) ? meta.children : [];
      kids.forEach((k, idx) => {
        const i = idx + 1;
        const nameEl = document.getElementById(`child_name_${i}`);
        if(nameEl && k?.name) nameEl.value = k.name;

        if(k?.bday_dm){
          const p = String(k.bday_dm).split(".");
          if(p.length===2){
            const dEl = document.getElementById(`child_day_${i}`);
            const mEl = document.getElementById(`child_month_${i}`);
            if(dEl) dEl.value = p[0];
            if(mEl) mEl.value = p[1];
          }
        }
      });
    }

    // regl
    if(meta.period_tracking_enabled !== undefined){
      document.getElementById('periodEnabled').value = String(!!meta.period_tracking_enabled);
    }
    if(meta.last_period_start){
      document.getElementById('lastPeriodStart').value = meta.last_period_start;
    }
    if(meta.cycle_length_days){
      document.getElementById('cycleLength').value = meta.cycle_length_days;
    }
    if(meta.period_length_days){
      document.getElementById('periodLength').value = meta.period_length_days;
    }
  }

  // --------- save ----------
  window.saveProfile = async function(){
    const user = getUser();
    if(!user) return;

    // doÄŸum tarihi kontrol
    const bd = getBirthDate();
    if(!bd.ok){
      alert("DoÄŸum tarihini GÃ¼n/Ay/YÄ±l geÃ§erli olacak ÅŸekilde tam seÃ§ ya da tamamen boÅŸ bÄ±rak.");
      return;
    }

    // âœ… 30 Åubat vb. geÃ§ersiz gÃ¼n/aylarÄ± engelle (eÅŸ/Ã¶zel gÃ¼nler)
    const pairs = [
      { label:"EÅŸinin doÄŸum gÃ¼nÃ¼", d: document.getElementById("spouseBDay")?.value, m: document.getElementById("spouseBMonth")?.value },
      { label:"Evlilik gÃ¼nÃ¼", d: document.getElementById("wDay")?.value, m: document.getElementById("wMonth")?.value },
      { label:"NiÅŸan gÃ¼nÃ¼", d: document.getElementById("eDay")?.value, m: document.getElementById("eMonth")?.value },
      { label:"Ä°lk tanÄ±ÅŸma gÃ¼nÃ¼", d: document.getElementById("mDay")?.value, m: document.getElementById("mMonth")?.value }
    ];
    for(const p of pairs){
      const any = !!(p.d || p.m);
      const full = !!(p.d && p.m);
      if(full && !isValidDM(p.d, p.m)){
        alert(`${p.label} iÃ§in geÃ§ersiz tarih seÃ§tin.`);
        return;
      }
      if(any && !full){
        alert(`${p.label} iÃ§in GÃ¼n/Ay ikilisini ya tam seÃ§, ya tamamen boÅŸ bÄ±rak.`);
        return;
      }
    }

    // evli gÃ¼n/ay stringleri
    const spouseB = getDM("spouseBDay","spouseBMonth");
    const wed = getDM("wDay","wMonth");
    const eng = getDM("eDay","eMonth");
    const met = getDM("mDay","mMonth");

    // Ã§ocuklar
    const childCount = parseInt(document.getElementById('formChildCount')?.value,10) || 0;
    const kids = [];
    const maxKids = Math.min(childCount, 5);
    for(let i=1;i<=maxKids;i++){
      const name = (document.getElementById(`child_name_${i}`)?.value || "").trim();
      const d = document.getElementById(`child_day_${i}`)?.value || "";
      const m = document.getElementById(`child_month_${i}`)?.value || "";

      if((d && !m) || (!d && m)){
        alert(`Ã‡ocuk ${i} iÃ§in GÃ¼n/Ay ikilisini ya tam seÃ§, ya boÅŸ bÄ±rak.`);
        return;
      }
      if(d && m && !isValidDM(d,m)){
        alert(`Ã‡ocuk ${i} iÃ§in geÃ§ersiz tarih seÃ§tin.`);
        return;
      }

      const dm = (d && m) ? `${d}.${m}` : "";
      if(name || dm) kids.push({ name, bday_dm: dm });
    }

    // regl alanlarÄ± (kadÄ±nsa ve enabled true ise)
    const gender = document.getElementById('formGender')?.value || "";
    const periodEnabled = (document.getElementById('periodEnabled')?.value === "true");
    const lastPeriodStart = document.getElementById('lastPeriodStart')?.value || "";
    const cycleLen = parseInt(document.getElementById('cycleLength')?.value,10) || 28;
    const periodLen = parseInt(document.getElementById('periodLength')?.value,10) || 5;

    if(gender === "KadÄ±n" && periodEnabled && !lastPeriodStart){
      alert("Regl takibi aÃ§Ä±ksa 'Son adet baÅŸlangÄ±Ã§ tarihi' girmen lazÄ±m (ya da takibi kapat).");
      return;
    }

    const meta = {
      hitap: document.getElementById('formHitap')?.value || "",
      bot_name: document.getElementById('formBotName')?.value || "",
      gender,
      marital_status: document.getElementById('formStatus')?.value || "",
      region: document.getElementById('formCity')?.value || "",
      birth_city: document.getElementById('formBirthCity')?.value || "",
      team: document.getElementById('formTeam')?.value || "",
            birth_date: bd.value,

      // evli
      spouse_name: document.getElementById('formSpouse')?.value || "",
      spouse_bday_dm: spouseB.value,
      wedding_dm: wed.value,
      engagement_dm: eng.value,
      met_dm: met.value,

      // Ã§ocuklar
      child_count: String(childCount),
      children: kids,

      // regl
      period_tracking_enabled: (gender === "KadÄ±n") ? periodEnabled : false,
      last_period_start: (gender === "KadÄ±n" && periodEnabled) ? lastPeriodStart : "",
      cycle_length_days: (gender === "KadÄ±n" && periodEnabled) ? cycleLen : "",
      period_length_days: (gender === "KadÄ±n" && periodEnabled) ? periodLen : "",

      // asistan
      reminder_opt_in: true
    };

    // âœ… Profil tam doluysa samimiyet +5 (tek sefer)
    function isFullProfile(meta){
      const baseOk =
        !!String(meta.hitap||"").trim() &&
        !!String(meta.bot_name||"").trim() &&
        !!String(meta.gender||"").trim() &&
        !!String(meta.birth_date||"").trim() &&
        !!String(meta.region||"").trim() &&
        !!String(meta.birth_city||"").trim();

      if(!baseOk) return false;

      // Evliyse: eÅŸ adÄ± + en az bir Ã¶zel gÃ¼n
      if(String(meta.marital_status||"") === "Evli"){
        const spouseOk = !!String(meta.spouse_name||"").trim();
        const anyDay = !!(meta.spouse_bday_dm || meta.wedding_dm || meta.engagement_dm || meta.met_dm);
        if(!spouseOk || !anyDay) return false;
      }

      // Ã‡ocuk varsa: en az bir Ã§ocuk bilgisi
      const cc = parseInt(meta.child_count || "0", 10) || 0;
      if(cc > 0){
        const kids = Array.isArray(meta.children) ? meta.children : [];
        const hasKidData = kids.some(k => (k?.name && String(k.name).trim()) || (k?.bday_dm && String(k.bday_dm).trim()));
        if(!hasKidData) return false;
      }

      // Regl aÃ§Ä±k ise tarih ÅŸart
      if(meta.period_tracking_enabled){
        if(!String(meta.last_period_start||"").trim()) return false;
        if(!String(meta.cycle_length_days||"").trim()) return false;
        if(!String(meta.period_length_days||"").trim()) return false;
      }

      return true;
    }

    try{
      const eligible = isFullProfile(meta);
      const bonusState = JSON.parse(localStorage.getItem(PROFILE_BONUS_KEY) || "{}");
      const userKey = (user.user_id || user.email || user.id || "").toLowerCase();

      if(eligible && userKey && !bonusState[userKey]){
        const u = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
        const cur = Number(u?.yp_percent ?? 10);
        const next = Math.max(5, Math.min(100, cur + 5));
        u.yp_percent = next;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(u));

        bonusState[userKey] = { awarded_at: new Date().toISOString(), added: 5 };
        localStorage.setItem(PROFILE_BONUS_KEY, JSON.stringify(bonusState));
      }
    }catch(e){}

    // âœ… local: google'dan baÄŸÄ±msÄ±z profil kaydÄ±
    try{
      localStorage.setItem(PROFILE_KEY, JSON.stringify(meta));
    }catch(e){
      alert("Local kaydetme baÅŸarÄ±sÄ±z (storage).");
      return;
    }

    // âœ… login objesine karÄ±ÅŸtÄ±rma: sadece iÅŸaret koy
    try{
      const u = ensureIdentity(user);
      u.profile_saved = true;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(u));
    }catch(e){}

    // âœ… server'a yaz: user_id saÄŸlam gÃ¶nder (email/id karÄ±ÅŸmasÄ±n)
    try{
      if(BASE_DOMAIN){
        const stableUserId = user.user_id || user.email || user.id;
        await fetch(`${BASE_DOMAIN}/api/profile/update`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ user_id: stableUserId, email: user.email || "", meta })
        });
      }
    }catch(e){
      console.log("Profil server kaydÄ± baÅŸarÄ±sÄ±z (local OK):", e);
    }

    alert("Kaydettim evladÄ±m. TamamdÄ±r. ğŸ§¿");
    window.location.href = "../index.html";
  };

