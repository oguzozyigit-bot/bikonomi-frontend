<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Diyet PlanÄ±m</title>
  <link rel="icon" href="data:," />
  <!-- Sohbet sayfasÄ±yla aynÄ± css -->
  <link rel="stylesheet" href="/css/style.css?v=1" />

  <style>
    :root{
      --gold:#ffb300;
      --pistachio:#bef264;
      --red:#ff5252;
      --glass: rgba(255,255,255,.10);
      --card: rgba(25,25,25,.55);
    }

    /* âœ… MenÃ¼ overlay kapalÄ±yken tÄ±klamalarÄ± engellemesin (cinsiyet seÃ§ilemiyor fix) */
    .menu-overlay { display:none; pointer-events:none; }
    .menu-overlay.open { display:flex; pointer-events:auto; }

    /* Sayfa iÃ§i alan */
    .diet-wrap{
      padding: 16px;
      padding-bottom: 100px;
      display:flex;
      flex-direction:column;
      gap:16px;
      overflow-y:auto;
      height:100%;
    }

    /* Kartlar */
    .card{
      background: linear-gradient(145deg, rgba(30,30,30,0.9), rgba(10,10,10,0.95));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 18px;
      box-shadow: 0 18px 45px rgba(0,0,0,.55);
    }

    /* Profil formu */
    #profileSetup{ display:none; }
    .setup-head{
      display:flex; align-items:center; gap:12px; margin-bottom:10px;
    }
    .setup-ico{
      width:44px; height:44px; border-radius:16px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,179,0,.14);
      border:1px solid rgba(255,179,0,.30);
      font-size:22px;
    }
    .setup-title{
      font-weight:900; letter-spacing:.2px; color:#fff; margin:0;
      font-size:16px;
    }
    .setup-desc{
      margin:8px 0 14px;
      color: rgba(255,255,255,.70);
      font-size: 13px;
      line-height: 1.35;
    }

    .form-row{ display:flex; gap:10px; }
    .form-group{ flex:1; display:flex; flex-direction:column; gap:6px; }
    .form-label{
      font-size: 11px; font-weight: 900;
      color: var(--gold);
      text-transform: uppercase;
      letter-spacing: .6px;
      margin-left: 4px;
    }
    .diet-input, .diet-select{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      color: #fff;
      padding: 12px;
      border-radius: 14px;
      font-size: 14px;
      outline: none;
      width:100%;
    }
    .diet-input:focus, .diet-select:focus{ border-color: rgba(255,179,0,.75); }

    .diet-input:disabled, .diet-select:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    .btn-primary{
      width:100%;
      border:none;
      border-radius: 18px;
      padding: 14px 16px;
      font-weight: 900;
      font-size: 14px;
      cursor:pointer;
      background: var(--gold);
      color:#111;
      box-shadow: 0 12px 26px rgba(255,179,0,.18);
    }
    .btn-primary:active{ transform: scale(.99); }

    .btn-yes{
      width:100%;
      border:none;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 900;
      font-size: 14px;
      cursor:pointer;
      background: var(--pistachio);
      color:#111;
      box-shadow: 0 0 18px rgba(190,242,100,.28);
    }

    /* Dashboard */
    #dietDashboard{ display:none; }
    .bmi-hero{
      display:flex; justify-content:space-between; align-items:center;
      gap:16px;
    }
    .bmi-left h2{
      margin:0 0 6px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .7px;
      color: rgba(255,255,255,.55);
      font-weight: 900;
    }
    .bmi-big{ font-size: 38px; font-weight: 1000; color:#fff; line-height:1; }
    .bmi-status{
      display:inline-block;
      margin-top:8px;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 1000;
      letter-spacing: .7px;
      text-transform: uppercase;
    }
    .bmi-status.ok{ background: rgba(190,242,100,.14); color: var(--pistachio); }
    .bmi-status.warn{ background: rgba(255,179,0,.14); color: var(--gold); }
    .bmi-status.bad{ background: rgba(255,82,82,.14); color: var(--red); }

    .bmi-gauge{ width:70px; height:70px; }
    .bg-circle{ fill:none; stroke:#333; stroke-width:6; }
    .val-circle{
      fill:none; stroke: var(--gold);
      stroke-width:6; stroke-linecap:round;
      stroke-dasharray:175; stroke-dashoffset:175;
      transition: 1s ease;
    }

    .bmi-talk{
      margin-top: 12px;
      color: rgba(255,255,255,.88);
      font-size: 13px;
      line-height: 1.45;
      font-weight: 650;
    }
    .bmi-talk b{ color: #fff; }

    /* MenÃ¼ listesi */
    .meal-list{ display:flex; flex-direction:column; gap:12px; margin-top:10px; }
    .meal-card{
      background: rgba(25,25,25,.55);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .meal-icon{
      width:44px; height:44px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
      font-size: 20px;
      flex-shrink:0;
    }
    .meal-name{
      font-size:12px; font-weight: 1000;
      color: var(--gold);
      text-transform: uppercase;
      letter-spacing: .6px;
      margin-bottom: 4px;
    }
    .meal-desc{
      font-size:13px;
      color: rgba(255,255,255,.92);
      line-height: 1.35;
      font-weight: 650;
    }
    .meal-meta{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(255,255,255,.55);
      font-weight: 800;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .meal-meta span{ display:inline-flex; gap:6px; align-items:center; }
    .meal-meta .cal::before{ content:"ğŸ”¥"; font-size: 10px; }
    .meal-meta .time::before{ content:"ğŸ•’"; font-size: 10px; }

    /* Toast */
    .diet-notif{
      position: fixed;
      top: 80px; left: 50%;
      transform: translateX(-50%);
      background: rgba(190,242,100,0.95);
      color:#111;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 1000;
      box-shadow: 0 10px 30px rgba(0,0,0,.55);
      z-index: 9001;
      display:none;
      animation: slideDown .45s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes slideDown { from{ top:-50px; opacity:0 } to{ top:80px; opacity:1 } }
  </style>
</head>

<body>

<div class="mobile-frame" id="mobileFrame">

  <!-- âœ… SOHBET SAYFASI Ä°LE AYNI TOPBAR -->
  <div class="topbar">
    <div class="left-controls">
      <button class="hamb-btn" id="hambBtn">â˜°</button>
    </div>

    <div class="brand-wrapper" id="brandWrapper">
      <div class="logo-area">
        <svg class="seesaw-svg" viewBox="0 0 40 20">
          <g class="seesaw-bar" id="seesawBar">
            <line x1="0" y1="8" x2="40" y2="8" stroke="#ccc" stroke-width="2" stroke-linecap="round" />
            <circle cx="3" cy="5" r="3" fill="#bef264" />
            <circle cx="37" cy="5" r="3" fill="#ffb300" id="orangeBall" />
          </g>
          <polygon points="17,14 23,14 20,8" fill="none" stroke="#666" stroke-width="1.5" />
        </svg>
        <div class="brand-name">Caynana AI</div>
      </div>
      <div class="slogan">Yapay ZekÃ¢nÄ±n Geleneksel AklÄ±</div>
    </div>

    <div class="right-controls">
      <div class="notif-row">
        <div class="notif-topline">
          <button class="icon-btn-top" id="notifBtn" aria-label="Bildirimler">
            <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
            <div class="badge" id="notifBadge"></div>
          </button>
          <div id="planChip" class="plan-chip">FREE</div>
        </div>

        <div class="notification-dropdown" id="notifDropdown">
          <div class="notif-header">Bildirimler</div>
          <div class="notif-list" id="notifList"></div>
        </div>

        <div class="yp-chip">
          <div class="yp-label">SAMÄ°MÄ°YET</div>
          <div class="yp-meter"><div class="yp-fill" id="ypFill"></div></div>
          <div class="yp-num" id="ypNum">19%</div>
        </div>

        <button class="icon-btn-top" id="profileBtn" aria-label="Profil">
          <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- âœ… SOHBET SAYFASI Ä°LE AYNI HAMBURGER MENÃœ -->
  <div class="menu-overlay" id="menuOverlay">
    <div class="menu-sidebar">
      <button class="new-chat-btn" id="newChatBtn"><span>+</span> YENÄ° SOHBET BAÅLAT</button>

      <div class="profile-shortcut-wrap" id="profileShortcutMount">
        <div class="profile-shortcut-btn" id="profileShortcutBtn">
          <div class="profile-shortcut-ico" id="profileShortcutIco">ğŸ‘¤</div>
          <div class="profile-shortcut-text">
            <div class="profile-shortcut-title">Profil DÃ¼zenle</div>
            <div class="profile-shortcut-sub" id="profileShortcutName">â€”</div>
          </div>
        </div>
      </div>

      <div class="section-title" id="historyTitle">GEÃ‡MÄ°Å SOHBETLER</div>
      <div class="history-list" id="historyList"></div>

      <div class="menu-block asistan">
        <div class="block-head">Asistan</div>
        <div class="menu-grid" id="menuAsistan"></div>
      </div>

      <div class="menu-block astro">
        <div class="block-head">Astro AI</div>
        <div class="menu-grid" id="menuAstro"></div>
      </div>

      <div class="menu-block kurumsal">
        <div class="block-head">Kurumsal</div>
        <div class="menu-grid" id="menuKurumsal"></div>
      </div>

      <div class="menu-footer-actions">
        <a class="action-link" id="logoutBtn">ğŸ›¡ï¸ GÃ¼venli Ã‡Ä±kÄ±ÅŸ</a>
        <a class="action-link delete-acc" id="deleteAccountBtn">ğŸ—‘ï¸ HesabÄ±mÄ± Sil</a>
        <div class="footer-copy">@CaynanaAI By Ozyigit's 2026</div>
      </div>
    </div>
  </div>

  <!-- âœ… DÄ°YET SAYFASI Ä°Ã‡ERÄ°K -->
  <div class="diet-wrap">

    <!-- Profil tamam deÄŸilse -->
    <div id="profileSetup" class="card">
      <div class="setup-head">
        <div class="setup-ico">ğŸ“</div>
        <div>
          <div class="setup-title">Diyet iÃ§in birkaÃ§ bilgi</div>
          <div style="font-size:12px; color: rgba(255,255,255,.55); font-weight:800; margin-top:2px;">
            DoÄŸum tarihi & cinsiyet bir kere alÄ±nÄ±r, sonra deÄŸiÅŸmez.
          </div>
        </div>
      </div>

      <div class="setup-desc">
        Boy ve kiloyu gÃ¼ncel tut evladÄ±m. Profilinde doÄŸum tarihi ve cinsiyet varsa burada dokunamayÄ±z.
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Boy (cm)</label>
          <input type="number" id="inpHeight" class="diet-input" placeholder="170" inputmode="numeric" />
        </div>
        <div class="form-group">
          <label class="form-label">Kilo (kg)</label>
          <input type="number" id="inpWeight" class="diet-input" placeholder="70" inputmode="numeric" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">DoÄŸum Tarihi</label>
          <input type="date" id="inpDob" class="diet-input" />
        </div>
        <div class="form-group">
          <label class="form-label">Cinsiyet</label>
          <select id="inpGender" class="diet-select">
            <option value="">SeÃ§</option>
            <option value="Kadin">KadÄ±n</option>
            <option value="Erkek">Erkek</option>
          </select>
        </div>
      </div>

      <button class="btn-primary" id="btnCalc">VÃœCUT ENDEKSÄ°MÄ° HESAPLA</button>
    </div>

    <!-- Dashboard -->
    <div id="dietDashboard" class="card">
      <div class="bmi-hero">
        <div class="bmi-left">
          <h2>VÃ¼cut Kitle Ä°ndeksi</h2>
          <div class="bmi-big" id="bmiVal">--</div>
          <div class="bmi-status" id="bmiStatus">â€”</div>
        </div>
        <div class="bmi-gauge">
          <svg width="70" height="70" style="transform:rotate(-90deg)">
            <circle class="bg-circle" cx="35" cy="35" r="30"></circle>
            <circle class="val-circle" cx="35" cy="35" r="30" id="bmiCircle"></circle>
          </svg>
        </div>
      </div>

      <div class="bmi-talk" id="bmiTalk">â€”</div>

      <div style="height:10px"></div>

      <button class="btn-yes" id="btnGenerate">GÃœNLÃœK DÄ°YET MENÃœMÃœ VER</button>

      <div class="meal-list" id="mealList"></div>
    </div>

  </div>

  <div class="diet-notif" id="dietNotif">ğŸ”” BugÃ¼n diyet menÃ¼n geldi, incele evladÄ±m!</div>

  <!-- âœ… SOHBET SAYFASI Ä°LE AYNI FOOTER -->
  <div class="footer-container">
    <div class="footer-links">
      <a href="/pages/hakkimizda.html">HakkÄ±mÄ±zda</a>
      <a href="/pages/sss.html">SSS</a>
      <a href="/pages/gizlilik.html">Gizlilik</a>
      <a href="/pages/iletisim.html">Ä°letiÅŸim</a>
    </div>
    <div class="footer-brand">@CaynanaAI By Ozyigits 2026</div>
  </div>

</div>

<script type="module">
  import { BASE_DOMAIN, STORAGE_KEY } from "/js/config.js";

  const DIET_API = "/api/diet/today";
  const PROFILE_API = "/api/profile/me";

  function $(id){ return document.getElementById(id); }
  function safeJson(s){ try{return JSON.parse(s||"{}");}catch{return {};} }
  function todayStr(){ return new Date().toISOString().split("T")[0]; }

  // STORAGE_KEY yoksa sohbetin kullandÄ±ÄŸÄ± key ile de dene
  function getUserLocal(){
    const a = safeJson(localStorage.getItem(STORAGE_KEY));
    if (a && Object.keys(a).length) return a;
    return safeJson(localStorage.getItem("caynana_user_v1"));
  }
  function setUserLocal(obj){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    localStorage.setItem("caynana_user_v1", JSON.stringify(obj));
  }

  async function fetchProfile(userId){
    try{
      const res = await fetch(`${BASE_DOMAIN}${PROFILE_API}?user_id=${encodeURIComponent(userId)}`, {
        method:"GET",
        headers:{ "Accept":"application/json" }
      });
      if(!res.ok) return null;
      const data = await res.json();
      return data?.ok ? (data.profile || null) : null;
    }catch{ return null; }
  }

  async function saveProfileToBackend(userId, profile){
    try{
      const res = await fetch(`${BASE_DOMAIN}${PROFILE_API}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ user_id:userId, ...profile })
      });
      const data = await res.json().catch(()=>({}));
      return !!data?.ok;
    }catch{ return false; }
  }

  function show(elId){
    $("profileSetup").style.display = "none";
    $("dietDashboard").style.display = "none";
    $(elId).style.display = "block";
  }

  function fillForm(p){
    if(p?.height_cm) $("inpHeight").value = p.height_cm;
    if(p?.weight_kg) $("inpWeight").value = p.weight_kg;
    if(p?.birth_date) $("inpDob").value = p.birth_date;
    if(p?.gender) $("inpGender").value = p.gender;
  }

  function lockFieldsIfExists(p){
    // boy/kilo her zaman aÃ§Ä±k
    $("inpHeight").disabled = false;
    $("inpWeight").disabled = false;

    // doÄŸum tarihi & cinsiyet profil varsa kilit
    const hasDob = !!p?.birth_date;
    const hasGender = !!p?.gender;

    $("inpDob").disabled = hasDob;
    $("inpGender").disabled = hasGender;
  }

  function bmiLabelAndTalk(bmi){
    const v = Number(bmi);
    if(v >= 30) return { cls:"bad", label:"OBEZ", talk:"<b>Obezsin evladÄ±m.</b> Bak ben sana bir diyet tavsiyesinde bulunayÄ±m; her gÃ¼n buna uy. Her gÃ¼n sana gÃ¼nlÃ¼k ne yemen lazÄ±m onu vereceÄŸim." };
    if(v >= 25) return { cls:"warn", label:"KÄ°LOLU", talk:"<b>Kilolusun evladÄ±m.</b> DÃ¼zenli gidersen toparlarÄ±z. Her gÃ¼n sana gÃ¼nlÃ¼k ne yemen lazÄ±m onu vereceÄŸim." };
    if(v < 18.5) return { cls:"warn", label:"ZAYIF", talk:"<b>ZayÄ±fsÄ±n evladÄ±m.</b> SaÄŸlÄ±klÄ± toparlayalÄ±m. Her gÃ¼n sana gÃ¼nlÃ¼k ne yemen lazÄ±m onu vereceÄŸim." };
    return { cls:"ok", label:"NORMAL", talk:"<b>Normalsin evladÄ±m.</b> Formu koruyalÄ±m. Her gÃ¼n sana gÃ¼nlÃ¼k ne yemen lazÄ±m onu vereceÄŸim." };
  }

  function calculateAndShowBMI(u){
    const h = Number(u.height_cm)/100;
    const w = Number(u.weight_kg);
    const bmi = (w/(h*h)).toFixed(1);

    $("bmiVal").textContent = bmi;

    const meta = bmiLabelAndTalk(bmi);
    const st = $("bmiStatus");
    st.className = `bmi-status ${meta.cls}`;
    st.textContent = meta.label;

    $("bmiTalk").innerHTML = meta.talk;

    const circle = $("bmiCircle");
    const maxVal = 40;
    const dash = 175;
    const offset = dash - ((Math.min(Number(bmi), maxVal)/maxVal)*dash);
    setTimeout(()=>{
      circle.style.strokeDashoffset = offset;
      circle.style.stroke = (meta.cls==="bad") ? "var(--red)" : (meta.cls==="warn" ? "var(--gold)" : "var(--pistachio)");
    }, 50);

    return bmi;
  }

  function currentMealStartIndex(){
    const h = new Date().getHours();
    if(h >= 6 && h < 10) return 0;   // kahvaltÄ±
    if(h >= 10 && h < 12) return 1;  // ara
    if(h >= 12 && h < 16) return 2;  // Ã¶ÄŸle
    if(h >= 16 && h < 18) return 3;  // ara (ikindi)
    if(h >= 18 && h < 22) return 4;  // akÅŸam
    return 5;                         // su
  }

  function renderMeals(plan){
    const list = $("mealList");
    list.innerHTML = "";

    // Ã–nerilen yeni format destek: plan.meals = [{key,title,icon,time,items,calories}]
    const meals = Array.isArray(plan?.meals) ? plan.meals : null;

    if(meals){
      const startKeyOrder = ["kahvalti","ara","ogle","ara2","aksam","su"];
      const start = currentMealStartIndex();

      // key normalize: ara2 yoksa ara gibi davranabilir
      const normalized = meals.map(m => ({
        ...m,
        key: (m.key==="ara_ogun" ? "ara" : m.key)
      }));

      // sÄ±rayÄ± saatine gÃ¶re istemiyorsan (ÅŸimdilik) indexe gÃ¶re slice
      // ama meals zaten backendâ€™den sÄ±rayla gelirse bu yeter:
      const sliced = normalized.slice(start);

      sliced.forEach(m=>{
        const html = `
          <div class="meal-card">
            <div class="meal-icon">${m.icon || "ğŸ½ï¸"}</div>
            <div style="flex:1">
              <div class="meal-name">${m.title || "-"}</div>
              <div class="meal-desc">${m.items || "â€”"}</div>
              <div class="meal-meta">
                ${m.time ? `<span class="time">${m.time}</span>` : ``}
                ${(m.calories!==undefined && m.calories!==null) ? `<span class="cal">${m.calories} kcal</span>` : ``}
              </div>
            </div>
          </div>
        `;
        list.insertAdjacentHTML("beforeend", html);
      });
      return;
    }

    // Eski format fallback (senin mevcut API)
    const start = currentMealStartIndex();
    const items = [
      { k:"kahvalti", t:"KahvaltÄ±", i:"ğŸ³", cal:"350-400 kcal", time:"08:30" },
      { k:"ara", t:"Ara Ã–ÄŸÃ¼n", i:"ğŸ", cal:"100-150 kcal", time:"11:00" },
      { k:"ogle", t:"Ã–ÄŸle YemeÄŸi", i:"ğŸ¥—", cal:"450-500 kcal", time:"13:30" },
      { k:"ara", t:"Ara Ã–ÄŸÃ¼n", i:"ğŸ", cal:"100-150 kcal", time:"16:30" },
      { k:"aksam", t:"AkÅŸam YemeÄŸi", i:"ğŸŒ™", cal:"300-350 kcal", time:"19:30" },
      { k:"su", t:"Su", i:"ğŸ’§", cal:"0 kcal", time:"GÃ¼n boyu" }
    ];

    items.slice(start).forEach(item=>{
      let val = plan[item.k] || plan[item.k + "_ogun"] || "â€”";
      if(val === "â€”" && item.k === "ara") val = plan["ara_ogun"] || "â€”";

      const html = `
        <div class="meal-card">
          <div class="meal-icon">${item.i}</div>
          <div style="flex:1">
            <div class="meal-name">${item.t}</div>
            <div class="meal-desc">${val}</div>
            <div class="meal-meta">
              <span class="time">${item.time}</span>
              <span class="cal">${item.cal}</span>
            </div>
          </div>
        </div>
      `;
      list.insertAdjacentHTML("beforeend", html);
    });
  }

  function showNotif(){
    const n = $("dietNotif");
    n.style.display = "block";
    setTimeout(()=> n.style.display="none", 5000);
  }

  function scheduleDailyRefresh(){
    const now = new Date();
    const target = new Date();
    target.setHours(6,0,0,0);
    if(now > target) target.setDate(target.getDate()+1);

    const ms = target - now;
    setTimeout(()=>{
      localStorage.removeItem("caynana_last_diet");
      location.reload();
    }, ms);
  }

  async function init(){
    const userLocal = getUserLocal();
    const userId = userLocal.id || userLocal.user_id || "guest";

    // Profil backendâ€™den varsa Ã§ek
    const pDb = await fetchProfile(userId);
    const merged = { ...userLocal, ...(pDb || {}) };
    setUserLocal(merged);

    // Formu doldur + kilitle
    fillForm(merged);
    lockFieldsIfExists(merged);

    const isComplete = merged.height_cm && merged.weight_kg && merged.birth_date && merged.gender;

    if(!isComplete){
      show("profileSetup");
      scheduleDailyRefresh();
      return;
    }

    // Dashboard
    show("dietDashboard");
    calculateAndShowBMI(merged);

    // BugÃ¼nÃ¼n diyeti varsa gÃ¶ster
    const today = todayStr();
    const lastDiet = safeJson(localStorage.getItem("caynana_last_diet"));
    if(lastDiet && lastDiet.ok && lastDiet.date === today){
      renderMeals(lastDiet.plan);
    }

    scheduleDailyRefresh();
  }

  // âœ… VÃ¼cut endeksimi hesapla (profil kaydet + dob/gender sadece yoksa kaydet)
  $("btnCalc").onclick = async () => {
    const h = $("inpHeight").value;
    const w = $("inpWeight").value;

    if(!h || !w) return alert("Boy ve kiloyu gir evladÄ±m.");

    const userLocal = getUserLocal();
    const userId = userLocal.id || userLocal.user_id || "guest";

    const profile = { ...userLocal };

    profile.height_cm = Number(h);
    profile.weight_kg = Number(w);

    // doÄŸum tarihi / cinsiyet profil yoksa buradan al
    if(!profile.birth_date){
      const d = $("inpDob").value;
      if(!d) return alert("DoÄŸum tarihini de seÃ§ evladÄ±m.");
      profile.birth_date = d;
    }
    if(!profile.gender){
      const g = $("inpGender").value;
      if(!g) return alert("Cinsiyet seÃ§ evladÄ±m.");
      profile.gender = g;
    }

    // local + backend
    setUserLocal(profile);
    await saveProfileToBackend(userId, {
      height_cm: profile.height_cm,
      weight_kg: profile.weight_kg,
      birth_date: profile.birth_date,
      gender: profile.gender
    });

    // dashboardâ€™a geÃ§
    show("dietDashboard");
    calculateAndShowBMI(profile);
    showNotif();
  };

  // âœ… GÃ¼nlÃ¼k menÃ¼yÃ¼ getir (o anki Ã¶ÄŸÃ¼nden baÅŸlayarak render)
  $("btnGenerate").onclick = async () => {
    const btn = $("btnGenerate");
    btn.disabled = true;
    const oldText = btn.textContent;
    btn.textContent = "HazÄ±rlanÄ±yor...";

    const userLocal = getUserLocal();
    const userId = userLocal.id || userLocal.user_id || "guest";
    const today = todayStr();

    const recentMenuIds = safeJson(localStorage.getItem("caynana_recent_menu_ids"));
    const recentIdsArr = Array.isArray(recentMenuIds?.ids) ? recentMenuIds.ids : [];

    const start = currentMealStartIndex(); // backend isterse kullanÄ±r

    try{
      const base = (BASE_DOMAIN || "").replace(/\/+$/, "");

const res = await fetch(`${base}${DIET_API}`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    user_id: userId,
    date: today,
    start_from_index: start,
    avoid_menu_ids: recentIdsArr.slice(-10)
  })
});

      const data = await res.json();

      if(data.ok){
        data.date = today;
        localStorage.setItem("caynana_last_diet", JSON.stringify(data));

        if(data.menu_id){
          const next = [...recentIdsArr, data.menu_id].slice(-20);
          localStorage.setItem("caynana_recent_menu_ids", JSON.stringify({ ids: next }));
        }

        renderMeals(data.plan);
        showNotif();
      }else{
        alert("MenÃ¼ Ã§Ä±kmadÄ± evladÄ±m: " + (data.message || "Bilinmiyor"));
      }
    }catch{
      alert("BaÄŸlantÄ± hatasÄ± evladÄ±m.");
    }finally{
      btn.disabled = false;
      btn.textContent = oldText;
    }
  };

  init();
</script>

<script>
  // MenÃ¼ AÃ§/Kapa (yedek)
  document.addEventListener("DOMContentLoaded", () => {
    const hamb = document.getElementById("hambBtn");
    const overlay = document.getElementById("menuOverlay");

    if(hamb && overlay){
      hamb.addEventListener("click", () => overlay.classList.add("open"));
      overlay.addEventListener("click", (e) => { if(e.target === overlay) overlay.classList.remove("open"); });
    }

    // Profil shortcut avatar/name
    try {
      const u = JSON.parse(localStorage.getItem("caynana_user_v1") || "{}");
      const pic = u.picture || u.avatar || u.avatar_url;
      const name = u.fullname || u.name || "â€”";

      const ico = document.getElementById("profileShortcutIco");
      if(ico && pic) ico.innerHTML = `<img src="${pic}" alt="avatar">`;

      const nm = document.getElementById("profileShortcutName");
      if(nm) nm.textContent = name;
    } catch(e) {}
  });
</script>

</body>
</html>
