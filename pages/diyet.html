<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Diyet Planƒ±m</title>
  <link rel="stylesheet" href="/css/style.css?v=2">
  <style>
    /* =========================================
       PREMIUM DIYET CSS (Aynƒ± Tasarƒ±m)
       ========================================= */
    :root {
      --bg-dark: #050505;
      --card-bg: rgba(20, 20, 20, 0.6);
      --glass-border: rgba(255, 255, 255, 0.08);
      --accent: #ffb300; /* Turuncu */
      --success: #bef264; /* Fƒ±stƒ±k */
      --danger: #ff5252;
    }

    body { background: #000; color: #eee; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .diet-wrap { padding: 16px; padding-bottom: 100px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; height: 100%; }

    /* 1. BLOK: VKƒ∞ G√ñSTERGESƒ∞ (Hero) */
    .bmi-card {
      position: relative;
      background: linear-gradient(145deg, rgba(30,30,30,0.8), rgba(10,10,10,0.9));
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    .bmi-card::before {
      content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(255,179,0,0.08) 0%, transparent 60%);
      pointer-events: none;
    }

    .bmi-circle-wrap {
      position: relative;
      width: 140px; height: 140px;
      margin: 0 auto 15px;
      display: flex; align-items: center; justify-content: center;
    }
    
    .bmi-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
    .bmi-circle-bg { fill: none; stroke: #222; stroke-width: 8; }
    .bmi-circle-val { 
      fill: none; stroke: var(--accent); stroke-width: 8; 
      stroke-dasharray: 340; stroke-dashoffset: 340;
      transition: stroke-dashoffset 1s ease; stroke-linecap: round;
    }

    .bmi-text { position: absolute; display: flex; flex-direction: column; align-items: center; }
    .bmi-value { font-size: 32px; font-weight: 800; color: #fff; line-height: 1; }
    .bmi-label { font-size: 10px; text-transform: uppercase; color: #888; font-weight: 700; margin-top: 4px; }

    .status-badge {
      display: inline-block; padding: 6px 14px; border-radius: 20px;
      font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;
      background: rgba(255,179,0,0.15); color: var(--accent); border: 1px solid rgba(255,179,0,0.3);
    }
    .status-badge.ok { background: rgba(190,242,100,0.15); color: var(--success); border-color: rgba(190,242,100,0.3); }
    .status-badge.warn { background: rgba(255,179,0,0.15); color: var(--accent); border-color: rgba(255,179,0,0.3); }
    .status-badge.bad { background: rgba(255,82,82,0.15); color: var(--danger); border-color: rgba(255,82,82,0.3); }

    /* 2. BLOK: YEMEK KARTLARI */
    .section-head { font-size: 14px; font-weight: 700; color: #666; margin-left: 4px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
    
    .meal-grid { display: grid; gap: 12px; }
    
    .meal-card {
      background: rgba(25,25,25,0.6);
      border: 1px solid var(--glass-border);
      border-radius: 18px;
      padding: 16px;
      display: flex; gap: 14px; align-items: flex-start;
      transition: transform 0.2s;
    }
    .meal-card:active { transform: scale(0.98); background: rgba(30,30,30,0.8); }

    .meal-icon {
      width: 42px; height: 42px; background: rgba(255,255,255,0.05);
      border-radius: 12px; display: flex; align-items: center; justify-content: center;
      font-size: 20px; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.05);
    }
    
    .meal-content { flex: 1; }
    .meal-title { font-size: 11px; font-weight: 800; color: #aaa; text-transform: uppercase; margin-bottom: 4px; }
    .meal-desc { font-size: 13px; font-weight: 500; color: #eee; line-height: 1.4; }

    /* 3. BLOK: EKSƒ∞K PROFƒ∞L UYARISI */
    .missing-profile-box {
      text-align: center; padding: 40px 20px;
      background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
      border: 1px solid #333; border-radius: 24px;
      display: none; /* Ba≈ülangƒ±√ßta gizli */
      flex-direction: column; align-items: center; gap: 16px;
    }
    .missing-icon { font-size: 48px; margin-bottom: 10px; animation: bounce 2s infinite; }
    .missing-title { font-size: 18px; font-weight: 800; color: #fff; }
    .missing-desc { font-size: 13px; color: #888; line-height: 1.5; max-width: 280px; margin: 0 auto; }
    
    .btn-update {
      background: var(--accent); color: #000; border: none;
      padding: 14px 24px; border-radius: 16px; font-weight: 800; font-size: 14px;
      cursor: pointer; margin-top: 10px; width: 100%; max-width: 200px;
      box-shadow: 0 10px 20px rgba(255,179,0,0.25);
    }

    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    /* Elementleri G√∂ster/Gizle Mantƒ±ƒüƒ± */
    body.profile-missing .bmi-card, 
    body.profile-missing .meal-section { display: none !important; }
    body.profile-missing .missing-profile-box { display: flex !important; }

    /* Hamburger & Topbar Fix */
    .topbar { position: relative; z-index: 3000; }
    #hambBtn { position: relative; z-index: 3001; pointer-events: auto !important; }
    .menu-overlay { z-index: 9999 !important; }
  </style>
</head>
<body>

<div class="mobile-frame">
  
  <div class="topbar">
    <button class="hamb-btn" id="hambBtn">‚ò∞</button>
    <div class="brand-wrapper">
      <div class="logo-area">
        <svg class="seesaw-svg" viewBox="0 0 40 20"><g class="seesaw-bar"><line x1="0" y1="8" x2="40" y2="8" stroke="#ccc" stroke-width="2"/><circle cx="3" cy="5" r="3" fill="#bef264"/><circle cx="37" cy="5" r="3" fill="#ffb300"/></g><polygon points="17,14 23,14 20,8" fill="#666"/></svg>
        <div class="brand-name">Caynana</div>
      </div>
    </div>
    <div class="right-controls"><div class="plan-chip">DIET</div></div>
  </div>

  <div class="menu-overlay" id="menuOverlay">
    <div class="menu-sidebar">
      <button class="new-chat-btn" onclick="location.href='/'">‚Üê SOHBETE D√ñN</button>
      <div class="menu-block asistan"><div class="block-head">Men√º</div>
        <div class="menu-action" onclick="location.href='/pages/profil.html'"><div class="ico">üë§</div><div>Profil</div></div>
        <div class="menu-action" onclick="location.href='/'"><div class="ico">üí¨</div><div>Sohbet</div></div>
      </div>
    </div>
  </div>

  <div class="diet-wrap" id="dietContent">

    <div class="missing-profile-box">
      <div class="missing-icon">ü•ó</div>
      <div class="missing-title">√ñnce Seni Tanƒ±yalƒ±m!</div>
      <div class="missing-desc">
        Sana √∂zel bir diyet listesi hazƒ±rlamam i√ßin <b>Boy, Kilo, Ya≈ü ve Cinsiyet</b> bilgilerine ihtiyacƒ±m var evladƒ±m.
      </div>
      <button class="btn-update" onclick="location.href='/pages/profil.html'">Profili Tamamla ‚Üí</button>
    </div>

    <div class="bmi-card">
      <div class="bmi-circle-wrap">
        <svg class="bmi-svg">
          <circle class="bmi-circle-bg" cx="70" cy="70" r="60"></circle>
          <circle class="bmi-circle-val" cx="70" cy="70" r="60" id="bmiProgress"></circle>
        </svg>
        <div class="bmi-text">
          <span class="bmi-value" id="bmiVal">--</span>
          <span class="bmi-label">VKƒ∞</span>
        </div>
      </div>
      <div class="status-badge" id="statusBadge">HESAPLANIYOR</div>
    </div>

    <div class="meal-section">
      <div class="section-head">Bug√ºn√ºn Men√ºs√º</div>
      <div class="meal-grid" id="mealList">
        <div class="meal-card" style="opacity:0.5"><div class="meal-content"><div class="meal-title">Y√ºkleniyor...</div></div></div>
      </div>
    </div>

  </div>

  <div class="footer-container">
    <div class="footer-brand">@CaynanaAI 2026</div>
  </div>

</div>

<script type="module">
  import { BASE_DOMAIN, STORAGE_KEY } from "/js/config.js";
  const DIET_ENDPOINT = "/api/diet/today";

  // --- YARDIMCI FONKSIYONLAR ---
  function safeJson(s) { try { return JSON.parse(s || "{}"); } catch { return {}; } }
  function norm(s) { return String(s || "").trim(); }

  // --- ANA MANTIK ---
  async function initDietPage() {
    const user = safeJson(localStorage.getItem(STORAGE_KEY));
    
    // 1. Profil Kontrol√º (‚úÖ Cinsiyet Dahil)
    const hasHeight = !!user.height_cm; // Boy
    const hasWeight = !!user.weight_kg; // Kilo
    const hasDob = !!user.birth_date;   // Doƒüum Tarihi (Ya≈ü i√ßin)
    const hasGender = !!user.gender;    // Cinsiyet

    // Eƒüer eksikse: "profile-missing" modunu a√ß
    if (!hasHeight || !hasWeight || !hasDob || !hasGender) {
      document.body.classList.add("profile-missing");
      return; // Diyet √ßekmeye gerek yok
    }

    // Profil tamsa: Normal akƒ±≈üa devam
    document.body.classList.remove("profile-missing");
    
    // 2. Diyet Verisini √áek
    try {
      const userId = user.id || user.user_id || user.email;
      const res = await fetch(`${BASE_DOMAIN}${DIET_ENDPOINT}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId })
      });
      
      const data = await res.json();
      if(data.ok) renderDiet(data);
      else {
        // API'den "Profil eksik" d√∂nerse de uyarƒ±yƒ± a√ß
        if(data.message && data.message.includes("profil")) {
           document.body.classList.add("profile-missing");
        }
        console.warn("Diyet verisi:", data.message);
      }

    } catch(e) {
      console.error("Diyet hatasƒ±:", e);
      document.getElementById("mealList").innerHTML = `<div style="padding:20px;text-align:center;color:#666;">Baƒülantƒ± hatasƒ± evladƒ±m.</div>`;
    }
  }

  // --- EKRANA BASMA (RENDER) ---
  function renderDiet(data) {
    // VKƒ∞ G√∂stergesi
    const bmi = parseFloat(data.bmi || 0);
    const bmiEl = document.getElementById("bmiVal");
    const badge = document.getElementById("statusBadge");
    const circle = document.getElementById("bmiProgress");

    if(bmiEl) bmiEl.textContent = bmi.toFixed(1);
    if(badge) {
      badge.textContent = data.status || "Bƒ∞Lƒ∞NMƒ∞YOR";
      badge.className = "status-badge";
      if(data.status?.includes("Normal")) badge.classList.add("ok");
      else if(data.status?.includes("Obez")) badge.classList.add("bad");
      else badge.classList.add("warn");
    }

    if(circle) {
      const maxVal = 40; 
      const dashArray = 340; 
      const progress = Math.min(bmi, maxVal) / maxVal;
      const offset = dashArray - (dashArray * progress);
      circle.style.strokeDashoffset = offset;
      
      if(bmi < 18.5 || bmi > 30) circle.style.stroke = "#ff5252"; 
      else if(bmi >= 25) circle.style.stroke = "#ffb300"; 
      else circle.style.stroke = "#bef264"; 
    }

    // Yemek Listesi
    const grid = document.getElementById("mealList");
    if(grid) {
      grid.innerHTML = "";
      const items = [
        { k: "kahvalti", t: "Kahvaltƒ±", i: "üç≥" },
        { k: "ara", t: "Ara √ñƒü√ºn", i: "üçè" }, 
        { k: "ogle", t: "√ñƒüle Yemeƒüi", i: "ü•ó" },
        { k: "aksam", t: "Ak≈üam Yemeƒüi", i: "üåô" },
        { k: "su", t: "Su Takibi", i: "üíß" }
      ];

      const p = data.plan || {};
      items.forEach(item => {
        let val = p[item.k] || p[item.k + "_ogun"] || "‚Äî";
        if(val === "‚Äî" && item.k === "ara") val = p["ara_ogun"] || "‚Äî";

        const html = `
          <div class="meal-card">
            <div class="meal-icon">${item.i}</div>
            <div class="meal-content">
              <div class="meal-title">${item.t}</div>
              <div class="meal-desc">${val}</div>
            </div>
          </div>
        `;
        grid.insertAdjacentHTML("beforeend", html);
      });
    }
  }

  initDietPage();
</script>

<script>
(function(){
  const h = document.getElementById("hambBtn");
  const o = document.getElementById("menuOverlay");
  if(h && o) {
    h.addEventListener("click", ()=> o.classList.add("open"));
    o.addEventListener("click", (e)=> { if(e.target===o) o.classList.remove("open"); });
  }
})();
</script>

</body>
</html>
